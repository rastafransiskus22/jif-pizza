<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JIF PIZZA POS v10.0 ‚Äî Final</title>
<link rel="icon" href="logo.png"/>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="JIF POS">
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="logo.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 

<style>
/* CSS */
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:#222}
.hidden{display:none}
header.hidden, .navbar.hidden { display: none !important; }

/* LATAR BELAKANG GAMBAR HEADER (pizza.jpg) */
header{
  background:url('pizza.jpg') center/cover no-repeat; 
  color:#fff;
  padding:12px;
  text-align:center;
  position: relative; 
  z-index: 1; 
  height: 80px;
  overflow: hidden; 
}
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); 
    z-index: 1; 
} 
header h1, header p {
    position: relative; 
    z-index: 2; 
}
header h1{margin:0;font-size:22px}
header p{margin:4px 0 0 0;font-size:14px}

/* Gaya Tombol 3D */
.navbar button, .btn {
    padding: 10px 16px; 
    border: none;
    border-radius: 8px; 
    cursor: pointer;
    font-weight: 600;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08); 
    background: linear-gradient(145deg, #f0f0f0, #e0e0e0); 
    color: #333;
    text-shadow: 0 1px 0 rgba(255,255,255,0.7); 
}
.navbar button:hover, .btn:hover {
    transform: translateY(-1px); 
    box-shadow: 0 6px 10px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
}
.navbar button:active, .btn:active {
    transform: translateY(1px); 
    box-shadow: 0 2px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.08);
}
/* Gaya spesifik untuk tombol primary (merah) */
.btn.primary, .navbar button.primary-nav { 
    background: linear-gradient(145deg, #e57373, #d32f2f);
    color: #fff;
    text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.secondary, .navbar button.secondary-nav { 
    background: linear-gradient(145deg, #64b5f6, #1976d2);
    color: #fff;
    text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.danger, .navbar button.danger-nav { 
    background: linear-gradient(145deg, #ef5350, #c62828);
    color: #fff;
    text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}

/* GAYA TAB AKTIF (Merah) */
.navbar button.active-tab {
    background: linear-gradient(145deg, #d32f2f, #e57373);
    color: #fff;
    box-shadow: 0 0 5px rgba(217, 73, 73, 0.7); 
    transform: none; 
}


.navbar{background:#fff;display:flex;justify-content:center;gap:8px;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.container{padding:14px}
#loginPage {
    max-width: 400px; 
    margin: 40px auto; 
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.menu-item{border:1px solid #ccc;border-radius:8px;padding:8px;text-align:center;cursor:pointer}
.menu-item {
    background: #fdfdfd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.1s ease-in-out;
}
.menu-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
/* NEW: Gaya Order Item Detail (untuk tombol Hapus) */
.order-item-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px dashed #eee;
}
.order-item-detail .delete-btn {
    padding: 3px 6px;
    font-size: 0.7em;
    margin-left: 10px;
    box-shadow: none;
}
.order-box{margin-top:12px;padding:10px;border-top:2px solid #ccc}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:100;display:none}
.modal{
  background:white;
  padding:20px;
  border-radius:10px;
  text-align:center;
  max-width:320px;
  width:90%;
  display: flex; /* Tambah: Untuk mengatur tombol di modal */
  flex-direction: column; /* Tambah: Agar tombol berderet ke bawah */
  gap: 10px; /* Tambah: Jarak antar elemen di modal */
} 
/* Tambahan untuk tata letak tombol payment di modal */
.modal .payment-method-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 kolom */
    gap: 8px; /* Jarak antar tombol payment */
}
input, select{padding:8px;border:1px solid #ccc;border-radius:6px;width:100%;margin:4px 0}
.report-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.report-table th { background-color: #f2f2f2; }

#homePage img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: block;
    margin: 0 auto 20px auto; 
}

/* Print style untuk 80mm */
@media print {
    body { 
        width: 80mm; 
        margin: 0; 
        padding: 0; 
        font-family: 'Courier New', Courier, monospace !important; 
        font-size: 14px !important;
    }
    pre { 
        width: 80mm !important; 
        max-width: 80mm !important; 
        font-family: 'Courier New', Courier, monospace !important; 
    }
}
</style>
</head>
<body>
<header id="appHeader" class="hidden"> 
  <h1>üçï JIF PIZZA CONDET</h1>
  <p id="userRoleDisplay">Mode Offline</p>
</header>
<div id="appNavbar" class="navbar hidden"> 
  <button id="nav-home" class="secondary-nav" onclick="activateTab('home')">Home</button>
  <button id="nav-kasir" class="secondary-nav" onclick="activateTab('kasir')">Kasir</button>
  <button id="nav-menu" class="secondary-nav" onclick="activateTab('menu')">Menu</button> 
  <button id="nav-laporan" class="secondary-nav" onclick="activateTab('laporan');showReport('today')">Laporan</button>
  <button id="nav-logout" class="secondary-nav" onclick="logout()">Logout</button>
</div>

<div id="loginPage" class="container">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"/>
  <input type="password" id="password" placeholder="Password"/>
  <button class="btn primary" onclick="login()">Login</button>
  <button class="btn secondary" onclick="register()">Daftar (User)</button>
  <p style="font-size: 0.8em; margin-top: 15px; color: #666;">
    *Simulasi Role: Akun baru otomatis menjadi Kasir (User).
    (Akun Manajer sudah terdaftar)
  </p>
</div>

<div id="homePage" class="container hidden">
  <img src="pizza.jpg" alt="JIF Pizza" /> <h2 style="color: #d94949;">Selamat Datang di Jif Pizza!</h2>
  <p style="line-height: 1.6;">
    Ini adalah tempat di mana semangat bertemu dengan peluang. Kami percaya pada potensi setiap individu. Gunakan hari-hari Anda di sini untuk belajar, bertumbuh, dan mengukir prestasi. Jadilah bagian dari resep rahasia kesuksesan kami.
    <br><br>
    Mari mulai memanggang masa depan yang cerah!
  </p>
  <button class="btn primary" onclick="activateTab('kasir')">Mulai Kasir</button>
</div>

<div id="kasirPage" class="container hidden">
  <input type="text" id="customerNote" placeholder="Nama Pelanggan/Driver/Catatan" style="margin-bottom: 10px;"/>
  <div id="orderLabel"></div>
  <div class="navbar" style="margin-top: 10px; box-shadow: none; border: 1px solid #eee;">
    <button class="secondary-nav" onclick="renderMenus('Semua')">Semua</button>
    <button class="secondary-nav" onclick="renderMenus('Large')">Large</button>
    <button class="secondary-nav" onclick="renderMenus('Reguler')">Reguler</button>
    <button class="secondary-nav" onclick="renderMenus('Separuh')">Separuh</button> 
    <button class="secondary-nav" onclick="renderMenus('Extra')">Extra</button>
  </div>
  <div id="menuList" class="menu-grid" style="margin-top: 10px;"></div>
  
  <div class="order-box">
    <h3>Pesanan</h3>
    <div id="orderList"></div>
    <div style="border-top: 1px solid #ccc; padding: 5px 0; margin-top: 10px;">
        <select id="discountSelector" onchange="applyDiscount()" style="width: calc(100% - 20px); margin-bottom: 5px;">
            <option value="">-- Pilih Diskon (Tidak Ada) --</option>
        </select>
        <div id="discountDisplay" style="font-weight: bold; color: #c62828;">Diskon: Rp 0</div>
    </div>
    <h3 id="totalDisplay" style="color: #2e7d32; margin-top: 10px;">TOTAL BAYAR: Rp 0</h3> 
    <button class="btn primary" onclick="openPaymentModal()">Bayar & Cetak</button>
  </div>
</div>
<div id="menuPage" class="container hidden">
  <h3>Tambah Menu (Manajer Only)</h3>
  <input id="mName" placeholder="Nama menu (misal: Mix Lovers)"/>
  
  <select id="mCategory">
    <option value="">-- Pilih Ukuran/Kategori --</option>
    <option value="Large">Large Pizza</option>
    <option value="Reguler">Reguler Pizza</option>
    <option value="Separuh">Separuh Pizza</option> 
    <option value="Extra">Extra Topping</option>
  </select>
  
  <input id="mPriceOffline" type="number" placeholder="Harga Jual OFFLINE (Rp)"/>
  <input id="mOnlineMarkup" type="number" placeholder="Markup Harga ONLINE (Rp)"/>
  
  <button class="btn primary" onclick="addMenu()">Tambah</button>
  <div id="menuEditor"></div>

  <h3 style="margin-top: 30px;">Kelola Diskon (Manajer Only)</h3>
  <input id="dName" placeholder="Nama Diskon (misal: Diskon Merdeka)"/>
  
  <select id="dType">
    <option value="">-- Tipe Diskon --</option>
    <option value="percentage">Persen (%)</option>
    <option value="amount">Nominal (Rp)</option>
  </select>
  
  <input id="dValue" type="number" placeholder="Nilai Diskon (misal: 10 atau 5000)"/>
  
  <button class="btn secondary" onclick="addDiscount()">Tambah Diskon</button>
  <div id="discountEditor" class="menu-editor" style="margin-top: 15px;"></div>
</div>

<div id="laporanPage" class="container hidden">
  <h3>Laporan Penjualan</h3>
  
  <div style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
    <label for="reportDate" style="font-weight: bold;">Pilih Tanggal Spesifik:</label>
    <input type="date" id="reportDate" style="width: 100%; display: block; margin-bottom: 10px;"/>
    <button class="btn primary" onclick="showReport(null, true)">Tampilkan Laporan</button>
    <button class="btn secondary" style="margin-top: 10px;" onclick="printReport()">Cetak Laporan</button> 
  </div>
  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button class="btn secondary" onclick="showReport('today')">Hari Ini</button>
    <button class="btn secondary" onclick="showReport('yesterday')">Kemarin</button>
    <button class="btn secondary" onclick="showReport('month')">Bulan Ini</button>
  </div>
  
  <h4 style="margin-top: 20px;">Grafik Penjualan</h4>
  <div style="width: 100%; max-width: 600px; margin: 0 auto;">
    <canvas id="salesChart"></canvas> 
  </div>
  
  <p style="font-weight: bold; margin-top: 20px;">Ringkasan:</p>
  <div id="laporanSummary"></div> 
  
  <h4 style="margin-top: 20px;">Sales by Menu (Product Mix)</h4>
  <div id="salesByMenu"></div>

  <h4 style="margin-top: 20px;">Detail Transaksi</h4>
  <div id="laporanList"></div>
</div>
<div class="overlay" id="orderTypeOverlay">
  <div class="modal">
    <h3>Pilih Tipe Order</h3>
    <button class="btn primary" onclick="setOrderType('Online')">Order Online</button>
    <button class="btn secondary" onclick="setOrderType('Offline')">Order Offline</button>
  </div>
</div>

<div class="overlay" id="paymentModal">
  <div class="modal">
    <h3 id="modalTotal">Total Akhir: Rp 0</h3>
    <input type="number" id="manualBayar" placeholder="Nominal Bayar Tunai"/>
    <button class="btn primary" onclick="processManualPayment()">Bayar Tunai & Cetak Struk</button>
    
    <h4 style="margin: 10px 0;">Atau Pilih Metode Lain:</h4>
    <div class="payment-method-grid"> 
        <button class="btn secondary" id="pay-cash-pas" onclick="completePayment('Cash', currentFinalTotal)">Bayar Pas (Tunai)</button>
        <button class="btn secondary" id="pay-qris" onclick="openQrisModal()">QRIS (Scan Barcode)</button>
        <button class="btn secondary" id="pay-gojek" onclick="completePayment('Gojek')">Gojek/Gopay</button>
        <button class="btn secondary" id="pay-grab" onclick="completePayment('Grab')">Grab/OVO</button>
        <button class="btn secondary" id="pay-shopee" onclick="completePayment('Shopee')">ShopeePay</button>
    </div>
  </div>
</div>

<div class="overlay" id="qrisModal">
  <div class="modal">
    <h3>Scan QRIS Anda</h3>
    <img src="IMG-20251115-WA0000.jpg" alt="QRIS Payment" style="max-width: 80%; height: auto; margin: 10px auto; display: block;">
    <p>Pastikan pembayaran telah sukses!</p>
    <button class="btn primary" onclick="confirmQrisPayment()">Konfirmasi Pembayaran QRIS</button>
    <button class="btn danger" onclick="$('qrisModal').style.display='none'">Batal</button>
  </div>
</div>
<script>
// ======================================================================
// FUNGSI PWA (SERVICE WORKER & A2HS)
// ======================================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('Service Worker berhasil didaftarkan. Scope:', registration.scope);
      })
      .catch(err => {
        console.log('Gagal mendaftarkan Service Worker:', err);
      });
  });
}
  // ======================================================================
// FUNGSI INTI & UTILITY
// ======================================================================

const STORE_KEY="jif_pos_v10_0"; 
let store=JSON.parse(localStorage.getItem(STORE_KEY)||'{"users":[{"email":"manager@jif.com","password":"123","role":"Manager"}],"menus":[],"transactions":[],"discounts":[]}'); 
let currentUser=JSON.parse(localStorage.getItem('currentUser')) || null; 

let orderType=null;
let cart=[];
let appliedDiscount = null; 
let currentFinalTotal = 0; // Menyimpan total akhir yang akan dibayar
let salesChartInstance = null; // Instance Chart.js

function saveStore(){localStorage.setItem(STORE_KEY,JSON.stringify(store));}
function formatRp(n){return "Rp "+(n||0).toLocaleString("id-ID");}
function $(id){return document.getElementById(id);}
function getDateOnly(dateString) {
    const d = new Date(dateString);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
}
function getWeekNumber(d) {
    d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
    d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
    var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
    var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
    return d.getUTCFullYear() + '-' + weekNo;
}

function calculatePrice(menu) {
    if (orderType === 'Online') {
        return menu.priceOffline + menu.markupOnline;
    }
    return menu.priceOffline;
}
// ======================================================================
// FUNGSI LOGIN / LOGOUT
// ======================================================================
function showLogin(){
  $("appHeader").classList.remove("hidden");
  $("appNavbar").classList.add("hidden");
  ["homePage","kasirPage","menuPage","laporanPage"].forEach(id=>$(id).classList.add("hidden"));
  $("loginPage").classList.remove("hidden");
  
  currentUser = null;
  localStorage.removeItem('currentUser');
}

function login(){
  const email=$("email").value.trim(),pass=$("password").value.trim();
  const u=store.users.find(x=>x.email===email&&x.password===pass);
  if(!u)return alert("Email atau password salah");
  
  currentUser=u;
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  
  if(currentUser.role === 'Manager'){
    $("userRoleDisplay").innerText = `Manajer: ${currentUser.email}`;
  } else {
    $("userRoleDisplay").innerText = `Kasir: ${currentUser.email}`;
  }
  activateTab('home');
}

function register(){
  const email=$("email").value.trim(),pass=$("password").value.trim();
  if(!email||!pass)return alert("Isi email & password");
  if(store.users.find(u=>u.email===email))return alert("Email sudah terdaftar");
  store.users.push({email,password:pass, role:'User'}); 
  saveStore();
  alert("Akun Kasir berhasil dibuat! Silakan Login.");
}

function logout(){
  if(confirm("Yakin logout & cetak closing report?")){
    printClosing(); 
    currentUser=null;
    localStorage.removeItem('currentUser');
    cart=[];
    showLogin();
  }
}
// ======================================================================
// FUNGSI NAVIGASI
// ======================================================================
function setActiveTab(tabName) {
    const navButtons = document.querySelectorAll('#appNavbar button');
    navButtons.forEach(btn => {
        btn.classList.remove('active-tab');
        btn.classList.remove('secondary-nav'); 
        btn.classList.add('secondary-nav'); 
    });

    const targetButton = $(`nav-${tabName}`);
    if (targetButton) {
        targetButton.classList.add('active-tab');
        targetButton.classList.remove('secondary-nav'); 
    }
}

function renderAppStructure(){
  $("appHeader").classList.remove("hidden");
  $("appNavbar").classList.remove("hidden");
  ["loginPage"].forEach(id=>$(id).classList.add("hidden"));
  
  // Logic untuk menyembunyikan/menampilkan tombol Menu
  const menuBtn = $("nav-menu");
  if (menuBtn) {
    if (currentUser && currentUser.role === 'Manager') {
      menuBtn.classList.remove('hidden');
    } else {
      menuBtn.classList.add('hidden');
    }
  }
}

function openOrderType(){$("orderTypeOverlay").style.display="flex";}

function setOrderType(type){
    orderType=type;
    $("orderTypeOverlay").style.display="none";
    $("orderLabel").innerText="Tipe Order: "+type;
    renderMenus('Semua'); 
}

function showKasir(){
  openOrderType();
  renderDiscountSelector(); 
  renderMenus();
  renderOrders();
}

function activateTab(tab){
  renderAppStructure();
  
  ["homePage", "kasirPage","menuPage","laporanPage"].forEach(id=>$(id).classList.add("hidden"));
  
  if(tab==="home"){
    $("homePage").classList.remove("hidden");
  } else if(tab==="kasir"){
    $("kasirPage").classList.remove("hidden");
    showKasir(); 
  } else if(tab==="menu"){
    if(currentUser && currentUser.role === 'Manager'){
      $("menuPage").classList.remove("hidden");
      renderMenuEditor();
      renderDiscountEditor(); 
    } else {
      alert("Akses ditolak. Fitur Tambah Menu hanya untuk Manajer.");
      activateTab('home'); 
      return;
    }
  } else if(tab==="laporan"){
    $("laporanPage").classList.remove("hidden");
    showReport('today'); 
  }
  
  setActiveTab(tab); 
} 
// ======================================================================
// FUNGSI KASIR & TRANSAKSI (Hapus Item & Payment Modal)
// ======================================================================

function renderMenus(filter = 'Semua'){
    const root=$("menuList");root.innerHTML="";
    if(store.menus.length===0){root.innerHTML="<p>Belum ada menu</p>";return;}
    
    let filteredMenus = store.menus.filter(m => filter === 'Semua' || m.category === filter);
    
    const priceType = orderType === 'Online' ? 'Online' : 'Offline';
    
    filteredMenus.forEach(m=>{
        const price = calculatePrice(m);
        if (price > 0) {
            const div=document.createElement("div");div.className="menu-item";
            
            const itemName = `${m.name} (${m.category})`;
            
            div.innerHTML=`
                <div><strong>${itemName}</strong></div>
                <div>${formatRp(price)}</div>
                <div style="font-size: 0.7em; color: #666;">Harga ${priceType}</div>
            `;
            div.onclick=()=>addToCart(m, itemName, price); 
            root.appendChild(div);
        }
    });
}

function addToCart(m, itemName, price){
    const f=cart.find(i=>i.name===itemName);
    if(f)f.qty++;
    else cart.push({
        name: itemName, 
        price: price, 
        qty: 1, 
        category: m.category,
        baseMenuName: m.name 
    }); 
    renderOrders();
}

function deleteFromCart(index) {
    if (confirm(`Yakin ingin menghapus item ${cart[index].name}?`)) {
        cart.splice(index, 1);
        renderOrders();
    }
}

function renderOrders(){
    const root=$("orderList");
    root.innerHTML="";
    
    let subtotal=0;
    
    if(cart.length===0){
        root.innerHTML="<p>Belum ada pesanan</p>";
        $("totalDisplay").innerText="TOTAL BAYAR: Rp 0";
        $("discountDisplay").innerText="Diskon: Rp 0";
        appliedDiscount = null; 
        $("discountSelector").value = ""; 
        currentFinalTotal = 0; 
        return;
    }
    
    cart.forEach((c, index)=>{
        subtotal+=c.price*c.qty;
        const d=document.createElement("div");
        d.className="order-item-detail"; 
        d.innerHTML=`
            <div>
                ${c.name} x${c.qty}
                <br>
                <small>${formatRp(c.price*c.qty)}</small>
            </div>
            <button class='btn danger delete-btn' onclick='deleteFromCart(${index})'>Hapus</button>
        `;
        root.appendChild(d);
    });

    let discountAmount = 0;
    let finalTotal = subtotal;
    let discountDisplay = 'Diskon: Rp 0';

    if (appliedDiscount) {
        if (appliedDiscount.type === 'percentage') {
            discountAmount = subtotal * (appliedDiscount.value / 100);
            discountDisplay = `Diskon (${appliedDiscount.name}): -${formatRp(discountAmount)}`;
        } else if (appliedDiscount.type === 'amount') {
            discountAmount = appliedDiscount.value;
            discountDisplay = `Diskon (${appliedDiscount.name}): -${formatRp(appliedDiscount.value)}`;
        }
        
        finalTotal = subtotal - discountAmount;
        if (finalTotal < 0) finalTotal = 0; 
    }
    
    const subtotalRef = document.createElement("div");
    subtotalRef.innerHTML = `<h4 style="margin: 5px 0; color: #666;">Subtotal: ${formatRp(subtotal)}</h4>`;
    root.appendChild(subtotalRef);
    
    $("discountDisplay").innerText = discountDisplay;
    $("totalDisplay").innerText="TOTAL BAYAR: "+formatRp(finalTotal);
    
    currentFinalTotal = finalTotal; 
}

function openPaymentModal() {
    if (cart.length === 0) return alert("Keranjang masih kosong.");
    
    $("manualBayar").value = '';
    
    $("modalTotal").innerText = `Total Akhir: ${formatRp(currentFinalTotal)}`;
    
    // Logika menyembunyikan tombol berdasarkan orderType
    const isOnline = orderType === 'Online';
    
    // Sembunyikan/Tampilkan metode payment
    $("pay-cash-pas").style.display = isOnline ? 'none' : 'block'; 
    $("pay-qris").style.display = isOnline ? 'none' : 'block'; 
    
    $("pay-gojek").style.display = isOnline ? 'block' : 'none'; 
    $("pay-grab").style.display = isOnline ? 'block' : 'none'; 
    $("pay-shopee").style.display = isOnline ? 'block' : 'none'; 
    
    $("paymentModal").style.display = "flex";
}

function openQrisModal() {
    $("paymentModal").style.display = "none";
    $("qrisModal").style.display = "flex";
}

function confirmQrisPayment() {
    completePayment('QRIS', currentFinalTotal);
}

function processManualPayment() {
    const bayar = Number($("manualBayar").value);
    if (bayar < currentFinalTotal) return alert("Nominal bayar kurang dari total akhir.");
    
    completePayment('Cash', bayar); 
}

function completePayment(method, paidAmount = null) {
    let subtotal = cart.reduce((a,b)=>a+b.price*b.qty,0);
    
    let discountAmount = 0;
    if (appliedDiscount) {
        if (appliedDiscount.type === 'percentage') {
            discountAmount = subtotal * (appliedDiscount.value / 100);
        } else if (appliedDiscount.type === 'amount') {
            discountAmount = appliedDiscount.value;
        }
    }
    const finalTotal = currentFinalTotal; 
    
    let bayar = paidAmount;
    let change = 0;

    if (method === 'Cash' || method === 'QRIS' || method === 'Gojek' || method === 'Grab' || method === 'Shopee') {
        if (bayar === null) {
            bayar = finalTotal;
        }
        
        if (method === 'Cash') {
            change = bayar - finalTotal; 
            if (change < 0) return alert("Nominal bayar (Cash) kurang dari total akhir. Gunakan input manual.");
        } else {
            bayar = finalTotal;
            change = 0;
        }
    }
    
    // TUTUP SEMUA MODAL
    $("paymentModal").style.display="none";
    $("qrisModal").style.display="none";

    if (method === 'Cash' && change > 0) {
        alert("Pembayaran Tunai sukses.\nKembalian: "+formatRp(change));
    } else if (method !== 'Cash') {
        alert("Pembayaran "+method+" sukses!");
    } else {
        alert("Pembayaran Tunai Pas sukses!");
    }
    
    const customerNote = $("customerNote").value.trim() || "Tunai"; 
    
    saveTransaction(subtotal, discountAmount, finalTotal, customerNote, method); 
    printStruk(subtotal, discountAmount, finalTotal, bayar, change, customerNote, method); 
    
    appliedDiscount = null; 
    $("discountSelector").value = ""; 
    cart=[];
    renderOrders();
    $("customerNote").value = ""; 
    openOrderType();
}
function saveTransaction(subtotal, discountAmount, finalTotal, customerNote, paymentMethod){
    store.transactions.push({
        id:Date.now(),
        user:currentUser.email,
        orderType,
        paymentMethod, 
        items:[...cart],
        subtotal: subtotal, 
        discount: appliedDiscount, 
        discountAmount: discountAmount, 
        total: finalTotal, 
        date:new Date().toISOString(),
        note: customerNote 
    });
    saveStore();
}
function printStruk(subtotal, discountAmount, finalTotal, bayar, kembali, note, paymentMethod){
    const now = new Date().toLocaleString("id-ID");
    const MAX_WIDTH = 42; 

    const createStrukLine = (name, qty, price) => {
        const totalStr = formatRp(price * qty).padStart(12);
        const namePart = `${name.substring(0, MAX_WIDTH - 15)} x${qty}`;
        const space = MAX_WIDTH - namePart.length - totalStr.length;
        return `${namePart}${Array(space > 0 ? space : 1).join('.')}${totalStr}`; 
    };
    
    const noteLine = `Pelanggan: ${note.substring(0, MAX_WIDTH - 11)}`; 

    const discountText = appliedDiscount ? 
        `Diskon (${appliedDiscount.name.substring(0, 15)}): -${formatRp(discountAmount).padStart(12)}` : '';
    
    const w=window.open("","_blank");
    w.document.write(`
    <pre>
üçï JIF PIZZA CONDET
Kasir: ${currentUser.email}
Tanggal: ${now}
${'__________________________________________'.substring(0, MAX_WIDTH)}
${cart.map(i => createStrukLine(i.name, i.qty, i.price)).join('\n')}
${'__________________________________________'.substring(0, MAX_WIDTH)}
Subtotal:     ${formatRp(subtotal).padStart(12)}
${discountText ? discountText + '\n' : ''}${`Total Akhir:  ${formatRp(finalTotal).padStart(12)}`}
${(paymentMethod === 'Cash' || paidAmount > finalTotal) ? `Bayar:        ${formatRp(bayar).padStart(12)}\nKembali:      ${formatRp(kembali).padStart(12)}` : ''}
Metode Bayar: ${paymentMethod}
Order: ${orderType}
${noteLine}
${'__________________________________________'.substring(0, MAX_WIDTH)}
Terima kasih!
        </pre>
    `);
    w.print();
}

// ======================================================================
// FUNGSI MANAJEMEN MENU & DISKON
// ======================================================================
function addMenu(){
    const name=$("mName").value.trim();
    const category=$("mCategory").value;
    const priceOffline=Number($("mPriceOffline").value);
    const markupOnline=Number($("mOnlineMarkup").value);

    if(!name || !category || !priceOffline) return alert("Isi Nama Menu, Kategori, dan Harga Offline.");
    
    const uniqueItemName = `${name} (${category})`;

    if(store.menus.find(m => m.uniqueName === uniqueItemName)) return alert("Menu dengan nama dan kategori ini sudah ada. Hapus dulu untuk mengubah.");

    const menuData = { 
        name: name, 
        category: category,
        uniqueName: uniqueItemName,
        priceOffline: priceOffline,
        markupOnline: markupOnline,
        isExtra: category === 'Extra' 
    };

    store.menus.push(menuData);
    saveStore();
    
    $("mName").value=""; 
    $("mCategory").value="";
    $("mPriceOffline").value=""; 
    $("mOnlineMarkup").value=""; 

    renderMenus();
    renderMenuEditor();
}

function renderMenuEditor(){
    const root=$("menuEditor");
    root.innerHTML="";
    
    store.menus.forEach((m,i)=>{
        const priceOffline = formatRp(m.priceOffline);
        const priceOnline = formatRp(m.priceOffline + m.markupOnline);
        const markup = formatRp(m.markupOnline);

        const priceDetail = `OFFLINE: ${priceOffline} | ONLINE: ${priceOnline} (+${markup})`;

        const div=document.createElement("div");
        div.className="menu-item";
        div.innerHTML=`
            <div>
                <strong>${m.name} (${m.category})</strong><br>
                <small>${priceDetail}</small>
            </div>
            <button class='btn danger' onclick='delMenu(${i})'>Hapus</button>
        `;
        root.appendChild(div);
    });
}
function delMenu(i){store.menus.splice(i,1);saveStore();renderMenus();renderMenuEditor();}

function addDiscount(){
    if(!currentUser || currentUser.role!=='Manager') return alert("Akses ditolak. Hanya Manajer yang dapat mengelola diskon.");
    
    const name=$("dName").value.trim();
    const type=$("dType").value;
    const value=Number($("dValue").value);

    if(!name || !type || !value) return alert("Isi Nama Diskon, Tipe, dan Nilai.");
    
    if(store.discounts.find(d => d.name === name)) return alert("Nama diskon sudah ada.");
    
    store.discounts.push({ 
        name, 
        type,
        value: value
    });

    saveStore();
    
    $("dName").value=""; 
    $("dType").value="";
    $("dValue").value=""; 

    renderDiscountEditor();
    renderDiscountSelector(); 
}

function renderDiscountEditor(){
    const root=$("discountEditor");
    root.innerHTML="";
    
    if(store.discounts.length === 0) {
        root.innerHTML = "<p>Belum ada diskon terdaftar.</p>";
        return;
    }

    store.discounts.forEach((d,i)=>{
        const displayType = d.type === 'percentage' ? 'Persen' : 'Nominal';
        const displayValue = d.type === 'percentage' ? `${d.value}%` : formatRp(d.value);
        
        const div=document.createElement("div");
        div.className="menu-item";
        div.innerHTML=`
            <div>
                <strong>${d.name}</strong><br>
                <small>Tipe: ${displayType} | Nilai: ${displayValue}</small>
            </div>
            <button class='btn danger' onclick='delDiscount(${i})'>Hapus</button>
        `;
        root.appendChild(div);
    });
}
function delDiscount(i){
    if (appliedDiscount && appliedDiscount.name === store.discounts[i]?.name) {
        appliedDiscount = null;
    }
    store.discounts.splice(i,1);
    saveStore();
    renderDiscountEditor();
    renderOrders(); 
    renderDiscountSelector();
}

function renderDiscountSelector() {
    const selector = $("discountSelector");
    if (!selector) return; 

    selector.innerHTML = '<option value="">-- Pilih Diskon (Tidak Ada) --</option>';
    
    store.discounts.forEach((d, index) => {
        const display = d.type === 'percentage' ? `${d.value}%` : formatRp(d.value);
        selector.innerHTML += `<option value="${index}">${d.name} (${display})</option>`;
    });

    if (appliedDiscount) {
        const index = store.discounts.findIndex(d => d.name === appliedDiscount.name);
        if (index !== -1) selector.value = index;
    }
}

function applyDiscount() {
    const selector = $("discountSelector");
    const index = selector.value;
    
    if (index === "") {
        appliedDiscount = null;
    } else {
        appliedDiscount = store.discounts[parseInt(index)];
    }
    renderOrders();
}

function deleteTransaction(id) {
    if (!currentUser || currentUser.role !== 'Manager') {
        alert("Akses ditolak. Hanya Manajer yang dapat menghapus transaksi.");
        return;
    }

    if (confirm(`Yakin ingin menghapus Transaksi ID: ${id}? Tindakan ini tidak dapat dibatalkan.`)) {
        store.transactions = store.transactions.filter(t => t.id !== id);
        saveStore();
        alert("Transaksi berhasil dihapus.");
        showReport('today'); 
    }
}
  // ======================================================================
// FUNGSI LAPORAN, GRAFIK, DAN CETAK
// ======================================================================

function getFilteredTransactions(filterType = null, dateInputTrigger = false) {
    const transactions = store.transactions;
    const now = new Date();
    const today = getDateOnly(now);
    let startDate = null;
    let endDate = null;
    
    if (dateInputTrigger) {
        const dateValue = $("reportDate").value;
        if (!dateValue) {
            return [];
        }
        
        const selectedDate = new Date(dateValue);
        
        if (filterType === 'month' || (selectedDate.getDate() === 1 && new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getDate() === selectedDate.getDate())) {
            // Jika tanggal yang dipilih adalah tanggal 1 (asumsi awal bulan) atau filter bulan
            startDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth(), 1).getTime();
            endDate = new Date(selectedDate.getFullYear(), selectedDate.getMonth() + 1, 0).getTime();
        } else {
            // Filter harian (default ketika tanggal spesifik dipilih)
            startDate = getDateOnly(selectedDate);
            endDate = startDate; 
        }

    } else if (filterType === 'today') {
        startDate = today;
        endDate = today;
    } else if (filterType === 'yesterday') {
        startDate = today - (24 * 60 * 60 * 1000);
        endDate = startDate;
    } else if (filterType === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 0).getTime(); 
    } 

    if (startDate !== null) {
        return transactions.filter(t => {
            const trxDateOnly = getDateOnly(t.date);
            return trxDateOnly >= startDate && trxDateOnly <= endDate;
        });
    }
    return transactions; 
}


function showReport(filterType = 'today', dateInputTrigger = false){
    let reportPeriod;
    let activeFilter = filterType; 
    let selectedDate = null; 

    if (dateInputTrigger) {
        selectedDate = $("reportDate").value;
        if (!selectedDate) {
            alert("Silakan pilih tanggal terlebih dahulu.");
            return;
        }
        const selDateObj = new Date(selectedDate);
        if (selDateObj.getDate() === 1) { // Jika tanggal 1, anggap ingin laporan bulanan
            reportPeriod = `Bulan ${selDateObj.toLocaleDateString('id-ID', {month:'long', year:'numeric'})}`;
            activeFilter = 'month'; // Set filter type ke month untuk logika grafik
        } else {
            reportPeriod = selDateObj.toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
            activeFilter = 'daily';
        }
    } else if (filterType === 'today') {
        reportPeriod = 'Hari Ini';
    } else if (filterType === 'yesterday') {
        reportPeriod = 'Kemarin';
    } else if (filterType === 'month') {
        reportPeriod = 'Bulan Ini';
    } else {
        reportPeriod = 'Semua Transaksi';
    }
    
    const filteredTrx = getFilteredTransactions(activeFilter, dateInputTrigger);

    renderSummary(filteredTrx, reportPeriod);
    renderSalesByMenu(filteredTrx); 
    renderTransactionDetails(filteredTrx);
    renderSalesGraph(filteredTrx, activeFilter, selectedDate); 
}
// FUNGSI GRAFIK (Chart.js)
function renderSalesGraph(transactions, filterType, selectedDate) {
    const canvas = $("salesChart");
    if (salesChartInstance) {
        salesChartInstance.destroy();
    }
    
    let labels = [];
    let salesData = [];
    let title = "Grafik Penjualan";
    const now = new Date();

    if (filterType === 'today' || filterType === 'yesterday' || filterType === 'daily') {
        // Harian (Per Jam)
        title = "Grafik Penjualan Harian (Per Jam)";
        for (let i = 0; i < 24; i++) {
            labels.push(`${i}:00`);
            salesData.push(0);
        }
        transactions.forEach(t => {
            const hour = new Date(t.date).getHours();
            if (hour >= 0 && hour < 24) {
                salesData[hour] += t.total;
            }
        });
    } else if (filterType === 'month' || selectedDate) {
        // Bulanan (Per Hari)
        title = "Grafik Penjualan Per Hari";
        let dateMap = {};
        let start, end;

        if (filterType === 'month') {
            start = new Date(now.getFullYear(), now.getMonth(), 1);
            end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
        } else if (selectedDate) {
            // Logika untuk Laporan Bulanan dari Tanggal Spesifik
            const selectedDateObj = new Date(selectedDate);
            const selectedMonth = selectedDateObj.getMonth();
            const selectedYear = selectedDateObj.getFullYear();
            
            // Jika filter harian terpilih, kembali ke grafik harian
            if (filterType === 'daily' && getDateOnly(selectedDateObj) === getDateOnly(selectedDateObj)) {
                 // Cek jika tanggal yang dipilih adalah Hari Ini, tampilkan laporan Harian
                if (getDateOnly(selectedDateObj) === getDateOnly(now)) {
                    // return renderSalesGraph(transactions, 'today', selectedDate); // Sudah dihandle di atas
                } else {
                    // Jika bukan Hari Ini, tetap Harian (Per Jam)
                     return renderSalesGraph(transactions, 'daily', selectedDate);
                }
            }
            
            start = new Date(selectedYear, selectedMonth, 1);
            end = new Date(selectedYear, selectedMonth + 1, 0);
        }
        
        if (start && end) {
            for (let d = start; d <= end; d.setDate(d.getDate() + 1)) {
                const dateStr = new Date(d).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
                labels.push(dateStr);
                dateMap[getDateOnly(d)] = labels.length - 1; 
                salesData.push(0);
            }
            
            transactions.forEach(t => {
                const dayKey = getDateOnly(t.date);
                const index = dateMap[dayKey];
                if (index !== undefined) {
                    salesData[index] += t.total;
                }
            });
        }
    }

    const ctx = canvas.getContext('2d');
    salesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Penjualan Bersih',
                data: salesData,
                backgroundColor: 'rgba(75, 192, 192, 0.6)',
                borderColor: 'rgba(75, 192, 192, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        callback: function(value) {
                            if (parseInt(value) >= 1000) {
                                return 'Rp ' + value.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
                            } else {
                                return 'Rp ' + value;
                            }
                        }
                    }
                }
            },
            plugins: {
                title: {
                    display: true,
                    text: title
                }
            }
        }
    });
}

function renderSummary(filteredTrx, filter) {
    const root = $("laporanSummary");
    const totalSales = filteredTrx.reduce((acc, t) => acc + t.total, 0);
    const totalSubtotal = filteredTrx.reduce((acc, t) => acc + (t.subtotal || t.total), 0);
    const totalDiscount = filteredTrx.reduce((acc, t) => acc + (t.discountAmount || 0), 0);
    const totalCount = filteredTrx.length;
    
    let salesByOutlet = {};
    filteredTrx.forEach(t => {
        const outlet = t.orderType || 'N/A';
        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;
    });
    
    let outletHtml = Object.entries(salesByOutlet).map(([type, total]) => 
        `<p style="margin-left: 10px;">- ${type}: **${formatRp(total)}**</p>`
    ).join('');

    root.innerHTML = `
        <p>Periode Laporan: **${filter}**</p> 
        <p>Total Transaksi: **${totalCount}** Nota</p>
        <p style="font-weight: bold; margin-top: 10px;">Sales Outlet:</p>
        ${outletHtml}
        <p style="font-size: 1.0em; color: #666; margin-top: 10px;">Subtotal Kotor: **${formatRp(totalSubtotal)}**</p>
        <p style="font-size: 1.0em; color: #c62828;">Diskon Total: **${formatRp(totalDiscount)}**</p>
        <p style="font-size: 1.2em; color: #2e7d32;">Total Penjualan Bersih: **${formatRp(totalSales)}**</p>
    `;
}

function renderSalesByMenu(filteredTrx) {
    const root = $("salesByMenu");
    let menuMix = {};

    filteredTrx.forEach(t => {
        t.items.forEach(item => {
            if (!menuMix[item.name]) { 
                menuMix[item.name] = { qty: 0, total: 0 };
            }
            menuMix[item.name].qty += item.qty;
            menuMix[item.name].total += item.price * item.qty;
        });
    });

    if (Object.keys(menuMix).length === 0) {
        root.innerHTML = "<p>Tidak ada penjualan menu di periode ini.</p>";
        return;
    }

    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty); 

    let html = `<table class="report-table">
        <thead>
            <tr><th>Nama Menu (Ukuran/Topping)</th><th>QTY Terjual</th><th>Total Penjualan</th></tr>
        </thead>
        <tbody>`;

    sortedMenu.forEach(([name, data]) => {
        html += `
            <tr>
                <td>${name}</td>
                <td>${data.qty}</td>
                <td>${formatRp(data.total)}</td>
            </tr>
        `;
    });

    html += `</tbody></table>`;
    root.innerHTML = html;
}

function renderTransactionDetails(filteredTrx) {
    const root=$("laporanList");
    root.innerHTML="";

    if(filteredTrx.length===0){
        root.innerHTML="<p>Tidak ada detail transaksi di periode ini.</p>";
        return;
    }
    
    const isManager = currentUser && currentUser.role === 'Manager'; 

    filteredTrx.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t=>{
        const d=document.createElement("div");
        d.className="order-item";
        d.style.borderBottom = "1px solid #eee";
        d.style.marginBottom = "10px";
        
        const noteDisplay = t.note ? t.note : 'Tunai';

        const deleteBtn = isManager ? 
            `<button class='btn danger' style='padding: 5px 10px; font-size: 0.8em; margin-top: 5px; background: #c62828;' onclick='deleteTransaction(${t.id})'>Hapus Transaksi</button>` : '';

        const discountDisplay = (t.discount && t.discountAmount) ? 
            `<p style="margin: 5px 0; color: #d32f2f;">Diskon (${t.discount.name}): -${formatRp(t.discountAmount)}</p>` : ''; 
        
        const subtotalDisplay = t.subtotal ? `Subtotal: ${formatRp(t.subtotal)}` : `Subtotal: ${formatRp(t.total)}`;
        const paymentMethod = t.paymentMethod || 'Tunai'; 

        d.innerHTML=`
            <div>**Nota ID: ${t.id}**</div>
            <div>Waktu: ${new Date(t.date).toLocaleString("id-ID")}<br>Pelanggan/Driver: ${noteDisplay}<br>${t.orderType} | Bayar: ${paymentMethod} oleh Kasir: ${t.user}</div>
            <p style="margin: 5px 0;">Item: ${t.items.map(i => `${i.name} x${i.qty}`).join(', ')}</p>
            <div style="margin: 5px 0;">${subtotalDisplay}</div>
            ${discountDisplay} 
            <div style="font-weight: bold; color: #2e7d32;">Total Akhir: ${formatRp(t.total)}</div>
            ${deleteBtn}
        `;
        root.appendChild(d);
    });
}

function printClosing(){
    if(!currentUser || currentUser.role!=='Manager') return alert("Hanya Manajer yang dapat mencetak closing report.");
    
    const today = new Date().toLocaleDateString("id-ID");
    const trx = store.transactions.filter(t => new Date(t.date).toLocaleDateString("id-ID") === today);

    if(trx.length === 0) return alert("Tidak ada transaksi untuk hari ini.");

    const totalSubtotal = trx.reduce((acc, t) => acc + (t.subtotal || t.total), 0);
    const totalDiscount = trx.reduce((acc, t) => acc + (t.discountAmount || 0), 0);
    const totalSales = trx.reduce((acc, t) => acc + t.total, 0);

    const MAX_WIDTH = 42; 

    const padLine = (label, value) => { 
        const valueStr = String(value);
        const labelLen = label.length;
        const space = MAX_WIDTH - labelLen - valueStr.length;
        return `${label}${Array(space > 0 ? space : 1).join('.')}${valueStr}`; 
    };

    let salesByPayment = {};
    trx.forEach(t => {
        const method = t.paymentMethod || 'Tunai';
        salesByPayment[method] = (salesByPayment[method] || 0) + t.total;
    });

    const paymentDetail = Object.entries(salesByPayment).map(([method, total]) => 
        padLine(`- ${method}:`, formatRp(total))
    ).join('\n');


    const menuMix = {};
    trx.forEach(t => t.items.forEach(item => {
        if (!menuMix[item.name]) { 
            menuMix[item.name] = { qty: 0, total: 0 };
        }
        menuMix[item.name].qty += item.qty;
        menuMix[item.name].total += item.price * item.qty;
    }));
    
    const createReportLine = (name, data) => { 
        const totalRpStr = formatRp(data.total).padStart(12); 
        const namePart = `${name.substring(0, MAX_WIDTH - 15)} x${data.qty}`; 
        const space = MAX_WIDTH - namePart.length - totalRpStr.length;
        return `${namePart}${Array(space > 0 ? space : 1).join('.')}${totalRpStr}`; 
    };

    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty);
    const menuDetail = sortedMenu.map(([name, data]) => createReportLine(name, data)).join('\n');


    const w=window.open("","_blank");
    
    const kasirLine = padLine("Manajer/Kasir: ", currentUser ? currentUser.email : "-");
    const dateLine = padLine("Tanggal Cetak: ", new Date().toLocaleString("id-ID"));
    const totalTrxLine = padLine("Total Transaksi: ", `${trx.length} Nota`);

    w.document.write(`
        <pre style='font-family:monospace; font-size: 14px; line-height: 1.2; width: 80mm; max-width: 80mm;'>
 === CLOSING REPORT HARIAN ===
        
 Outlet: JIF PIZZA CONDET
${kasirLine}
${dateLine}
${'__________________________________________'.substring(0, MAX_WIDTH)} 
RINGKASAN PENJUALAN
${totalTrxLine}
${padLine("Subtotal Kotor: ", formatRp(totalSubtotal))}
${padLine("Diskon Total: ", formatRp(totalDiscount))}
${padLine("TOTAL PENJUALAN AKHIR: ", formatRp(totalSales))}

${'__________________________________________'.substring(0, MAX_WIDTH)}
SALES BY PAYMENT METHOD
${paymentDetail}

${'__________________________________________'.substring(0, MAX_WIDTH)}
SALES BY MENU (PRODUCT MIX)
${menuDetail.trim()}
${'__________________________________________'.substring(0, MAX_WIDTH)}
==========================================
TERIMA KASIH, LAPORAN SELESAI
        </pre>
    `);
    w.print();
}

function printReport() {
    const dateInputTrigger = $("reportDate").value ? true : false;
    let activeFilter = 'today'; 
    
    if (dateInputTrigger) {
        const selectedDate = $("reportDate").value;
        const selDateObj = new Date(selectedDate);
        if (selDateObj.getDate() === 1) { // Jika tanggal 1, anggap ingin laporan bulanan
            activeFilter = 'month'; 
        } else {
            activeFilter = 'daily';
        }
    }

    const filteredTrx = getFilteredTransactions(activeFilter, dateInputTrigger);
    
    if (filteredTrx.length === 0) {
        return alert("Tidak ada transaksi dalam periode ini untuk dicetak.");
    }
    
    let reportPeriod;
    if (dateInputTrigger) {
        const selectedDate = $("reportDate").value;
        const selDateObj = new Date(selectedDate);
        if (selDateObj.getDate() === 1) { 
            reportPeriod = `Bulan ${selDateObj.toLocaleDateString('id-ID', {month:'long', year:'numeric'})}`;
        } else {
            reportPeriod = selDateObj.toLocaleDateString('id-ID', {day:'numeric', month:'long', year:'numeric'});
        }
    } else if (activeFilter === 'today') {
        reportPeriod = 'Hari Ini';
    } else if (activeFilter === 'yesterday') {
        reportPeriod = 'Kemarin';
    } else if (activeFilter === 'month') {
        reportPeriod = 'Bulan Ini';
    } else {
        reportPeriod = 'Semua Transaksi';
    }

    const totalSubtotal = filteredTrx.reduce((acc, t) => acc + (t.subtotal || t.total), 0);
    const totalDiscount = filteredTrx.reduce((acc, t) => acc + (t.discountAmount || 0), 0);
    const totalSales = filteredTrx.reduce((acc, t) => acc + t.total, 0);
    
    let salesByOutlet = {};
    filteredTrx.forEach(t => {
        const outlet = t.orderType || 'N/A';
        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;
    });

    const menuMix = {};
    filteredTrx.forEach(t => t.items.forEach(item => {
        if (!menuMix[item.name]) { menuMix[item.name] = { qty: 0, total: 0 }; }
        menuMix[item.name].qty += item.qty;
        menuMix[item.name].total += item.price * item.qty;
    }));

    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty);
    
    const MAX_WIDTH = 42; 
    const padLine = (label, value) => {
        const valStr = String(value);
        const labelLen = label.length;
        const space = MAX_WIDTH - labelLen - valStr.length;
        return `${label}${Array(space > 0 ? space : 1).join('.')}${valStr}`; 
    };
    const createReportLine = (name, data) => { 
        const totalRpStr = formatRp(data.total).padStart(12); 
        const namePart = `${name.substring(0, MAX_WIDTH - 15)} x${data.qty}`; 
        const space = MAX_WIDTH - namePart.length - totalRpStr.length;
        return `${namePart}${Array(space > 0 ? space : 1).join('.')}${totalRpStr}`; 
    };

    const outletDetail = Object.entries(salesByOutlet).map(([type, total]) => 
        padLine(`- ${type}:`, formatRp(total))
    ).join('\n');
    
    const menuDetail = sortedMenu.map(([name, data]) => createReportLine(name, data)).join('\n');

    const w = window.open("", "_blank");
    
    const kasirLine = padLine("Manajer/Kasir: ", currentUser ? currentUser.email : "-");
    const dateLine = padLine("Tanggal Cetak: ", new Date().toLocaleString("id-ID"));
    const totalTrxLine = padLine("Total Transaksi: ", `${filteredTrx.length} Nota`);

    w.document.write(`
        <pre style='font-family:monospace; font-size: 14px; line-height: 1.2; width: 80mm; max-width: 80mm;'>
        
 === LAPORAN PENJUALAN PERIODE ===
        
 Outlet: JIF PIZZA CONDET
 Periode: ${reportPeriod}
${kasirLine}
${dateLine}
        
${'__________________________________________'.substring(0, MAX_WIDTH)} 
RINGKASAN PENJUALAN
${totalTrxLine}
${padLine("Subtotal Kotor: ", formatRp(totalSubtotal))}
${padLine("Diskon Total: ", formatRp(totalDiscount))}
${padLine("TOTAL PENJUALAN AKHIR: ", formatRp(totalSales))}

${'__________________________________________'.substring(0, MAX_WIDTH)}
SALES BY OUTLET
${outletDetail}

${'__________________________________________'.substring(0, MAX_WIDTH)}
SALES BY MENU (PRODUCT MIX)
${menuDetail.trim()}
${'__________________________________________'.substring(0, MAX_WIDTH)}
==========================================
LAPORAN SELESAI
        </pre>
    `);
    w.print();
}

window.onload=()=>{
  if (currentUser) {
    if(currentUser.role === 'Manager'){
      $("userRoleDisplay").innerText = `Manajer: ${currentUser.email}`;
    } else {
      $("userRoleDisplay").innerText = `Kasir: ${currentUser.email}`;
    }
    activateTab('home');
  } else {
    showLogin();
  }
};
</script>
</body>
</html>