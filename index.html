<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JIF PIZZA POS v10.3 ‚Äî Final Rev</title>
<link rel="icon" href="logo.png"/>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="JIF POS">
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="logo.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 
<style>
/* CSS */
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:#222}
.hidden{display:none}
header.hidden, .navbar.hidden { display: none !important; }

/* REVISI 1: Aturan responsif umum */
.container { 
    padding: 14px; 
    max-width: 100%; /* Pastikan tidak melebihi lebar layar */
    box-sizing: border-box; /* Padding dihitung di dalam lebar */
}
input, select { 
    box-sizing: border-box; /* Input dan select juga dihitung di dalam lebar */
}
/* END REVISI 1 */
/* LATAR BELAKANG GAMBAR HEADER (pizza.jpg) */
header{
  background:url('pizza.jpg') center/cover no-repeat; 
  color:#fff;
  padding:12px;
  text-align:center;
  position: relative; 
  z-index: 1; 
  height: 80px;
  overflow: hidden; 
}
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); 
    z-index: 1; 
} 
header h1, header p {
    position: relative; 
    z-index: 2; 
}
header h1{margin:0;font-size:22px}
header p{margin:4px 0 0 0;font-size:14px}
/* Gaya Tombol 3D */
.navbar button, .btn {
    padding: 10px 16px; 
    border: none;
    border-radius: 8px; 
    cursor: pointer;
    font-weight: 600;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08); 
    background: linear-gradient(145deg, #f0f0f0, #e0e0e0); 
    color: #333;
    /* REVISI 2: Teks Tombol Tengah */
    display: flex;
    align-items: center; /* Pusat Vertikal */
    justify-content: center; /* Pusat Horizontal */
    text-align: center; /* Cadangan */
}
.navbar button:hover, .btn:hover {
    transform: translateY(-1px); 
    box-shadow: 0 6px 10px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
}
.navbar button:active, .btn:active {
    transform: translateY(1px); 
    box-shadow: 0 2px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.08);
}
/* Gaya spesifik untuk tombol primary (merah) */
.btn.primary, .navbar button.primary-nav { 
    background: linear-gradient(145deg, #e57373, #d32f2f);
    color: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.secondary, .navbar button.secondary-nav { 
    background: linear-gradient(145deg, #64b5f6, #1976d2);
    color: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.danger, .navbar button.danger-nav { 
    background: linear-gradient(145deg, #ef5350, #c62828);
    color: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
/* GAYA TAB AKTIF (Merah) */
.navbar button.active-tab {
    background: linear-gradient(145deg, #d32f2f, #e57373);
    color: #fff;
    box-shadow: 0 0 5px rgba(217, 73, 73, 0.7); 
    transform: none; 
}
.navbar{background:#fff;display:flex;justify-content:center;gap:8px;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow-x: auto;} /* REVISI 1: Tambah overflow-x: auto */
.container{padding:14px}
#loginPage {
    max-width: 400px; 
    margin: 40px auto; 
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/* REVISI 1: Menu Grid lebih fleksibel di HP */
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.menu-item{border:1px solid #ccc;border-radius:8px;padding:8px;text-align:center;cursor:pointer}
.menu-item {
    background: #fdfdfd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.1s ease-in-out;
    /* REVISI 1: Pastikan konten tidak terpotong */
    word-wrap: break-word; 
    overflow: hidden;
    font-size: 0.9em;
}
.menu-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
/* NEW: Gaya Order Item Detail (untuk tombol Hapus) */
.order-item-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px dashed #eee;
    flex-wrap: nowrap; /* REVISI 1: Jangan wrap agar rapi di HP */
    overflow-x: auto; /* Tambahkan scroll jika konten terlalu lebar */
}
.order-item-detail > div {
    flex-shrink: 0; /* Pastikan elemen div tidak menyusut paksa */
}
.order-item-detail .delete-btn {
    padding: 3px 6px;
    font-size: 0.7em;
    margin-left: 10px;
    box-shadow: none;
    flex-shrink: 0;
}
/* Gaya untuk input diskon per item (REVISI 1: Lebihkan sedikit untuk Rupiah) */
.item-discount-input {
    width: 60px; /* Diperkecil lagi */
    padding: 3px;
    font-size: 0.8em; /* Diperkecil */
    text-align: right;
    margin: 0 5px;
    flex-shrink: 0;
}
.order-box{margin-top:12px;padding:10px;border-top:2px solid #ccc}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:100;display:none}
.modal{
  background:white;
  padding:20px;
  border-radius:10px;
  text-align:center;
  max-width:90%; /* REVISI 1: Maksimal 90% lebar layar */
  width:90%;
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
} 
/* Tambahan untuk tata letak tombol payment di modal */
.modal .payment-method-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 kolom */
    gap: 8px; 
}
input, select{padding:8px;border:1px solid #ccc;border-radius:6px;width:100%;margin:4px 0}
/* REVISI 1: Table Responsif */
.report-table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 15px; 
    font-size: 0.8em; /* Dikecilkan */
}
.report-table th, .report-table td { 
    border: 1px solid #ddd; 
    padding: 5px; /* Dikecilkan */
    text-align: left; 
    word-wrap: break-word;
}
.report-table th { background-color: #f2f2f2; }
/* REVISI 1: Div untuk membuat tabel bisa digulir secara horizontal */
.table-container { 
    overflow-x: auto; 
    width: 100%; 
    box-sizing: border-box;
}
/* END REVISI 1 */
#homePage img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: block;
    margin: 0 auto 20px auto; 
}
/* NEW: Gaya Kotak Ringkasan Laporan */
.report-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* REVISI 1: Dikecilkan lagi */
    gap: 10px;
    margin-top: 15px;
}
.summary-card {
    background: #fff;
    padding: 10px; /* Dikecilkan */
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 5px solid; /* Akan diubah sesuai tipe */
    text-align: left;
}
.summary-card h4 {
    margin: 0 0 5px 0;
    font-size: 0.7em; /* Dikecilkan */
    color: #666;
    text-transform: uppercase;
    line-height: 1.2;
}
.summary-card .value {
    font-size: 1.1em; /* Dikecilkan */
    font-weight: 700;
}
/* Warna spesifik untuk border card */
.card-sales { border-left-color: #2e7d32; } 
.card-count { border-left-color: #1976d2; } 
.card-subtotal { border-left-color: #fbc02d; } 
.card-discount { border-left-color: #d32f2f; } 

/* Gaya untuk detail outlet/metode bayar di laporan */
.detail-list {
    list-style: none;
    padding-left: 0;
    margin-top: 5px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 6px;
    font-size: 0.9em; /* Dikecilkan */
}
.detail-list li {
    padding: 5px 0;
    border-bottom: 1px dashed #ddd;
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
}
.detail-list li:last-child {
    border-bottom: none;
}
/* REVISI 1: Tata Letak Detail Summary di Laporan */
#laporanDetailSummary > div {
    flex-direction: column; /* Ubah menjadi kolom di layar kecil */
    gap: 10px !important;
}

/* Print style untuk 58mm */
@media print {
    body { 
        width: 58mm; /* Ukuran Printer 58mm */
        margin: 0; 
        padding: 0; 
        font-family: 'Courier New', Courier, monospace !important; 
        font-size: 12px !important; /* Dikecilkan sedikit agar muat */
    }
    pre { 
        width: 58mm !important; 
        max-width: 58mm !important; 
        font-family: 'Courier New', Courier, monospace !important; 
    }
}
</style>
</head>
<body>
<header id="appHeader" class="hidden"> 
  <h1>üçï JIF PIZZA CONDET</h1>
  <p id="userRoleDisplay">Mode Offline</p>
</header>
<div id="appNavbar" class="navbar hidden"> 
  <button id="nav-home" class="secondary-nav" onclick="activateTab('home')">Home</button>
  <button id="nav-kasir" class="secondary-nav" onclick="activateTab('kasir')">Kasir</button>
  <button id="nav-menu" class="secondary-nav" onclick="activateTab('menu')">Menu</button> 
  <button id="nav-laporan" class="secondary-nav" onclick="activateTab('laporan');showReport('today')">Laporan</button>
  <button id="nav-logout" class="secondary-nav" onclick="logout()">Logout</button>
</div>
<div id="loginPage" class="container">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"/>
  <input type="password" id="password" placeholder="Password"/>
  <button class="btn primary" onclick="login()">Login</button>
  <button class="btn secondary" onclick="register()">Daftar (User)</button>
  <p style="font-size: 0.8em; margin-top: 15px; color: #666;">
    *Simulasi Role: Akun baru otomatis menjadi Kasir (User).
    (Akun Manajer sudah terdaftar)
  </p>
</div>
<div id="homePage" class="container hidden">
  <img src="pizza.jpg" alt="JIF Pizza" /> <h2 style="color: #d94949;">Selamat Datang di Jif Pizza!</h2>
  <p style="line-height: 1.6;">
    Ini adalah tempat di mana semangat bertemu dengan peluang. Kami percaya pada potensi setiap individu. Gunakan hari-hari Anda di sini untuk belajar, bertumbuh, dan mengukir prestasi. Jadilah bagian dari resep rahasia kesuksesan kami.
    <br><br>
    Mari mulai memanggang masa depan yang cerah!
  </p>
  <button class="btn primary" onclick="activateTab('kasir')">Mulai Kasir</button>
</div>
<div id="kasirPage" class="container hidden">
  <input type="text" id="customerNote" placeholder="Nama Pelanggan/Driver/Catatan" style="margin-bottom: 10px;"/>
  <div id="orderLabel"></div>
  <div class="navbar" style="margin-top: 10px; box-shadow: none; border: 1px solid #eee; overflow-x: auto; justify-content: flex-start;">
    <button class="secondary-nav" onclick="renderMenus('Semua')">Semua</button>
    <button class="secondary-nav" onclick="renderMenus('Large')">Large</button>
    <button class="secondary-nav" onclick="renderMenus('Reguler')">Reguler</button>
    <button class="secondary-nav" onclick="renderMenus('Separuh')">Separuh</button> 
    <button class="secondary-nav" onclick="renderMenus('Extra')">Extra</button>
  </div>
  <div id="menuList" class="menu-grid" style="margin-top: 10px;"></div>
  
  <div class="order-box">
    <h3>Pesanan</h3>
    <div id="orderList"></div>
    <div style="border-top: 1px solid #ccc; padding: 5px 0; margin-top: 10px;">
        <div id="discountDisplay" style="font-weight: bold; color: #c62828;">Total Diskon: Rp 0</div>
    </div>
    <h3 id="totalDisplay" style="color: #2e7d32; margin-top: 10px;">TOTAL BAYAR: Rp 0</h3> 
    <button class="btn primary" onclick="openPaymentModal()">Bayar & Cetak</button>
  </div>
</div>
<div id="menuPage" class="container hidden">
  <h3>Tambah Menu (Manajer Only)</h3>
  <input id="mName" placeholder="Nama menu (misal: Mix Lovers)"/>
  
  <select id="mCategory">
    <option value="">-- Pilih Ukuran/Kategori --</option>
    <option value="Large">Large Pizza</option>
    <option value="Reguler">Reguler Pizza</option>
    <option value="Separuh">Separuh Pizza</option> 
    <option value="Extra">Extra Topping</option>
  </select>
  
  <input id="mPriceOffline" type="number" placeholder="Harga Jual OFFLINE (Rp)"/>
  <input id="mGojekMarkup" type="number" placeholder="Markup Harga GOJEK/GOPAY (Rp)"/>
  <input id="mGrabMarkup" type="number" placeholder="Markup Harga GRAB/OVO (Rp)"/>
  <input id="mShopeeMarkup" type="number" placeholder="Markup Harga SHOPEEPAY (Rp)"/>
  
  <button class="btn primary" onclick="addMenu()">Tambah</button>
  <div class="table-container">
    <div id="menuEditor"></div>
  </div>
</div>
<div id="laporanPage" class="container hidden">
  <h3>Laporan Penjualan</h3>
  
  <div style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
    <label for="reportDate" style="font-weight: bold;">Pilih Tanggal Spesifik:</label>
    <input type="date" id="reportDate" style="width: 100%; display: block; margin-bottom: 10px;"/>
    <button class="btn primary" onclick="showReport(null, true)">Tampilkan Laporan</button>
    <button class="btn secondary" style="margin-top: 10px;" onclick="printReport()">Cetak Laporan</button> 
  </div>
  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button class="btn secondary" onclick="showReport('today')">Hari Ini</button>
    <button class="btn secondary" onclick="showReport('yesterday')">Kemarin</button>
    <button class="btn secondary" onclick="showReport('month')">Bulan Ini</button>
  </div>
  
  <h4 style="margin-top: 20px;">Grafik Penjualan</h4>
  <div style="width: 100%; max-width: 600px; margin: 0 auto;">
    <canvas id="salesChart"></canvas> 
  </div>
  
  <p style="font-weight: bold; margin-top: 20px;">Ringkasan Penjualan:</p>
  <div id="laporanSummary" class="report-summary-grid">
    </div> 
  <h4 style="margin-top: 20px;">Detail Outlet & Pembayaran</h4>
  <div id="laporanDetailSummary">
    </div>
  
  <h4 style="margin-top: 20px;">Sales by Menu (Product Mix)</h4>
  <div id="salesByMenu"></div>

  <h4 style="margin-top: 20px;">Detail Transaksi</h4>
  <div class="table-container">
    <div id="laporanList"></div>
  </div>
</div>
<div class="overlay" id="orderTypeOverlay">
  <div class="modal">
    <h3>Pilih Tipe Order</h3>
    <button class="btn primary" onclick="setOrderType('Offline')">Order Offline (Tunai/QRIS)</button>
    <h4 style="margin: 10px 0;">Order Online (Pilih Platform)</h4>
    <button class="btn secondary" onclick="setOrderType('Gojek')">Gojek/Gopay</button>
    <button class="btn secondary" onclick="setOrderType('Grab')">Grab/OVO</button>
    <button class="btn secondary" onclick="setOrderType('Shopee')">ShopeePay</button>
  </div>
</div>

<div class="overlay" id="paymentModal">
  <div class="modal">
    <h3 id="modalTotal">Total Akhir: Rp 0</h3>
    <input type="number" id="manualBayar" placeholder="Nominal Bayar Tunai"/>
    <button class="btn primary" onclick="processManualPayment()">Bayar Tunai & Cetak Struk</button>
    
    <h4 style="margin: 10px 0;">Pilih Metode Bayar:</h4>
    <div class="payment-method-grid"> 
        <button class="btn secondary" id="pay-cash-pas" onclick="completePayment('Cash', currentFinalTotal)">Bayar Pas (Tunai)</button>
        <button class="btn secondary" id="pay-qris" onclick="openQrisModal()">QRIS (Scan Barcode)</button>
        <button class="btn secondary" id="pay-gojek" onclick="completePayment('Gojek')">Bayar Gojek/Gopay</button>
        <button class="btn secondary" id="pay-grab" onclick="completePayment('Grab')">Bayar Grab/OVO</button>
        <button class="btn secondary" id="pay-shopee" onclick="completePayment('Shopee')">Bayar ShopeePay</button>
    </div>
  </div>
</div>
<div class="overlay" id="qrisModal">
  <div class="modal">
    <h3>Scan QRIS Anda</h3>
    <img src="1000208468.jpg" alt="QRIS Payment Baru" style="max-width: 80%; height: auto; margin: 10px auto; display: block;">
    <p>Pastikan pembayaran telah sukses!</p>
    <button class="btn primary" onclick="confirmQrisPayment()">Konfirmasi Pembayaran QRIS</button>
    <button class="btn danger" onclick="$('qrisModal').style.display='none'">Batal</button>
  </div>
</div>
<script>
// ======================================================================
// FUNGSI PWA (SERVICE WORKER & A2HS)
// ======================================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('Service Worker berhasil didaftarkan. Scope:', registration.scope);
      })
      .catch(err => {
        console.log('Gagal mendaftarkan Service Worker:', err);
      });
  });
}
  // ======================================================================
// FUNGSI INTI & UTILITY
// ======================================================================

const STORE_KEY="jif_pos_v10_3"; // Update versi store key
let store=JSON.parse(localStorage.getItem(STORE_KEY)||'{"users":[{"email":"manager@jif.com","password":"123","role":"Manager"}],"menus":[],"transactions":[],"dailyCounter":{}}'); // REVISI 4: Tambah dailyCounter
let currentUser=JSON.parse(localStorage.getItem('currentUser')) || null; 

let orderType=null; 
let cart=[];
let currentFinalTotal = 0; 
let salesChartInstance = null; 

const MAX_WIDTH = 30; 

function saveStore(){
    localStorage.setItem(STORE_KEY,JSON.stringify(store));
}
function formatRp(n){return "Rp "+(n||0).toLocaleString("id-ID");}
function $(id){return document.getElementById(id);}
function getDateOnly(dateString) {
    const d = new Date(dateString);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
}
function getTodayDateKey() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
}
// REVISI 4: Fungsi untuk mendapatkan nomor antrian harian
function getDailyQueueNumber() {
    const todayKey = getTodayDateKey();
    
    // 1. Cek apakah ada counter untuk hari ini
    if (store.dailyCounter && store.dailyCounter.date === todayKey) {
        // Jika ada, increment dan simpan
        store.dailyCounter.count++;
    } else {
        // Jika tidak ada (hari baru), reset counter dan mulai dari 100
        store.dailyCounter = {
            date: todayKey,
            count: 100 // Dimulai dari 100
        };
    }
    saveStore();
    return store.dailyCounter.count;
}


// REVISI 3: Fungsi menghitung harga berdasarkan platform/orderType
function calculatePrice(menu) {
    const base = menu.priceOffline || 0;
    
    if (orderType === 'Gojek') {
        return base + (menu.markupGojek || 0);
    } else if (orderType === 'Grab') {
        return base + (menu.markupGrab || 0);
    } else if (orderType === 'Shopee') {
        return base + (menu.markupShopee || 0);
    }
    return base; // Default: Offline
}
// ======================================================================
// FUNGSI LOGIN / LOGOUT
// ======================================================================
function showLogin(){
  $("appHeader").classList.remove("hidden");
  $("appNavbar").classList.add("hidden");
  ["homePage","kasirPage","menuPage","laporanPage"].forEach(id=>$(id).classList.add("hidden"));
  $("loginPage").classList.remove("hidden");
  
  currentUser = null;
  localStorage.removeItem('currentUser');
}

function login(){
  const email=$("email").value.trim(),pass=$("password").value.trim();
  const u=store.users.find(x=>x.email===email&&x.password===pass);
  if(!u)return alert("Email atau password salah");
  
  currentUser=u;
  localStorage.setItem('currentUser', JSON.stringify(currentUser));
  
  if(currentUser.role === 'Manager'){
    $("userRoleDisplay").innerText = `Manajer: ${currentUser.email}`;
  } else {
    $("userRoleDisplay").innerText = `Kasir: ${currentUser.email}`;
  }
  activateTab('home');
}
function register(){
  const email=$("email").value.trim(),pass=$("password").value.trim();
  if(!email||!pass)return alert("Isi email & password");
  if(store.users.find(u=>u.email===email))return alert("Email sudah terdaftar");
  store.users.push({email,password:pass, role:'User'}); 
  saveStore();
  alert("Akun Kasir berhasil dibuat! Silakan Login.");
}

function logout(){
  if(confirm("Yakin logout & cetak closing report?")){
    printClosing(); 
    currentUser=null;
    localStorage.removeItem('currentUser');
    cart=[];
    showLogin();
  }
}
// ======================================================================
// FUNGSI NAVIGASI
// ======================================================================
function setActiveTab(tabName) {
    const navButtons = document.querySelectorAll('#appNavbar button');
    navButtons.forEach(btn => {
        btn.classList.remove('active-tab');
        btn.classList.remove('secondary-nav'); 
        btn.classList.add('secondary-nav'); 
    });

    const targetButton = $(`nav-${tabName}`);
    if (targetButton) {
        targetButton.classList.add('active-tab');
        targetButton.classList.remove('secondary-nav'); 
    }
}
function renderAppStructure(){
  $("appHeader").classList.remove("hidden");
  $("appNavbar").classList.remove("hidden");
  ["loginPage"].forEach(id=>$(id).classList.add("hidden"));
  
  // PERMINTAAN 2: Logic untuk menyembunyikan/menampilkan tombol Menu (Manajer Only)
  const menuBtn = $("nav-menu");
  if (menuBtn) {
    if (currentUser && currentUser.role === 'Manager') {
      menuBtn.classList.remove('hidden');
    } else {
      menuBtn.classList.add('hidden');
    }
  }
}
function openOrderType(){$("orderTypeOverlay").style.display="flex";}

// REVISI 3: setOrderType kini menyimpan platform spesifik
function setOrderType(type){
    orderType=type;
    $("orderTypeOverlay").style.display="none";
    $("orderLabel").innerText="Tipe Order: "+type;
    renderMenus('Semua'); 
}

function showKasir(){
  openOrderType();
  renderMenus();
  renderOrders();
}

function activateTab(tab){
  renderAppStructure();
  
  ["homePage", "kasirPage","menuPage","laporanPage"].forEach(id=>$(id).classList.add("hidden"));
  
  if(tab==="home"){
    $("homePage").classList.remove("hidden");
  } else if(tab==="kasir"){
    $("kasirPage").classList.remove("hidden");
    showKasir(); 
  } else if(tab==="menu"){
    if(currentUser && currentUser.role === 'Manager'){
      $("menuPage").classList.remove("hidden");
      renderMenuEditor();
    } else {
      alert("Akses ditolak. Fitur Tambah Menu hanya untuk Manajer.");
      activateTab('home'); 
      return;
    }
  } else if(tab==="laporan"){
    $("laporanPage").classList.remove("hidden");
    showReport('today'); 
  }
  
  setActiveTab(tab); 
} 
// ======================================================================
// FUNGSI KASIR & TRANSAKSI (Hapus Item & Payment Modal)
// ======================================================================

function renderMenus(filter = 'Semua'){
    const root=$("menuList");root.innerHTML="";
    if(store.menus.length===0){root.innerHTML="<p>Belum ada menu</p>";return;}
    
    let filteredMenus = store.menus.filter(m => filter === 'Semua' || m.category === filter);
    
    // REVISI 3: priceType diambil dari orderType global
    const priceType = orderType === 'Offline' ? 'Offline' : `Online (${orderType})`;
    
    filteredMenus.forEach(m=>{
        const price = calculatePrice(m);
        if (price > 0) {
            const div=document.createElement("div");div.className="menu-item";
            
            const itemName = `${m.baseMenuName} (${m.category})`; // Menggunakan baseMenuName untuk tampilan lebih ringkas
            
            div.innerHTML=`
                <div><strong>${itemName}</strong></div>
                <div>${formatRp(price)}</div>
                <div style="font-size: 0.7em; color: #666;">Harga ${priceType}</div>
            `;
            div.onclick=()=>addToCart(m, itemName, price); 
            root.appendChild(div);
        }
    });
}

function addToCart(m, itemName, price){
    const f=cart.find(i=>i.name===itemName);
    if(f){
        f.qty++;
    } else {
        cart.push({
            name: itemName, 
            price: price, 
            qty: 1, 
            category: m.category,
            baseMenuName: m.baseMenuName,
            // REVISI 1: Hapus discountPercent, simpan discountAmount (Rp)
            discountAmount: 0, 
            finalPrice: price // Harga setelah diskon
        }); 
    }
    renderOrders();
}
function deleteFromCart(index) {
    if (confirm(`Yakin ingin menghapus item ${cart[index].name}?`)) {
        cart.splice(index, 1);
        renderOrders();
    }
}

/**
 * START OF FIX: Tambahkan fungsi updateFooterTotals()
 */
function updateFooterTotals() {
    let totalDiscount = cart.reduce((acc, c) => acc + c.discountAmount, 0);
    let finalTotal = cart.reduce((acc, c) => acc + c.finalPrice, 0);
    
    $("discountDisplay").innerText = "Total Diskon: -"+formatRp(totalDiscount);
    $("totalDisplay").innerText="TOTAL BAYAR: "+formatRp(finalTotal);
    
    currentFinalTotal = finalTotal; 
}

/**
 * START OF FIX: Modifikasi updateItemDiscount()
 * REVISI 1: Mengubah logika dari Persentase menjadi Rupiah
 */
function updateItemDiscount(index, inputElement) {
    let amount = parseFloat(inputElement.value) || 0; // Ambil nilai Rupiah
    
    const item = cart[index];
    const itemSubtotal = item.price * item.qty;

    if (amount < 0) amount = 0;
    // REVISI 1: Diskon tidak boleh melebihi subtotal
    if (amount > itemSubtotal) amount = itemSubtotal;
    
    inputElement.value = amount; // Tampilkan nilai yang telah dibatasi/dibersihkan
    
    // 1. Perbarui data item
    item.discountAmount = amount;
    item.finalPrice = itemSubtotal - item.discountAmount;
    
    // 2. Perbarui hanya tampilan item secara lokal (di dalam baris pesanan)
    // Cari div display total & diskon, yang merupakan elemen saudara terdekat (nextElementSibling)
    const displayContainer = inputElement.nextElementSibling;
    
    if (displayContainer) {
        // Asumsikan elemen final price adalah span dengan class final-price-display
        const finalPriceElement = displayContainer.querySelector('.final-price-display');
        // Asumsikan elemen diskon adalah small dengan class item-discount-display
        const discDisplayElement = displayContainer.querySelector('.item-discount-display');
        
        if (finalPriceElement) {
            finalPriceElement.innerText = formatRp(item.finalPrice);
        }
        if (discDisplayElement) {
            // Kita hanya perlu update isi textnya
            discDisplayElement.innerText = `Diskon: ${formatRp(item.discountAmount)}`;
        }
    }
    
    // 3. Panggil fungsi baru untuk update total di footer (TANPA merender ulang seluruh daftar)
    updateFooterTotals();
}
/**
 * END OF FIX: updateItemDiscount()
 */
/**
 * START OF FIX: Modifikasi renderOrders()
 */
function renderOrders(){
    const root=$("orderList");
    root.innerHTML="";
    
    let subtotal=0;
    
    if(cart.length===0){
        root.innerHTML="<p>Belum ada pesanan</p>";
        // Panggil fungsi total yang baru
        updateFooterTotals(); 
        return;
    }
    
    cart.forEach((c, index)=>{
        const itemSubtotal = c.price * c.qty;
        subtotal += itemSubtotal;
        
        // REVISI 1: Pastikan diskon tidak melebihi subtotal item
        c.discountAmount = Math.min(c.discountAmount, itemSubtotal); 
        c.finalPrice = itemSubtotal - c.discountAmount;
        
        
        const d=document.createElement("div");
        d.className="order-item-detail"; 
        d.innerHTML=`
            <div style="flex-grow: 1;">
                ${c.name} x${c.qty}
                <br>
                <small>Harga @${formatRp(c.price)}</small>
            </div>
            <input 
                type="number" 
                class="item-discount-input" 
                placeholder="Rp" 
                value="${c.discountAmount}" 
                oninput="updateItemDiscount(${index}, this)"
            >
            <div style="font-weight: bold; text-align: right;">
                <span class="final-price-display">${formatRp(c.finalPrice)}</span>
                <br>
                <small class="item-discount-display" style="color: #c62828;">Disc: ${formatRp(c.discountAmount)}</small>
            </div>
            <button class='btn danger delete-btn' onclick='deleteFromCart(${index})'>Hapus</button>
        `;
        root.appendChild(d);
    });

    const subtotalRef = document.createElement("div");
    subtotalRef.innerHTML = `<h4 style="margin: 5px 0; color: #666;">Subtotal Kotor: ${formatRp(subtotal)}</h4>`;
    root.appendChild(subtotalRef);
    
    // Panggil fungsi total yang baru
    updateFooterTotals(); 
}
/**
 * END OF FIX: renderOrders()
 */
function openPaymentModal() {
    if (cart.length === 0) return alert("Keranjang masih kosong.");
    
    $("manualBayar").value = '';
    $("modalTotal").innerText = `Total Akhir: ${formatRp(currentFinalTotal)}`;
    
    const isOffline = orderType === 'Offline';
    
    // Tampilkan/Sembunyikan elemen cash payment
    const manualPayButton = document.querySelector('#paymentModal .modal > button.primary');
    manualPayButton.style.display = isOffline ? 'block' : 'none';
    $("manualBayar").style.display = isOffline ? 'block' : 'none';
    // Sembunyikan semua tombol payment
    $("pay-cash-pas").style.display = 'none';
    $("pay-qris").style.display = 'none';
    $("pay-gojek").style.display = 'none';
    $("pay-grab").style.display = 'none';
    $("pay-shopee").style.display = 'none';

    // Tampilkan tombol yang relevan
    if (orderType === 'Offline') {
        $("pay-cash-pas").style.display = 'block';
        $("pay-qris").style.display = 'block';
    } else if (orderType === 'Gojek') {
        $("pay-gojek").style.display = 'block';
    } else if (orderType === 'Grab') {
        $("pay-grab").style.display = 'block';
    } else if (orderType === 'Shopee') {
        $("pay-shopee").style.display = 'block';
    }
    
    $("paymentModal").style.display="flex";
}
function processManualPayment(){
    const bayar=Number($("manualBayar").value);
    if(bayar<currentFinalTotal)return alert("Uang bayar kurang!");
    completePayment('Cash', bayar);
}

function openQrisModal(){
    $("paymentModal").style.display="none";
    $("qrisModal").style.display="flex";
}

function confirmQrisPayment(){
    if(confirm("Apakah Anda yakin pembayaran QRIS sudah berhasil?")) {
        completePayment('QRIS', currentFinalTotal);
    }
}
function completePayment(method, bayarManual = 0){
    if(cart.length === 0) return alert("Keranjang kosong.");
    
    let subtotal=0;
    let totalDiscount=0;
    let finalTotal=0;
    
    cart.forEach(c => {
        const itemSubtotal = c.price * c.qty;
        subtotal += itemSubtotal;
        totalDiscount += c.discountAmount;
        finalTotal += c.finalPrice;
    });

    let bayar = 0;
    let change = 0;
    
    if (method === 'Cash') {
        bayar = bayarManual;
        change = bayarManual - finalTotal;
        if (bayarManual === 0) {
            alert("Harap masukkan nominal bayar tunai. Gunakan input manual.");
            return; // Batalkan pembayaran jika bayar manual 0
        }
    } else if (method === 'QRIS') {
        bayar = finalTotal; 
        change = 0;
        if ($("qrisModal").style.display === 'flex') {
            // Tutup modal QRIS jika dipanggil dari konfirmasi
            $("qrisModal").style.display="none";
        }
    } else { 
        // Online Payment (Gojek, Grab, Shopee)
        bayar = finalTotal;
        change = 0; 
    }
    
    // TUTUP SEMUA MODAL
    $("paymentModal").style.display="none";
    $("qrisModal").style.display="none";
    
    if (method === 'Cash' && change > 0) {
        alert("Pembayaran Tunai sukses.\nKembalian: "+formatRp(change));
    } else if (method !== 'Cash') {
        alert("Pembayaran "+method+" sukses!");
    } else {
        alert("Pembayaran Tunai Pas sukses!");
    }
    
    const customerNote = $("customerNote").value.trim() || orderType;
    const queueNumber = getDailyQueueNumber(); // REVISI 4: Ambil nomor antrian
    
    saveTransaction(subtotal, totalDiscount, finalTotal, customerNote, method, queueNumber);
    
    // PERMINTAAN 6 & 7: Cetak Struk 2 kali (Customer dan Kasir)
    printStruk(subtotal, totalDiscount, finalTotal, bayar, change, customerNote, method, queueNumber, "Customer");
    printStruk(subtotal, totalDiscount, finalTotal, bayar, change, customerNote, method, queueNumber, "Kasir");
    
    cart=[];
    renderOrders();
    $("customerNote").value = "";
    openOrderType();
}
// REVISI 4: Tambahkan queueNumber ke data transaksi
function saveTransaction(subtotal, totalDiscount, finalTotal, customerNote, paymentMethod, queueNumber){
    store.transactions.push({
        id:Date.now(),
        user:currentUser.email,
        orderType,
        paymentMethod,
        queueNumber, // REVISI 4: Simpan queueNumber
        items: cart.map(item => ({ 
            name: item.name, 
            price: item.price, 
            qty: item.qty, 
            category: item.category,
            baseMenuName: item.baseMenuName,
            // REVISI 1: Hapus discountPercent jika tidak digunakan
            discountAmount: item.discountAmount, 
            finalPrice: item.finalPrice 
        })),
        subtotal: subtotal,
        discount: null,
        discountAmount: totalDiscount,
        total: finalTotal,
        date:new Date().toISOString(),
        note: customerNote // REVISI 4: Simpan customerNote
    });
    saveStore();
}

// REVISI 4: Fungsi untuk mendapatkan singkatan kategori
const getAbbr = (cat) => {
    if (cat === 'Large') return 'L';
    if (cat === 'Reguler') return 'R';
    if (cat === 'Separuh') return 'S';
    if (cat === 'Extra') return 'EX';
    return '';
}

// REVISI 4: Tambahkan queueNumber ke parameter
function printStruk(subtotal, totalDiscount, finalTotal, bayar, kembali, note, paymentMethod, queueNumber, copyType){
    const now = new Date().toLocaleString("id-ID");
    
    // REVISI 4: Memodifikasi createStrukLine untuk menyingkat kategori
    const createStrukLine = (item) => {
        const totalStr = formatRp(item.finalPrice).padStart(8); // Dikecilkan untuk 30

        let printName = item.name; 
        const abbr = getAbbr(item.category);
        if (abbr) {
            // Ganti kategori lengkap dengan singkatan di dalam kurung
            const regex = new RegExp(`\\(${item.category}\\)`, 'i');
            printName = printName.replace(regex, `(${abbr})`);
        }
        
        // Batasi nama item untuk padding
        const namePart = `${printName.substring(0, MAX_WIDTH - 11)} x${item.qty}`; 
        
        const space = MAX_WIDTH - namePart.length - totalStr.length;
        let line = `${namePart}${Array(space > 0 ? space : 1).join('.')}${totalStr}`;
        
        if (item.discountAmount > 0) {
            // REVISI 1: Ubah tampilan diskon menjadi angka Rupiah
            const discountStr = ` Disc: -${formatRp(item.discountAmount).padStart(8)}`;
            line += `\n${discountStr.padStart(MAX_WIDTH)}`;
        }
        return line;
    }
    const itemDetails = cart.map(i => createStrukLine(i)).join('\n');
    
    const kasirLine = padLine("Kasir: ", currentUser ? currentUser.email : "-");
    const dateLine = padLine("Waktu: ", now);
    const noteLine = padLine("Catatan: ", note);
    const paymentLine = padLine("Bayar dg: ", paymentMethod);
    const totalLine = padLine("TOTAL AKHIR: ", formatRp(finalTotal));
    const bayarLine = paymentMethod === 'Cash' ? padLine("Bayar: ", formatRp(bayar)) : '';
    const kembaliLine = (paymentMethod === 'Cash' && kembali > 0) ? padLine("Kembali: ", formatRp(kembali)) : '';
    const discountLine = totalDiscount > 0 ? padLine("Diskon Total: ", formatRp(totalDiscount)) : '';
    
    // REVISI 4: Tambahkan nomor antrian
    const antrianLine = padLine("No. Antrian: ", `#${queueNumber}`);

    const w=window.open("","_blank");
    w.document.write(`
        <pre style='font-family:monospace; font-size: 10px; line-height: 1.2; width: 58mm; max-width: 58mm;'>
 === JIF PIZZA CONDET ===
 ${antrianLine}
 ${kasirLine}
 ${dateLine}
 ${noteLine}
 ${'______________________________'.substring(0, MAX_WIDTH)}
 ${itemDetails.trim()}
 ${'______________________________'.substring(0, MAX_WIDTH)}
 ${discountLine}
 ${padLine("Subtotal Kotor: ", formatRp(subtotal))}
 ${totalLine}
 ${paymentLine}
 ${bayarLine}
 ${kembaliLine}
 ${'______________________________'.substring(0, MAX_WIDTH)}
 ${padLine("Copy Type: ", copyType)}
 ==============================
     TERIMA KASIH TELAH ORDER
 ==============================
        </pre>
    `);
    
    w.print();
}

// REVISI 2: Perbaiki masalah escaping dengan JSON.stringify lalu parse ulang
function reprintTransaction(transactionStr){
    // Parsing string JSON kembali menjadi objek
    const transaction = JSON.parse(transactionStr);
    
    const tempCart = transaction.items.map(item => ({ 
        name: item.name, 
        price: item.price, 
        qty: item.qty, 
        category: item.category,
        baseMenuName: item.baseMenuName,
        discountAmount: item.discountAmount || 0, 
        finalPrice: item.finalPrice 
    }));
    const isCash = transaction.paymentMethod === 'Cash';
    const finalTotal = transaction.total;
    // Karena data bayar dan kembali tidak disimpan, kita asumsikan Bayar = Total Akhir jika non-Cash.
    const bayar = isCash ? (transaction.subtotal || transaction.total) : finalTotal;
    const kembali = isCash ? (bayar - finalTotal) : 0;
    
    // Simpan cart lama
    const originalCart = [...cart];
    cart = tempCart; 
    
    // Panggil fungsi cetak ganda. Ambil note dan queueNumber dari transaksi.
    printStruk(
        transaction.subtotal || finalTotal, 
        transaction.discountAmount || 0, 
        finalTotal, 
        bayar, 
        kembali, 
        transaction.note || transaction.orderType, 
        transaction.paymentMethod, 
        transaction.queueNumber || 0, // REVISI 4: Ambil queueNumber dari transaksi
        "Customer (REPRINT)"
    );
    printStruk(
        transaction.subtotal || finalTotal, 
        transaction.discountAmount || 0, 
        finalTotal, 
        bayar, 
        kembali, 
        transaction.note || transaction.orderType, 
        transaction.paymentMethod, 
        transaction.queueNumber || 0, // REVISI 4: Ambil queueNumber dari transaksi
        "Kasir (REPRINT)"
    );
    
    // Kembalikan cart ke keadaan semula
    cart = originalCart;
    alert("Cetak ulang selesai!");
}

// ======================================================================
// FUNGSI MANAJEMEN MENU & DISKON
// ======================================================================
function addMenu(){
    if (currentUser.role !== 'Manager') return alert("Akses ditolak. Hanya Manajer yang bisa menambah menu.");

    const name = $("mName").value.trim();
    const category = $("mCategory").value;
    const priceOffline = Number($("mPriceOffline").value);
    const markupGojek = Number($("mGojekMarkup").value);
    const markupGrab = Number($("mGrabMarkup").value);
    const markupShopee = Number($("mShopeeMarkup").value);
    if (!name || !category || priceOffline <= 0) {
        return alert("Nama, Kategori, dan Harga Offline harus diisi dengan benar.");
    }
    
    // Buat nama unik untuk mencari menu
    const uniqueName = `${name} (${category})`; 
    
    if (store.menus.find(m => m.uniqueName === uniqueName)) {
        return alert(`Menu dengan nama "${uniqueName}" sudah ada.`);
    }

    const newMenu = {
        uniqueName,
        baseMenuName: name, // Nama menu tanpa kategori
        category,
        priceOffline,
        markupGojek,
        markupGrab,
        markupShopee,
        addedBy: currentUser.email,
        dateAdded: new Date().toISOString()
    };
    
    store.menus.push(newMenu);
    saveStore();
    renderMenuEditor(); 
    alert(`Menu "${uniqueName}" berhasil ditambahkan.`);
    
    $("mName").value = "";
    $("mCategory").value = "";
    $("mPriceOffline").value = "";
    $("mGojekMarkup").value = "";
    $("mGrabMarkup").value = "";
    $("mShopeeMarkup").value = "";
}
function deleteMenu(uniqueName){
    if (currentUser.role !== 'Manager') return alert("Akses ditolak.");
    if (confirm(`Yakin ingin menghapus menu ${uniqueName}?`)) {
        store.menus = store.menus.filter(m => m.uniqueName !== uniqueName);
        saveStore();
        renderMenuEditor();
        alert(`Menu ${uniqueName} berhasil dihapus.`);
    }
}

function renderMenuEditor(){
    if (currentUser.role !== 'Manager') {
        $("menuEditor").innerHTML = "<p>Anda tidak memiliki akses ke fitur ini.</p>";
        return;
    }
    const root=$("menuEditor");
    root.innerHTML="<h4 style='margin-top: 20px;'>Daftar Menu Tersedia:</h4>";
    
    if(store.menus.length===0){
        root.innerHTML+="<p>Belum ada menu yang terdaftar.</p>";
        return;
    }
    
    const table = document.createElement('table');
    table.className = 'report-table';
    table.innerHTML = `
        <thead>
            <tr>
                <th>Nama Menu</th>
                <th>Offline (Rp)</th>
                <th>Gojek Markup (Rp)</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;
    const tbody = table.querySelector('tbody');
    
    store.menus.sort((a, b) => (a.uniqueName > b.uniqueName) ? 1 : -1).forEach(m => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${m.uniqueName}</td>
            <td>${formatRp(m.priceOffline)}</td>
            <td>+${formatRp(m.markupGojek)}</td>
            <td><button class='btn danger' onclick="deleteMenu('${m.uniqueName.replace(/'/g, "\\'")}')">Hapus</button></td>
        `;
    });
    
    root.appendChild(table);
}
// ======================================================================
// FUNGSI TRANSAKSI & LAPORAN
// ======================================================================
function deleteTransaction(id){
    if (currentUser.role !== 'Manager') return alert("Akses ditolak. Hanya Manajer yang dapat menghapus transaksi.");
    if (confirm("Yakin ingin menghapus transaksi ini? Aksi ini tidak dapat dibatalkan.")) {
        store.transactions = store.transactions.filter(t => t.id !== id);
        saveStore();
        showReport('today'); // Reload laporan
        alert("Transaksi berhasil dihapus.");
    }
}

// ======================================================================
// FUNGSI LAPORAN, GRAFIK, DAN CETAK
// ======================================================================
function getFilteredTransactions(filterType = null, dateInputTrigger = false) {
    const today = getDateOnly(new Date().toISOString());
    const yesterday = today - 86400000; // 24 hours in ms
    const selectedDateValue = $("reportDate").value;
    
    let filteredTrx = [];
    let reportPeriod = "Hari Ini";

    if (dateInputTrigger && selectedDateValue) {
        const selectedDate = getDateOnly(selectedDateValue);
        filteredTrx = store.transactions.filter(t => getDateOnly(t.date) === selectedDate);
        reportPeriod = new Date(selectedDate).toLocaleDateString("id-ID", { day: 'numeric', month: 'long', year: 'numeric' });
    } else if (filterType === 'yesterday') {
        filteredTrx = store.transactions.filter(t => getDateOnly(t.date) === yesterday);
        reportPeriod = "Kemarin";
    } else if (filterType === 'month') {
        const currentMonth = new Date().getMonth();
        const currentYear = new Date().getFullYear();
        filteredTrx = store.transactions.filter(t => {
            const d = new Date(t.date);
            return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
        });
        reportPeriod = "Bulan Ini";
    } else { // 'today' or default
        filteredTrx = store.transactions.filter(t => getDateOnly(t.date) === today);
        reportPeriod = "Hari Ini";
    }
    
    return { filteredTrx, reportPeriod };
}
function showReport(filterType = 'today', dateInputTrigger = false){
    const { filteredTrx, reportPeriod } = getFilteredTransactions(filterType, dateInputTrigger);

    let totalSales = 0;
    let totalDiscount = 0;
    let totalSubtotal = 0;
    let salesByOutlet = {};
    let salesByPayment = {};

    filteredTrx.forEach(t => {
        totalSales += t.total;
        totalDiscount += t.discountAmount;
        totalSubtotal += t.subtotal;

        const outlet = t.orderType || 'Offline';
        const method = t.paymentMethod || 'Cash';
        
        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;
        salesByPayment[method] = (salesByPayment[method] || 0) + t.total;
    });

    // Update Nav Button Active State
    document.querySelectorAll('#laporanPage .navbar button').forEach(btn => btn.classList.remove('active-tab'));
    if (!dateInputTrigger) {
        const activeBtn = document.querySelector(`#laporanPage button[onclick="showReport('${filterType}')"]`);
        if(activeBtn) activeBtn.classList.add('active-tab');
    }

    $("laporanSummary").innerHTML = `
        <div class="summary-card card-sales"><h4>Total Penjualan Akhir</h4><div class="value">${formatRp(totalSales)}</div></div>
        <div class="summary-card card-count"><h4>Jumlah Transaksi</h4><div class="value">${filteredTrx.length} Nota</div></div>
        <div class="summary-card card-subtotal"><h4>Subtotal Kotor</h4><div class="value">${formatRp(totalSubtotal)}</div></div>
        <div class="summary-card card-discount"><h4>Total Diskon</h4><div class="value">-${formatRp(totalDiscount)}</div></div>
    `;

    // Render Detail Outlet & Pembayaran
    const sortedOutlet = Object.entries(salesByOutlet).sort(([, a], [, b]) => b - a);
    const sortedPayment = Object.entries(salesByPayment).sort(([, a], [, b]) => b - a);

    $("laporanDetailSummary").innerHTML = `
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">
                <h4>By Outlet/Platform (${reportPeriod})</h4>
                <ul class="detail-list">
                    ${sortedOutlet.map(([outlet, total]) => `<li><span>${outlet}</span><span>${formatRp(total)}</span></li>`).join('')}
                </ul>
            </div>
            <div style="flex: 1;">
                <h4>By Payment Method (${reportPeriod})</h4>
                <ul class="detail-list">
                    ${sortedPayment.map(([method, total]) => `<li><span>${method}</span><span>${formatRp(total)}</span></li>`).join('')}
                </ul>
            </div>
        </div>
    `;

    renderSalesByMenu(filteredTrx);
    renderLaporanList(filteredTrx);
    renderSalesChart(filteredTrx, filterType);
}
function renderSalesChart(filteredTrx, filterType = 'today') {
    if (salesChartInstance) salesChartInstance.destroy();

    let salesData = {};
    let labelFormat = { month: 'short', day: 'numeric' };

    if (filterType === 'month') {
        labelFormat = { day: 'numeric' };
        filteredTrx.forEach(t => {
            const date = new Date(t.date).getDate();
            salesData[date] = (salesData[date] || 0) + t.total;
        });
    } else { // Today, Yesterday, or Specific Day
        labelFormat = { hour: '2-digit', minute: '2-digit' };
        filteredTrx.forEach(t => {
            const time = new Date(t.date).toLocaleTimeString("id-ID", labelFormat);
            salesData[time] = (salesData[time] || 0) + t.total;
        });
    }

    const labels = Object.keys(salesData).sort();
    const data = labels.map(label => salesData[label]);

    const ctx = $("salesChart").getContext('2d');
    salesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Penjualan Akhir (Rp)',
                data: data,
                backgroundColor: 'rgba(46, 125, 50, 0.8)', // Green
                borderColor: 'rgba(46, 125, 50, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}
function renderSalesByMenu(filteredTrx) {
    const root = $("salesByMenu");
    root.innerHTML = "";
    
    let menuMix = {};
    
    filteredTrx.forEach(t => {
        t.items.forEach(item => {
            const name = item.name;
            const itemTotal = item.finalPrice;
            menuMix[name] = menuMix[name] || { qty: 0, finalSales: 0 };
            menuMix[name].qty += item.qty;
            menuMix[name].finalSales += itemTotal;
        });
    });

    if (Object.keys(menuMix).length === 0) {
        root.innerHTML = "<p>Belum ada item terjual.</p>";
        return;
    }
    
    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty);
    
    const ul = document.createElement('ul');
    ul.className = 'detail-list';
    ul.style.marginTop = '0'; 
    ul.style.background = 'none';
    ul.style.padding = '0';
    
    sortedMenu.forEach(([name, data]) => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span>${name} (${data.qty}x)</span>
            <span>${formatRp(data.finalSales)}</span>
        `;
        ul.appendChild(li);
    });
    
    root.appendChild(ul);
}
function renderLaporanList(filteredTrx) {
    const root=$("laporanList");
    root.innerHTML="";
    
    if(filteredTrx.length===0){
        root.innerHTML="<p>Tidak ada transaksi pada periode ini.</p>";
        return;
    }
    
    const table=document.createElement('table');
    table.className='report-table';
    table.innerHTML=`
        <thead>
            <tr>
                <th>ID/Antrian</th>
                <th>Waktu</th>
                <th>Catatan</th> 
                <th>Total Akhir</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    `;
    const tbody=table.querySelector('tbody');
    
    filteredTrx.sort((a, b) => b.id - a.id).forEach(t => {
        const row=tbody.insertRow();
        const dateStr = new Date(t.date).toLocaleString("id-ID", { 
            day: '2-digit', month: 'short', hour: '2-digit', minute: '2-digit' 
        }).replace('.', ':');
        // REVISI 4: Tampilkan ID dan Nomor Antrian
        const antrianDisplay = t.queueNumber ? `#${t.queueNumber}` : 'N/A';
        const idDisplay = t.id.toString().slice(-4);
        
        row.innerHTML=`
            <td>${idDisplay} / ${antrianDisplay}</td>
            <td>${dateStr}</td>
            <td>${t.note || t.orderType}</td> 
            <td>${formatRp(t.total)}</td>
            <td>
                <button class='btn secondary' style="font-size: 0.8em; padding: 5px;" onclick="reprintTransaction('${JSON.stringify(t).replace(/'/g, "\\'")}')">Cetak Ulang</button>
                ${currentUser && currentUser.role === 'Manager' ? `<button class='btn danger' style="font-size: 0.8em; padding: 5px; margin-left: 5px;" onclick="deleteTransaction(${t.id})">Hapus</button>` : ''}
            </td>
        `;
    });
    
    root.appendChild(table);
}
// PERMINTAAN 5: Revisi fungsi printClosing untuk 58mm (MAX_WIDTH 30)
function printClosing(){
    const today = new Date().toLocaleDateString("id-ID");
    const trx = store.transactions.filter(t => new Date(t.date).toLocaleDateString("id-ID") === today);
    if(trx.length === 0) return alert("Tidak ada transaksi hari ini untuk dicetak.");

    let totalSales = 0;
    let totalDiscount = 0;
    let totalSubtotal = 0;
    let salesByPayment = {};
    let menuMix = {};

    trx.forEach(t => {
        totalSales += t.total;
        totalDiscount += t.discountAmount;
        totalSubtotal += t.subtotal;

        const method = t.paymentMethod || 'Cash';
        salesByPayment[method] = (salesByPayment[method] || 0) + t.total;

        t.items.forEach(item => {
            const name = item.name;
            const itemTotal = item.finalPrice; // Sudah bersih dari diskon
            menuMix[name] = menuMix[name] || { qty: 0, finalSales: 0 };
            menuMix[name].qty += item.qty;
            menuMix[name].finalSales += itemTotal;
        });
    });
    
    const sortedPayment = Object.entries(salesByPayment).sort(([, a], [, b]) => b - a);
    const paymentDetail = sortedPayment.map(([method, total]) => padLine(method, formatRp(total))).join('\n');
    
    // REVISI 4: Fungsi untuk mendapatkan singkatan kategori (diambil dari printStruk)
    const getAbbr = (cat) => {
        if (cat === 'Large') return 'L';
        if (cat === 'Reguler') return 'R';
        if (cat === 'Separuh') return 'S';
        if (cat === 'Extra') return 'EX';
        return '';
    }
    
    // REVISI 4: Modifikasi createReportLine untuk menyingkat kategori
    const createReportLine = (name, data) => {
        const totalRpStr = formatRp(data.finalSales).padStart(8);
        
        let printName = name; 
        const categories = ['Large', 'Reguler', 'Separuh', 'Extra'];
        const abbrMap = {'Large': 'L', 'Reguler': 'R', 'Separuh': 'S', 'Extra': 'EX'};

        categories.forEach(cat => {
            if (name.includes(`(${cat})`)) {
                printName = name.replace(`(${cat})`, `(${abbrMap[cat]})`);
            }
        });
        
        const namePart = `${printName.substring(0, MAX_WIDTH - 11)} x${data.qty}`;
        const space = MAX_WIDTH - namePart.length - totalRpStr.length;
        return `${namePart}${Array(space > 0 ? space : 1).join('.')}${totalRpStr}`;
    };

    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty);
    const menuDetail = sortedMenu.map(([name, data]) => createReportLine(name, data)).join('\n');
    const w=window.open("","_blank");
    const kasirLine = padLine("Manajer/Kasir: ", currentUser ? currentUser.email : "-");
    const dateLine = padLine("Tanggal Cetak: ", new Date().toLocaleString("id-ID"));
    const totalTrxLine = padLine("Total Transaksi: ", `${trx.length} Nota`);

    w.document.write(`
        <pre style='font-family:monospace; font-size: 10px; line-height: 1.2; width: 58mm; max-width: 58mm;'>
 === CLOSING REPORT HARIAN ===
 Outlet: JIF PIZZA CONDET
 ${kasirLine}
 ${dateLine}
 ${'______________________________'.substring(0, MAX_WIDTH)}
 RINGKASAN PENJUALAN
 ${totalTrxLine}
 ${padLine("Subtotal Kotor: ", formatRp(totalSubtotal))}
 ${padLine("Diskon Total: ", formatRp(totalDiscount))}
 ${padLine("TOTAL PENJUALAN AKHIR: ", formatRp(totalSales))}
 ${'______________________________'.substring(0, MAX_WIDTH)}
 SALES BY PAYMENT METHOD
 ${paymentDetail}
 ${'______________________________'.substring(0, MAX_WIDTH)}
 SALES BY MENU (PRODUCT MIX)
 ${menuDetail.trim()}
 ${'______________________________'.substring(0, MAX_WIDTH)}
 ==============================
 TERIMA KASIH, LAPORAN SELESAI
        </pre>
    `);
    w.print();
}
// PERMINTAAN 5: Revisi fungsi printReport untuk 58mm (MAX_WIDTH 30)
function printReport() {
    const dateInputTrigger = $("reportDate").value ? true : false;
    let activeFilter = 'today'; 
    let reportPeriod = 'Hari Ini';
    
    if (dateInputTrigger) {
        // Jika input tanggal diisi, override filterType
        activeFilter = 'custom';
    } else {
        // Cek tombol aktif di UI untuk menentukan activeFilter jika tidak ada input tanggal
        const activeBtn = document.querySelector('#laporanPage .navbar button.active-tab');
        if (activeBtn) {
            if (activeBtn.innerText === 'Kemarin') activeFilter = 'yesterday';
            else if (activeBtn.innerText === 'Bulan Ini') activeFilter = 'month';
            else activeFilter = 'today'; 
        }
    }
    
    // Mendapatkan data transaksi
    const { filteredTrx, reportPeriod: period } = getFilteredTransactions(activeFilter, dateInputTrigger);
    reportPeriod = period; 
    
    if(filteredTrx.length === 0) return alert("Tidak ada transaksi untuk periode ini.");
    
    let totalSales = 0;
    let totalDiscount = 0;
    let totalSubtotal = 0;
    let salesByOutlet = {};
    let menuMix = {};

    filteredTrx.forEach(t => {
        totalSales += t.total;
        totalDiscount += t.discountAmount;
        totalSubtotal += t.subtotal;

        const outlet = t.orderType || 'Offline';
        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;

        t.items.forEach(item => {
            const name = item.name;
            const itemTotal = item.finalPrice;
            menuMix[name] = menuMix[name] || { qty: 0, finalSales: 0 };
            menuMix[name].qty += item.qty;
            menuMix[name].finalSales += itemTotal;
        });
    });

    const sortedOutlet = Object.entries(salesByOutlet).sort(([, a], [, b]) => b - a);
    const outletDetail = sortedOutlet.map(([outlet, total]) => padLine(outlet, formatRp(total))).join('\n');

    // REVISI 4: Fungsi untuk mendapatkan singkatan kategori (diambil dari printClosing)
    const getAbbr = (cat) => {
        if (cat === 'Large') return 'L';
        if (cat === 'Reguler') return 'R';
        if (cat === 'Separuh') return 'S';
        if (cat === 'Extra') return 'EX';
        return '';
    }
    
    // REVISI 4: Modifikasi createReportLine untuk menyingkat kategori (diambil dari printClosing)
    const createReportLine = (name, data) => {
        const totalRpStr = formatRp(data.finalSales).padStart(8);
        
        let printName = name; 
        const categories = ['Large', 'Reguler', 'Separuh', 'Extra'];
        const abbrMap = {'Large': 'L', 'Reguler': 'R', 'Separuh': 'S', 'Extra': 'EX'};

        categories.forEach(cat => {
            if (name.includes(`(${cat})`)) {
                printName = name.replace(`(${cat})`, `(${abbrMap[cat]})`);
            }
        });
        
        const namePart = `${printName.substring(0, MAX_WIDTH - 11)} x${data.qty}`;
        const space = MAX_WIDTH - namePart.length - totalRpStr.length;
        return `${namePart}${Array(space > 0 ? space : 1).join('.')}${totalRpStr}`;
    };

    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty);
    const menuDetail = sortedMenu.map(([name, data]) => createReportLine(name, data)).join('\n');
    
    const w=window.open("","_blank");
    
    const kasirLine = padLine("Manajer/Kasir: ", currentUser ? currentUser.email : "-");
    const dateLine = padLine("Tanggal Cetak: ", new Date().toLocaleString("id-ID"));
    const totalTrxLine = padLine("Total Transaksi: ", `${filteredTrx.length} Nota`);

    w.document.write(`
        <pre style='font-family:monospace; font-size: 10px; line-height: 1.2; width: 58mm; max-width: 58mm;'>
        
 === LAPORAN PENJUALAN PERIODE ===
        
 Outlet: JIF PIZZA CONDET
 Periode: ${reportPeriod}
${kasirLine}
${dateLine}
        
${'______________________________'.substring(0, MAX_WIDTH)} 
RINGKASAN PENJUALAN
${totalTrxLine}
${padLine("Subtotal Kotor: ", formatRp(totalSubtotal))}
${padLine("Diskon Total: ", formatRp(totalDiscount))}
${padLine("TOTAL PENJUALAN AKHIR: ", formatRp(totalSales))}

${'______________________________'.substring(0, MAX_WIDTH)}
SALES BY OUTLET
${outletDetail}

${'______________________________'.substring(0, MAX_WIDTH)}
SALES BY MENU (PRODUCT MIX)
${menuDetail.trim()}
${'______________________________'.substring(0, MAX_WIDTH)}
==============================
LAPORAN SELESAI
        </pre>
    `);
    
    w.print();
}
const padLine = (label, value) => {
    const valStr = String(value);
    const labelLen = label.length;
    const space = MAX_WIDTH - labelLen - valStr.length;
    return `${label}${Array(space > 0 ? space : 1).join('.')}${valStr}`;
};
window.onload=()=>{
  if (currentUser) {
    activateTab('home');
  } else {
    showLogin();
  }
}
</script>
</body>
</html>
