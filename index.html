<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JIF PIZZA POS v10.3 ‚Äî Final Rev</title>
<link rel="icon" href="logo.png"/>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="JIF POS">
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="logo.png">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 
<style>
/* CSS */
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:#222}
.hidden{display:none}
header.hidden, .navbar.hidden { display: none !important; }

/* REVISI 1: Aturan responsif umum */
.container { 
    padding: 14px; 
    max-width: 100%; /* Pastikan tidak melebihi lebar layar */
    box-sizing: border-box; /* Padding dihitung di dalam lebar */
}
input, select { 
    box-sizing: border-box; /* Input dan select juga dihitung di dalam lebar */
}
/* END REVISI 1 */
/* LATAR BELAKANG GAMBAR HEADER (pizza.jpg) */
header{
  background:url('pizza.jpg') center/cover no-repeat; 
  color:#fff;
  padding:12px;
  text-align:center;
  position: relative; 
  z-index: 1; 
  height: 80px;
  overflow: hidden; 
}
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); 
    z-index: 1; 
} 
header h1, header p {
    position: relative; 
    z-index: 2; 
}
header h1{margin:0;font-size:22px}
header p{margin:4px 0 0 0;font-size:14px}
/* Gaya Tombol 3D */
.navbar button, .btn {
    padding: 10px 16px; 
    border: none;
    border-radius: 8px; 
    cursor: pointer;
    font-weight: 600;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08); 
    background: linear-gradient(145deg, #f0f0f0, #e0e0e0); 
    color: #333;
    /* REVISI 2: Teks Tombol Tengah */
    display: flex;
    align-items: center; /* Pusat Vertikal */
    justify-content: center; /* Pusat Horizontal */
    text-align: center; /* Cadangan */
}
.navbar button:hover, .btn:hover {
    transform: translateY(-1px); 
    box-shadow: 0 6px 10px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
}
.navbar button:active, .btn:active {
    transform: translateY(1px); 
    box-shadow: 0 2px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.08);
}
/* Gaya spesifik untuk tombol primary (merah) */
.btn.primary, .navbar button.primary-nav { 
    background: linear-gradient(145deg, #e57373, #d32f2f);
    color: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.secondary, .navbar button.secondary-nav { 
    background: linear-gradient(145deg, #64b5f6, #1976d2);
    color: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.danger, .navbar button.danger-nav { 
    background: linear-gradient(145deg, #ef5350, #c62828);
    color: #fff;
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
/* GAYA TAB AKTIF (Merah) */
.navbar button.active-tab {
    background: linear-gradient(145deg, #d32f2f, #e57373);
    color: #fff;
    box-shadow: 0 0 5px rgba(217, 73, 73, 0.7); 
    transform: none; 
}
.navbar{background:#fff;display:flex;justify-content:center;gap:8px;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1); overflow-x: auto;} /* REVISI 1: Tambah overflow-x: auto */
.container{padding:14px}
#loginPage {
    max-width: 400px; 
    margin: 40px auto; 
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
/* REVISI 1: Menu Grid lebih fleksibel di HP */
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(100px,1fr));gap:10px}
.menu-item{border:1px solid #ccc;border-radius:8px;padding:8px;text-align:center;cursor:pointer}
.menu-item {
    background: #fdfdfd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.1s ease-in-out;
    /* REVISI 1: Pastikan konten tidak terpotong */
    word-wrap: break-word; 
    overflow: hidden;
    font-size: 0.9em;
}
.menu-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
/* NEW: Gaya Order Item Detail (untuk tombol Hapus) */
.order-item-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px dashed #eee;
    flex-wrap: nowrap; /* REVISI 1: Jangan wrap agar rapi di HP */
    overflow-x: auto; /* Tambahkan scroll jika konten terlalu lebar */
}
.order-item-detail > div {
    flex-shrink: 0; /* Pastikan elemen div tidak menyusut paksa */
}
.order-item-detail .delete-btn {
    padding: 3px 6px;
    font-size: 0.7em;
    margin-left: 10px;
    box-shadow: none;
    flex-shrink: 0;
}
/* Gaya untuk input diskon per item (REVISI 1: Lebihkan sedikit untuk Rupiah) */
.item-discount-input {
    width: 60px; /* Diperkecil lagi */
    padding: 3px;
    font-size: 0.8em; /* Diperkecil */
    text-align: right;
    margin: 0 5px;
    flex-shrink: 0;
}
.order-box{margin-top:12px;padding:10px;border-top:2px solid #ccc}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:100;display:none}
.modal{
  background:white;
  padding:20px;
  border-radius:10px;
  text-align:center;
  max-width:90%; /* REVISI 1: Maksimal 90% lebar layar */
  width:90%;
  display: flex; 
  flex-direction: column; 
  gap: 10px; 
} 
/* Tambahan untuk tata letak tombol payment di modal */
.modal .payment-method-grid {
    display: grid;
    grid-template-columns: 1fr 1fr; /* 2 kolom */
    gap: 8px; 
}
input, select{padding:8px;border:1px solid #ccc;border-radius:6px;width:100%;margin:4px 0}
/* REVISI 1: Table Responsif */
.report-table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 15px; 
    font-size: 0.8em; /* Dikecilkan */
}
.report-table th, .report-table td { 
    border: 1px solid #ddd; 
    padding: 5px; /* Dikecilkan */
    text-align: left; 
    word-wrap: break-word;
}
.report-table th { background-color: #f2f2f2; }
/* REVISI 1: Div untuk membuat tabel bisa digulir secara horizontal */
.table-container { 
    overflow-x: auto; 
    width: 100%; 
    box-sizing: border-box;
}
/* END REVISI 1 */
#homePage img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: block;
    margin: 0 auto 20px auto; 
}
/* NEW: Gaya Kotak Ringkasan Laporan */
.report-summary-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); /* REVISI 1: Dikecilkan lagi */
    gap: 10px;
    margin-top: 15px;
}
.summary-card {
    background: #fff;
    padding: 10px; /* Dikecilkan */
    border-radius: 8px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border-left: 5px solid; /* Akan diubah sesuai tipe */
    text-align: left;
}
.summary-card h4 {
    margin: 0 0 5px 0;
    font-size: 0.7em; /* Dikecilkan */
    color: #666;
    text-transform: uppercase;
    line-height: 1.2;
}
.summary-card .value {
    font-size: 1.1em; /* Dikecilkan */
    font-weight: 700;
}
/* Warna spesifik untuk border card */
.card-sales { border-left-color: #2e7d32; } 
.card-count { border-left-color: #1976d2; } 
.card-subtotal { border-left-color: #fbc02d; } 
.card-discount { border-left-color: #d32f2f; } 

/* Gaya untuk detail outlet/metode bayar di laporan */
.detail-list {
    list-style: none;
    padding-left: 0;
    margin-top: 5px;
    background: #f9f9f9;
    padding: 10px;
    border-radius: 6px;
    font-size: 0.9em; /* Dikecilkan */
}
.detail-list li {
    padding: 5px 0;
    border-bottom: 1px dashed #ddd;
    display: flex;
    justify-content: space-between;
    font-size: 0.9em;
}
.detail-list li:last-child {
    border-bottom: none;
}
/* REVISI 1: Tata Letak Detail Summary di Laporan */
#laporanDetailSummary > div {
    flex-direction: column; /* Ubah menjadi kolom di layar kecil */
    gap: 10px !important;
}

/* Print style untuk 58mm */
@media print {
    body { 
        width: 58mm; /* Ukuran Printer 58mm */
        margin: 0; 
        padding: 0; 
        font-family: 'Courier New', Courier, monospace !important; 
        font-size: 12px !important; /* Dikecilkan sedikit agar muat */
    }
    pre { 
        width: 58mm !important; 
        max-width: 58mm !important; 
        font-family: 'Courier New', Courier, monospace !important; 
    }
}
</style>
</head>
<body>
<header id="appHeader" class="hidden"> 
  <h1>üçï JIF PIZZA CONDET</h1>
  <p id="userRoleDisplay">Mode Offline</p>
</header>
<div id="appNavbar" class="navbar hidden"> 
</button>
  <button id="nav-home" class="secondary-nav" onclick="activateTab('home')">Home</button>
  <button id="nav-kasir" class="secondary-nav" onclick="activateTab('kasir')">Kasir</button>
  <button id="nav-menu" class="secondary-nav" onclick="activateTab('menu')">Menu</button> 
  <button id="nav-laporan" class="secondary-nav" onclick="activateTab('laporan');showReport('today')">Laporan</button>
  <button id="nav-logout" class="secondary-nav" onclick="logout()">Logout</button>
<button id="btn-printer-connect" class="secondary-nav" title="Pengaturan Printer" onclick="(btDevice && btDevice.gatt && btDevice.gatt.connected) ? disconnectPrinter() : connectPrinter()">
  <svg width="20" height="20" viewBox="0 0 24 24" style="vertical-align:middle">
    <path fill="currentColor" d="M12 8.6A3.4 3.4 0 1 0 12 15.4 3.4 3.4 0 0 0 12 8.6m7.4 1.5l1.9-1.2-1-1.7-2.2.4a7.6 7.6 0 0 0-1.1-1.1l.4-2.2-1.7-1-1.2 1.9A7.3 7.3 0 0 0 12 3.6 7.3 7.3 0 0 0 8.8 4.2L7.6 2.3 5.9 3.3l.4 2.2a7.6 7.6 0 0 0-1.1 1.1l-2.2-.4-1 1.7 1.9 1.2A7.3 7.3 0 0 0 3.6 12a7.3 7.3 0 0 0 .6 3.2L2.3 16.4l1 1.7 2.2-.4c.3.4.6.8 1.1 1.1l-.4 2.2 1.7 1 1.2-1.9c1 .4 2.1.6 3.2.6s2.2-.2 3.2-.6l1.2 1.9 1.7-1-.4-2.2c.4-.3.8-.6 1.1-1.1l2.2.4 1-1.7-1.9-1.2c.4-1 .6-2.1.6-3.2s-.2-2.2-.6-3.2z"/>
  </svg>
  <span id="printerStatus" style="margin-left:6px">Terputus</span>
</button>
</div>
<div id="loginPage" class="container">
  <h2>Login</h2>
  <input type="email" id="email" placeholder="Email"/>
  <input type="password" id="password" placeholder="Password"/>
  <button class="btn primary" onclick="login()">Login</button>
  <button class="btn secondary" onclick="register()">Daftar (User)</button>
  <p style="font-size: 0.8em; margin-top: 15px; color: #666;">
    *Simulasi Role: Akun baru otomatis menjadi Kasir (User).
    (Akun Manajer sudah terdaftar)
  </p>
</div>
<div id="homePage" class="container hidden">
  <img src="pizza.jpg" alt="JIF Pizza" /> <h2 style="color: #d94949;">Selamat Datang di Jif Pizza!</h2>
  <p style="line-height: 1.6;">
    Ini adalah tempat di mana semangat bertemu dengan peluang. Kami percaya pada potensi setiap individu. Gunakan hari-hari Anda di sini untuk belajar, bertumbuh, dan mengukir prestasi. Jadilah bagian dari resep rahasia kesuksesan kami.
    <br><br>
    Mari mulai memanggang masa depan yang cerah!
  </p>
  <button class="btn primary" onclick="activateTab('kasir')">Mulai Kasir</button>
</div>
<div id="kasirPage" class="container hidden">
  <input type="text" id="customerNote" placeholder="Nama Pelanggan/Driver/Catatan" style="margin-bottom: 10px;"/>
  <div id="orderLabel"></div>
  <div class="navbar" style="margin-top: 10px; box-shadow: none; border: 1px solid #eee; overflow-x: auto; justify-content: flex-start;">
    <button class="secondary-nav" onclick="renderMenus('Semua')">Semua</button>
    <button class="secondary-nav" onclick="renderMenus('Large')">Large</button>
    <button class="secondary-nav" onclick="renderMenus('Reguler')">Reguler</button>
    <button class="secondary-nav" onclick="renderMenus('Separuh')">Separuh</button> 
    <button class="secondary-nav" onclick="renderMenus('Extra')">Extra</button>
  </div>
  <div id="menuList" class="menu-grid" style="margin-top: 10px;"></div>
  
  <div class="order-box">
    <h3>Pesanan</h3>
    <div id="orderList"></div>
    <div style="border-top: 1px solid #ccc; padding: 5px 0; margin-top: 10px;">
        <div id="discountDisplay" style="font-weight: bold; color: #c62828;">Total Diskon: Rp 0</div>
    </div>
    <h3 id="totalDisplay" style="color: #2e7d32; margin-top: 10px;">TOTAL BAYAR: Rp 0</h3> 
    <button class="btn primary" onclick="openPaymentModal()">Bayar & Cetak</button>
  </div>
</div>
<div id="menuPage" class="container hidden">
  <h3>Tambah Menu (Manajer Only)</h3>
  <input id="mName" placeholder="Nama menu (misal: Mix Lovers)"/>
  
  <select id="mCategory">
    <option value="">-- Pilih Ukuran/Kategori --</option>
    <option value="Large">Large Pizza</option>
    <option value="Reguler">Reguler Pizza</option>
    <option value="Separuh">Separuh Pizza</option> 
    <option value="Extra">Extra Topping</option>
  </select>
  
  <input id="mPriceOffline" type="number" placeholder="Harga Jual OFFLINE (Rp)"/>
  <input id="mGojekMarkup" type="number" placeholder="Markup Harga GOJEK/GOPAY (Rp)"/>
  <input id="mGrabMarkup" type="number" placeholder="Markup Harga GRAB/OVO (Rp)"/>
  <input id="mShopeeMarkup" type="number" placeholder="Markup Harga SHOPEEPAY (Rp)"/>
  
  <button class="btn primary" onclick="addMenu()">Tambah</button>
  <div class="table-container">
    <div id="menuEditor"></div>
  </div>
</div>
<div id="laporanPage" class="container hidden">
  <h3>Laporan Penjualan</h3>
  
  <div style="margin-bottom: 15px; border-bottom: 1px solid #eee; padding-bottom: 15px;">
    <label for="reportDate" style="font-weight: bold;">Pilih Tanggal Spesifik:</label>
    <input type="date" id="reportDate" style="width: 100%; display: block; margin-bottom: 10px;"/>
    <button class="btn primary" onclick="showReport(null, true)">Tampilkan Laporan</button>
    <button class="btn secondary" style="margin-top: 10px;" onclick="printReport()">Cetak Laporan</button> 
  </div>
  <div style="display: flex; gap: 10px; margin-bottom: 15px;">
    <button class="btn secondary" onclick="showReport('today')">Hari Ini</button>
    <button class="btn secondary" onclick="showReport('yesterday')">Kemarin</button>
    <button class="btn secondary" onclick="showReport('month')">Bulan Ini</button>
  </div>
  
  <h4 style="margin-top: 20px;">Grafik Penjualan</h4>
  <div style="width: 100%; max-width: 600px; margin: 0 auto;">
    <canvas id="salesChart"></canvas> 
  </div>
  
  <p style="font-weight: bold; margin-top: 20px;">Ringkasan Penjualan:</p>
  <div id="laporanSummary" class="report-summary-grid">
    </div> 
  <h4 style="margin-top: 20px;">Detail Outlet & Pembayaran</h4>
  <div id="laporanDetailSummary">
    </div>
  
  <h4 style="margin-top: 20px;">Sales by Menu (Product Mix)</h4>
  <div id="salesByMenu"></div>

  <h4 style="margin-top: 20px;">Detail Transaksi</h4>
  <div class="table-container">
    <div id="laporanList"></div>
  </div>
</div>
<div class="overlay" id="orderTypeOverlay">
  <div class="modal">
    <h3>Pilih Tipe Order</h3>
    <button class="btn primary" onclick="setOrderType('Offline')">Order Offline (Tunai/QRIS)</button>
    <h4 style="margin: 10px 0;">Order Online (Pilih Platform)</h4>
    <button class="btn secondary" onclick="setOrderType('Gojek')">Gojek/Gopay</button>
    <button class="btn secondary" onclick="setOrderType('Grab')">Grab/OVO</button>
    <button class="btn secondary" onclick="setOrderType('Shopee')">Bayar ShopeePay</button>
  </div>
</div>

<div class="overlay" id="paymentModal">
  <div class="modal">
    <h3 id="modalTotal">Total Akhir: Rp 0</h3>
    <input type="number" id="manualBayar" placeholder="Nominal Bayar Tunai"/>
    <button class="btn primary" onclick="processManualPayment()">Bayar Tunai & Cetak Struk</button>
    
    <h4 style="margin: 10px 0;">Pilih Metode Bayar:</h4>
    <div class="payment-method-grid"> 
        <button class="btn secondary" id="pay-cash-pas" onclick="completePayment('Cash', currentFinalTotal)">Bayar Pas (Tunai)</button>
        <button class="btn secondary" id="pay-qris" onclick="openQrisModal()">QRIS (Scan Barcode)</button>
        <button class="btn secondary" id="pay-gojek" onclick="completePayment('Gojek')">Bayar Gojek/Gopay</button>
        <button class="btn secondary" id="pay-grab" onclick="completePayment('Grab')">Bayar Grab/OVO</button>
        <button class="btn secondary" id="pay-shopee" onclick="completePayment('Shopee')">Bayar ShopeePay</button>
    </div>
  </div>
</div>
<div class="overlay" id="qrisModal">
  <div class="modal">
    <h3>Scan QRIS Anda</h3>
    <img src="1000208468.jpg" alt="QRIS Payment Baru" style="max-width: 80%; height: auto; margin: 10px auto; display: block;">
    <p>Pastikan pembayaran telah sukses!</p>
    <button class="btn primary" onclick="confirmQrisPayment()">Konfirmasi Pembayaran QRIS</button>
    <button class="btn danger" onclick="$('qrisModal').style.display='none'">Batal</button>
  </div>
</div>
<script>
// ======================================================================
// FUNGSI PWA (SERVICE WORKER & A2HS)
// ======================================================================
if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/sw.js')
      .then(registration => {
        console.log('Service Worker berhasil didaftarkan. Scope:', registration.scope);
      })
      .catch(err => {
        console.log('Gagal mendaftarkan Service Worker:', err);
      });
  });
}
  // ======================================================================
// FUNGSI INTI & UTILITY
// ======================================================================

const STORE_KEY="jif_pos_v10_3"; // Update versi store key
let store=JSON.parse(localStorage.getItem(STORE_KEY)||'{"users":[{"email":"manager@jif.com","password":"123","role":"Manager"}],"menus":[],"transactions":[],"dailyCounter":{}}'); // REVISI 4: Tambah dailyCounter
let currentUser=JSON.parse(localStorage.getItem('currentUser')) || null; 

let orderType=null; 
let cart=[];
let currentFinalTotal = 0; 
let salesChartInstance = null; 

const MAX_WIDTH = 30; 

function saveStore(){
    localStorage.setItem(STORE_KEY,JSON.stringify(store));
}
function formatRp(n){return "Rp "+(n||0).toLocaleString("id-ID");}
function $(id){return document.getElementById(id);}
function getDateOnly(dateString) {
    const d = new Date(dateString);
    return new Date(d.getFullYear(), d.getMonth(), d.getDate()).getTime();
}
function getTodayDateKey() {
    const d = new Date();
    return `${d.getFullYear()}-${d.getMonth() + 1}-${d.getDate()}`;
}
// REVISI 4: Fungsi untuk mendapatkan nomor antrian harian
function getDailyQueueNumber() {
    const todayKey = getTodayDateKey();
    
    // 1. Cek apakah ada counter untuk hari ini
    if (store.dailyCounter && store.dailyCounter.date === todayKey) {
        // Jika ada, increment dan simpan
        store.dailyCounter.count++;
    } else {
        // Jika tidak ada (hari baru), reset counter dan mulai dari 100
        store.dailyCounter = {
            date: todayKey,
            count: 100 // Dimulai dari 100
        };
    }
    saveStore();
    return store.dailyCounter.count;
}


// REVISI 3: Fungsi menghitung harga berdasarkan platform/orderType
function calculatePrice(menu) {
    const base = menu.priceOffline || 0;
    if (orderType === 'Gojek') {
        return base + (menu.markupGojek || 0);
    } else if (orderType === 'Grab') {
        return base + (menu.markupGrab || 0);
    } else if (orderType === 'Shopee') {
        return base + (menu.markupShopee || 0);
    }
    return base; // Default: Offline
}

// ======================================================================
// FUNGSI LOGIN / LOGOUT
// ======================================================================
function showLogin(){
  $("appHeader").classList.remove("hidden");
  $("appNavbar").classList.remove("hidden"); // Tampilkan navbar agar tombol logout terlihat (jika ada) 
  ["homePage","kasirPage","menuPage","laporanPage"].forEach(id=>$(id).classList.add("hidden"));
  $("loginPage").classList.remove("hidden");
  
  currentUser = null;
  localStorage.removeItem('currentUser');
} 

function login(){
    const email=$("email").value.trim(),pass=$("password").value.trim();
    const u=store.users.find(x=>x.email===email&&x.password===pass);
    if(!u)return alert("Email atau password salah");
    
    currentUser=u;
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    if(currentUser.role === 'Manager'){
        $("userRoleDisplay").innerText = `Manajer: ${currentUser.email}`;
        // Manajer bisa melihat Menu & Laporan
        $("nav-menu").style.display = 'block';
        $("nav-laporan").style.display = 'block';
    } else {
        $("userRoleDisplay").innerText = `Kasir: ${currentUser.email}`;
        // Kasir tidak bisa melihat Menu & Laporan (hanya Kasir & Home)
        $("nav-menu").style.display = 'none';
        $("nav-laporan").style.display = 'block';
    }

    activateTab('home');
}
function register(){
    const email=$("email").value.trim(),pass=$("password").value.trim();
    if(!email||!pass)return alert("Isi email & password");
    if(store.users.find(u=>u.email===email))return alert("Email sudah terdaftar");
    
    store.users.push({email,password:pass, role:'User'});
    saveStore();
    alert("Akun Kasir berhasil dibuat! Silakan Login.");
    $("email").value = "";
    $("password").value = "";
}
function logout(){
    if(!confirm("Yakin ingin Logout?"))return;
    showLogin();
    // Hilangkan semua navbar (akan ditampilkan lagi oleh showLogin() tapi hanya yang relevan)
    $("nav-menu").style.display = 'none';
    $("nav-laporan").style.display = 'none';
    $("userRoleDisplay").innerText = `Mode Offline`;
}

// ======================================================================
// FUNGSI TABS
// ======================================================================
function activateTab(pageId){
    if(!currentUser) return showLogin();
    
    // Sembunyikan semua halaman
    ["homePage","kasirPage","menuPage","laporanPage"].forEach(id=>$(id).classList.add("hidden"));
    
    // Tampilkan halaman yang dipilih
    $(`${pageId}Page`).classList.remove("hidden");
    
    // Update tombol navigasi
    document.querySelectorAll(".navbar button").forEach(btn => btn.classList.remove("active-tab"));
    $(`nav-${pageId}`).classList.add("active-tab");
    
    // Aksi spesifik per tab
    if (pageId === 'kasir') {
        openOrderType();
    } else if (pageId === 'menu' && currentUser.role === 'Manager') {
        renderMenuEditor();
    } else if (pageId === 'laporan') {
        showReport('today'); // Defaultkan ke laporan hari ini
    }
}
function openOrderType(){
    orderType = null;
    cart = [];
    renderOrders();
    $("orderLabel").innerHTML = ``;
    $("orderTypeOverlay").style.display = "flex";
}
function setOrderType(type){
    orderType = type;
    $("orderTypeOverlay").style.display = "none";
    $("orderLabel").innerHTML = `<h3>Tipe Order: ${type}</h3>`;
    renderMenus('Semua');
}

// ======================================================================
// FUNGSI MENU & CART
// ======================================================================
function renderMenus(category){
    const root=$("menuList");
    root.innerHTML="";
    const filteredMenus = store.menus.filter(m => category === 'Semua' || m.category === category);
    
    // Dapatkan tipe harga dari orderType global
    const priceType = orderType === 'Offline' ? 'Offline' : `Online (${orderType})`;

    filteredMenus.forEach(m=>{
        const price = calculatePrice(m);
        if (price > 0) {
            const div=document.createElement("div");
            div.className="menu-item";
            const itemName = `${m.baseMenuName} (${m.category})`; // Menggunakan baseMenuName untuk tampilan lebih ringkas
            div.innerHTML=`
                <div><strong>${itemName}</strong></div>
                <div>${formatRp(price)}</div>
                <div style="font-size: 0.7em; color: #666;">Harga ${priceType}</div>
            `;
            div.onclick=()=>addToCart(m, itemName, price);
            root.appendChild(div);
        }
    });
}
function addToCart(m, itemName, price){
    const f=cart.find(i=>i.name===itemName);
    if(f){
        f.qty++;
    } else {
        cart.push({
            name: itemName,
            price: price, // Harga satuan dasar (belum diskon)
            qty: 1,
            category: m.category,
            baseMenuName: m.baseMenuName,
            // REVISI 1: Hapus discountPercent, simpan discountAmount (Rp)
            discountAmount: 0, // Diskon per item (nilai Rupiah)
            finalPrice: price // Harga setelah diskon per item (saat ini sama dengan price)
        });
    }
    // Update finalPrice setiap kali ada perubahan di cart
    updateCartItemTotals(); 
    renderOrders();
}
function deleteFromCart(index) {
    if (confirm(`Yakin ingin menghapus item ${cart[index].name}?`)) {
        cart.splice(index, 1);
        renderOrders();
    }
}
function updateCartItemDiscount(index, discountRp) {
    const item = cart[index];
    const maxDiscount = item.price * item.qty;
    
    let amount = parseInt(discountRp) || 0;
    
    if (amount < 0) amount = 0;
    if (amount > maxDiscount) amount = maxDiscount;
    
    item.discountAmount = amount;
    
    updateCartItemTotals();
    renderOrders(); // Re-render untuk menampilkan nilai yang diperbarui
}

function updateCartItemTotals() {
    cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        // Hitung finalPrice item (harga total dikurangi diskon Rupiah)
        item.finalPrice = itemTotal - item.discountAmount;
    });
}


/** * START OF FIX: Tambahkan fungsi updateFooterTotals()
 */
function updateFooterTotals() {
    let totalDiscount = cart.reduce((acc, c) => acc + c.discountAmount, 0);
    let finalTotal = cart.reduce((acc, c) => acc + c.finalPrice, 0);

    $("discountDisplay").innerText = "Total Diskon: -"+formatRp(totalDiscount);
    $("totalDisplay").innerText = "TOTAL BAYAR: "+formatRp(finalTotal);
    currentFinalTotal = finalTotal;
}
/**
 * END OF FIX
 */


function renderOrders(){
    const root=$("orderList");
    root.innerHTML="";
    let subtotal=0;
    
    if(cart.length===0){
        root.innerHTML="<p>Keranjang kosong. Pilih menu di atas.</p>";
        $("discountDisplay").innerText = "Total Diskon: Rp 0";
        $("totalDisplay").innerText = "TOTAL BAYAR: Rp 0";
        return;
    }

    cart.forEach((item,index)=>{
        const itemTotal = item.price * item.qty; // Subtotal per item (sebelum diskon)
        subtotal += itemTotal;
        
        const d=document.createElement("div");
        d.className="order-item-detail";
        
        // Diskon input
        const discountInput = `<input type="number" class="item-discount-input" placeholder="Rp" value="${item.discountAmount}" onchange="updateCartItemDiscount(${index}, this.value)"/>`;
        
        // Harga setelah diskon (finalPrice)
        const finalPriceDisplay = item.finalPrice !== itemTotal ? 
            `<span style="color: red; text-decoration: line-through;">${formatRp(itemTotal)}</span> ${formatRp(item.finalPrice)}` : 
            `${formatRp(itemTotal)}`;
            
        d.innerHTML=`
            <div style="flex-grow: 1;">
                ${item.qty}x ${item.name} 
                <div style="font-size: 0.8em; color: #666;">
                    Diskon: ${discountInput}
                </div>
            </div>
            <div style="text-align: right; margin-left: 10px;">
                ${finalPriceDisplay}
                <button class="btn danger delete-btn" onclick="deleteFromCart(${index})">Hapus</button>
            </div>
        `;
        root.appendChild(d);
    });

    const subtotalRef = document.createElement("div");
    subtotalRef.innerHTML = `<h4 style="margin: 5px 0; color: #666;">Subtotal Kotor: ${formatRp(subtotal)}</h4>`;
    root.appendChild(subtotalRef);
    
    // Panggil fungsi total yang baru
    updateFooterTotals(); 
}
/**
 * END OF FIX: Modifikasi renderOrders()
 */

// ======================================================================
// FUNGSI PEMBAYARAN
// ======================================================================
function openPaymentModal(){
    if(cart.length===0) return alert("Keranjang masih kosong.");
    $("modalTotal").innerText="Total Akhir: "+formatRp(currentFinalTotal);

    // Sesuaikan tombol payment berdasarkan orderType
    const isOnline = orderType !== 'Offline';

    // Tombol Cash/Manual
    $("manualBayar").style.display = isOnline ? 'none' : 'block';
    $("paymentModal").querySelector('.btn.primary').style.display = isOnline ? 'none' : 'block';
    
    // Sembunyikan semua metode bayar online jika offline
    $("pay-gojek").style.display = 'none';
    $("pay-grab").style.display = 'none';
    $("pay-shopee").style.display = 'none';
    
    // Tampilkan tombol bayar pas / QRIS jika offline
    $("pay-cash-pas").style.display = isOnline ? 'none' : 'block';
    $("pay-qris").style.display = isOnline ? 'none' : 'block';

    // Tampilkan tombol online yang relevan
    if(orderType === 'Gojek') $("pay-gojek").style.display = 'block';
    if(orderType === 'Grab') $("pay-grab").style.display = 'block';
    if(orderType === 'Shopee') $("pay-shopee").style.display = 'block';

    $("paymentModal").style.display="flex";
}
function openQrisModal(){
    $("paymentModal").style.display="none";
    $("qrisModal").style.display="flex";
}
function confirmQrisPayment(){
    $("qrisModal").style.display="none";
    completePayment('QRIS', currentFinalTotal);
}
function processManualPayment(){
    const bayar = parseInt($("manualBayar").value) || 0;
    if(bayar < currentFinalTotal) return alert(`Uang yang dibayarkan kurang! Kurang ${formatRp(currentFinalTotal - bayar)}`);
    completePayment('Cash', bayar);
}

function completePayment(method, bayar = currentFinalTotal){
    $("paymentModal").style.display="none";
    
    let subtotal = cart.reduce((acc, c) => acc + (c.price * c.qty), 0);
    let totalDiscount = cart.reduce((acc, c) => acc + c.discountAmount, 0);
    let finalTotal = currentFinalTotal;
    let change = bayar - finalTotal;
    let customerNote = $("customerNote").value.trim();
    
    // REVISI 4: Panggil fungsi antrian
    const queueNumber = getDailyQueueNumber(); 

    // Simpan transaksi & nomor antrian
    saveTransaction(subtotal, totalDiscount, finalTotal, customerNote, method, queueNumber); 

    // PERMINTAAN 6 & 7: Cetak Struk 2 kali (Customer dan Kasir)
    printStruk(subtotal, totalDiscount, finalTotal, bayar, change, customerNote, method, queueNumber, "Customer");
    printStruk(subtotal, totalDiscount, finalTotal, bayar, change, customerNote, method, queueNumber, "Kasir");
    
    cart=[];
    renderOrders();
    $("customerNote").value = "";
    openOrderType();
}

// REVISI 4: Tambahkan queueNumber ke data transaksi
function saveTransaction(subtotal, totalDiscount, finalTotal, customerNote, paymentMethod, queueNumber){
    store.transactions.push({
        id:Date.now(),
        user:currentUser.email,
        orderType,
        paymentMethod,
        queueNumber, // REVISI 4: Simpan queueNumber
        subtotal,
        discountAmount: totalDiscount,
        total: finalTotal,
        items: cart.map(item => ({
            name: item.name,
            qty: item.qty,
            price: item.price,
            discountAmount: item.discountAmount,
            finalPrice: item.finalPrice, // Total harga item setelah diskon
            category: item.category,
            baseMenuName: item.baseMenuName
        })),
        note: customerNote,
        date: new Date().toISOString()
    });
    saveStore();
}

function reprint(transactionId){
    const trx = store.transactions.find(t => t.id === transactionId);
    if (!trx) return alert("Transaksi tidak ditemukan.");
    
    // Simpan cart asli dan muat item transaksi
    const originalCart = [...cart];
    cart = trx.items;

    // REVISI 4: Ambil queueNumber dari transaksi
    const queueNumber = trx.queueNumber || 'N/A';

    printStruk(
        trx.subtotal,
        trx.discountAmount,
        trx.total,
        trx.paymentMethod.toLowerCase() === 'cash' ? (trx.total + (trx.total - trx.total)) : trx.total, // Bayar
        trx.paymentMethod.toLowerCase() === 'cash' ? (trx.total - trx.total) : 0, // Kembali
        trx.note,
        trx.paymentMethod,
        queueNumber,
        "Customer"
    );

    // Kembalikan cart asli
    cart = originalCart;
    renderOrders();
}


// ======================================================================
// FUNGSI PENGELOLAAN MENU (MANAJER)
// ======================================================================
function addMenu(){
    if (currentUser.role !== 'Manager') return alert("Akses ditolak.");
    
    const name=$("mName").value.trim();
    const category=$("mCategory").value;
    const priceOffline=parseInt($("mPriceOffline").value) || 0;
    const gojekMarkup=parseInt($("mGojekMarkup").value) || 0;
    const grabMarkup=parseInt($("mGrabMarkup").value) || 0;
    const shopeeMarkup=parseInt($("mShopeeMarkup").value) || 0;

    if(!name||!category||priceOffline<=0)return alert("Isi Nama Menu, Kategori, dan Harga Jual Offline.");
    
    const uniqueName = `${name} (${category})`;

    if(store.menus.find(m => m.uniqueName === uniqueName)) return alert("Menu dengan kategori ini sudah ada.");

    store.menus.push({
        baseMenuName: name, // Nama dasar
        category: category, // Kategori (misal: Large, Reguler)
        uniqueName: uniqueName, // Nama lengkap untuk identifikasi
        priceOffline: priceOffline,
        markupGojek: gojekMarkup,
        markupGrab: grabMarkup,
        markupShopee: shopeeMarkup
    });
    saveStore();
    renderMenuEditor();
    alert(`Menu ${uniqueName} berhasil ditambahkan.`);
    $("mName").value = "";
    $("mCategory").value = "";
    $("mPriceOffline").value = "";
    $("mGojekMarkup").value = "";
    $("mGrabMarkup").value = "";
    $("mShopeeMarkup").value = "";
}

function deleteMenu(uniqueName){
    if (currentUser.role !== 'Manager') return alert("Akses ditolak.");
    if (confirm(`Yakin ingin menghapus menu ${uniqueName}?`)) {
        store.menus = store.menus.filter(m => m.uniqueName !== uniqueName);
        saveStore();
        renderMenuEditor();
        alert(`Menu ${uniqueName} berhasil dihapus.`);
    }
}

function renderMenuEditor(){
    if (currentUser.role !== 'Manager') {
        $("menuEditor").innerHTML = "<p style='color:red;'>Akses ditolak. Hanya Manajer yang dapat mengelola menu.</p>";
        return;
    }

    const root=$("menuEditor");
    let html = `<table class="report-table">
        <thead>
            <tr>
                <th>Nama Menu (Kategori)</th>
                <th>Harga Offline</th>
                <th>Markup Gojek</th>
                <th>Markup Grab</th>
                <th>Markup Shopee</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>`;
    
    store.menus.forEach(m => {
        html += `
            <tr>
                <td>${m.baseMenuName} (${m.category})</td>
                <td>${formatRp(m.priceOffline)}</td>
                <td>+${formatRp(m.markupGojek)}</td>
                <td>+${formatRp(m.markupGrab)}</td>
                <td>+${formatRp(m.markupShopee)}</td>
                <td><button class="btn danger delete-btn" onclick="deleteMenu('${m.uniqueName}')">Hapus</button></td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    root.innerHTML = html;
}

// ======================================================================
// FUNGSI LAPORAN
// ======================================================================
function getFilteredTransactions(filterType = 'today', dateInputTrigger = false) {
    const today = getDateOnly(new Date().toISOString());
    const yesterday = today - 86400000; // 24 hours in ms
    const selectedDateValue = $("reportDate").value;
    
    let filteredTrx = [];
    let reportPeriod = "Hari Ini";

    // 1. Filter berdasarkan Input Tanggal
    if (dateInputTrigger && selectedDateValue) {
        const selectedDate = getDateOnly(selectedDateValue);
        filteredTrx = store.transactions.filter(t => getDateOnly(t.date) === selectedDate);
        reportPeriod = `Tanggal: ${selectedDateValue}`;
    } 
    // 2. Filter berdasarkan Tombol Cepat
    else if (filterType === 'yesterday') {
        filteredTrx = store.transactions.filter(t => getDateOnly(t.date) === yesterday);
        reportPeriod = "Kemarin";
    } else if (filterType === 'month') {
        const d = new Date();
        const startOfMonth = new Date(d.getFullYear(), d.getMonth(), 1).getTime();
        const endOfMonth = new Date(d.getFullYear(), d.getMonth() + 1, 0).getTime() + 86400000;
        filteredTrx = store.transactions.filter(t => {
            const trxDate = new Date(t.date).getTime();
            return trxDate >= startOfMonth && trxDate < endOfMonth;
        });
        reportPeriod = "Bulan Ini";
    } else { // Default: today
        filteredTrx = store.transactions.filter(t => getDateOnly(t.date) === today);
        reportPeriod = "Hari Ini";
    }

    // Sortir transaksi terbaru di atas
    filteredTrx.sort((a, b) => b.id - a.id);
    
    return { filteredTrx, reportPeriod };
}


function showReport(filterType, dateInputTrigger = false){
    if (currentUser.role !== 'Manager' && currentUser.role !== 'User') {
        return alert("Akses ditolak. Hanya Kasir atau Manajer yang dapat melihat laporan.");
    }
    
    // Reset status tombol filter
    document.querySelectorAll('#laporanPage .btn.secondary').forEach(btn => btn.classList.remove('active-tab'));
    if (filterType === 'today') $("laporanPage").querySelector('button[onclick="showReport(\'today\')"]').classList.add('active-tab');
    if (filterType === 'yesterday') $("laporanPage").querySelector('button[onclick="showReport(\'yesterday\')"]').classList.add('active-tab');
    if (filterType === 'month') $("laporanPage").querySelector('button[onclick="showReport(\'month\')"]').classList.add('active-tab');

    const { filteredTrx, reportPeriod } = getFilteredTransactions(filterType, dateInputTrigger);

    let totalSales = 0;
    let totalDiscount = 0;
    let totalSubtotal = 0;
    let salesByOutlet = {};
    let salesByPayment = {};

    filteredTrx.forEach(t => {
        const outlet = t.orderType || 'Offline';
        const method = t.paymentMethod || 'Tunai';

        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;
        salesByPayment[method] = (salesByPayment[method] || 0) + t.total;
        totalDiscount = (totalDiscount || 0) + t.discountAmount;
        totalSubtotal = (totalSubtotal || 0) + t.subtotal;
        totalSales = (totalSales || 0) + t.total;
    });

    renderSummary(filteredTrx.length, totalSubtotal, totalDiscount, totalSales);
    renderDetails(salesByOutlet, salesByPayment, reportPeriod);
    renderSalesChart(filteredTrx, filterType);
    renderSalesByMenu(filteredTrx);
    renderTransactionList(filteredTrx);
}

function renderSummary(totalTrx, subtotal, discount, totalSales) {
    const root = $("laporanSummary");
    root.innerHTML = `
        <div class="summary-card card-count">
            <h4>Total Transaksi</h4>
            <div class="value">${totalTrx}</div>
        </div>
        <div class="summary-card card-subtotal">
            <h4>Subtotal Kotor</h4>
            <div class="value">${formatRp(subtotal)}</div>
        </div>
        <div class="summary-card card-discount">
            <h4>Total Diskon</h4>
            <div class="value">-${formatRp(discount)}</div>
        </div>
        <div class="summary-card card-sales">
            <h4>Total Penjualan Akhir</h4>
            <div class="value">${formatRp(totalSales)}</div>
        </div>
    `;
}

function renderDetails(salesByOutlet, salesByPayment, reportPeriod) {
    const root = $("laporanDetailSummary");

    const renderList = (data, title) => {
        let html = `<h4>${title}</h4><ul class="detail-list">`;
        const sortedData = Object.entries(data).sort(([, a], [, b]) => b - a);
        sortedData.forEach(([key, value]) => {
            html += `<li><span>${key}</span> <span>${formatRp(value)}</span></li>`;
        });
        html += `</ul>`;
        return html;
    };
    
    root.innerHTML = `
        <div style="display: flex; gap: 20px;">
            <div style="flex: 1;">${renderList(salesByOutlet, "Penjualan Berdasarkan Outlet")}</div>
            <div style="flex: 1;">${renderList(salesByPayment, "Penjualan Berdasarkan Pembayaran")}</div>
        </div>
        <p style="margin-top: 15px; font-size: 0.9em; color: #666;">Data Laporan: ${reportPeriod}</p>
    `;
}

function renderSalesChart(filteredTrx, filterType) {
    if (salesChartInstance) {
        salesChartInstance.destroy();
    }

    const dataMap = {};
    
    filteredTrx.forEach(t => {
        const date = new Date(t.date);
        let key;
        // Agregasi berdasarkan hari (default dan yesterday)
        if (filterType === 'today' || filterType === 'yesterday' || !filterType) {
            key = date.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        } 
        // Agregasi berdasarkan tanggal (untuk filter bulan atau input tanggal)
        else {
            key = date.toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        }
        
        dataMap[key] = (dataMap[key] || 0) + t.total;
    });

    const labels = Object.keys(dataMap);
    const data = Object.values(dataMap);

    const ctx = $("salesChart").getContext('2d');
    salesChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Total Penjualan (Rp)',
                data: data,
                backgroundColor: 'rgba(46, 125, 50, 0.8)', // Green
                borderColor: 'rgba(46, 125, 50, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true,
                    callback: function(value) { return formatRp(value); }
                }
            }
        }
    });
}

function renderSalesByMenu(filteredTrx) {
    const root = $("salesByMenu");
    root.innerHTML = "";
    let menuMix = {};

    filteredTrx.forEach(t => {
        t.items.forEach(item => {
            const name = item.name;
            const itemTotal = item.finalPrice;
            
            menuMix[name] = menuMix[name] || { qty: 0, finalSales: 0 };
            menuMix[name].qty += item.qty;
            menuMix[name].finalSales += itemTotal;
        });
    });

    if (Object.keys(menuMix).length === 0) {
        root.innerHTML = "<p>Belum ada item terjual untuk periode ini.</p>";
        return;
    }

    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty);

    let html = `<ul class="detail-list">`;
    sortedMenu.forEach(([name, data]) => {
        html += `
            <li>
                <span>${name} (${data.qty} pcs)</span>
                <span style="font-weight: bold;">${formatRp(data.finalSales)}</span>
            </li>
        `;
    });
    html += `</ul>`;
    root.innerHTML = html;
}

function renderTransactionList(filteredTrx) {
    const root = $("laporanList");
    root.innerHTML = "";
    
    if (filteredTrx.length === 0) {
        root.innerHTML = "<p>Tidak ada transaksi ditemukan.</p>";
        return;
    }

    let html = `<table class="report-table">
        <thead>
            <tr>
                <th>No Nota</th>
                <th>Waktu</th>
                <th>Kasir</th>
                <th>Total Akhir</th>
                <th>Tipe</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>`;
    
    filteredTrx.forEach(t => {
        const time = new Date(t.date).toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
        const date = new Date(t.date).toLocaleDateString('id-ID', { day: 'numeric', month: 'short' });
        const displayTime = t.queueNumber ? `#${t.queueNumber} (${time})` : `${date} ${time}`;

        html += `
            <tr>
                <td>${displayTime}</td>
                <td>${new Date(t.date).toLocaleString('id-ID')}</td>
                <td>${t.user}</td>
                <td style="font-weight: bold;">${formatRp(t.total)}</td>
                <td>${t.orderType} (${t.paymentMethod})</td>
                <td><button class="btn secondary delete-btn" onclick="reprint(${t.id})">Cetak Ulang</button></td>
            </tr>
        `;
    });
    
    html += `</tbody></table>`;
    root.innerHTML = html;
}

// ======================================================================
// FUNGSI CETAK (STRUK & LAPORAN)
// ======================================================================
const formatRpNumber = (n) => (n||0).toLocaleString("id-ID");

const formatLine = (label, value) => {
    const MAX_CHARS_58MM = 32;
    const padding = MAX_CHARS_58MM - label.length - String(value).length;
    return label + ' '.repeat(padding > 0 ? padding : 1) + String(value);
};

const center = (text) => {
    const MAX_CHARS_58MM = 32;
    const totalPadding = MAX_CHARS_58MM - text.length;
    const paddingLeft = Math.floor(totalPadding / 2);
    return ' '.repeat(paddingLeft > 0 ? paddingLeft : 0) + text;
};

const createStrukLine = (item) => {
    const MAX_CHARS_58MM = 32;
    const finalPrice = item.finalPrice; // Harga total item setelah diskon
    const qty = item.qty;
    const name = item.name.substring(0, MAX_CHARS_58MM - 5); // Potong nama jika terlalu panjang
    const priceText = formatRpNumber(finalPrice); 
    const priceLen = priceText.length;
    
    let line1 = `${qty}x ${name}`;
    let line2 = ' '.repeat(MAX_CHARS_58MM - priceLen) + priceText; 

    // Jika item memiliki diskon, tampilkan subtotal kotor
    if (item.discountAmount > 0) {
        const subtotalKotor = formatRpNumber(item.price * item.qty);
        line1 = `${qty}x ${name} (${subtotalKotor})`
        line2 = ' '.repeat(MAX_CHARS_58MM - priceLen) + priceText;
        // Tambahkan baris diskon di bawah
        const diskonLine = formatLine('  - Diskon', formatRpNumber(item.discountAmount));
        return line1 + '\n' + line2 + '\n' + diskonLine;
    }

    // Jika tidak ada diskon, tampilkan dalam 1 baris (jika muat) atau 2 baris
    if (line1.length + priceLen + 1 <= MAX_CHARS_58MM) {
        const padding = MAX_CHARS_58MM - line1.length - priceLen;
        return line1 + ' '.repeat(padding) + priceText;
    } else {
        return line1 + '\n' + line2;
    }
};

const createReportLine = (item, data) => {
    const MAX_CHARS_58MM = 32;
    const nameText = `${item} (${data.qty} pcs)`;
    const salesText = formatRpNumber(data.finalSales);
    const padding = MAX_CHARS_58MM - nameText.length - salesText.length;
    return nameText + ' '.repeat(padding > 0 ? padding : 1) + salesText;
};


// FUNGSI PRINT STRUK
const printStruk = async (subtotal, totalDiscount, finalTotal, bayar, kembali, note, paymentMethod, queueNumber, copyType) => {
  try{
    const now = new Date().toLocaleString("id-ID");
    const lines = [];
    const MAX_CHARS_58MM = 32;

    // Header
    lines.push(center(`(${copyType.toUpperCase()})`));
    lines.push(center("JIF PIZZA CONDET"));
    lines.push(center("Jl. Condet Raya No. 123"));
    lines.push(center("Jakarta Timur"));
    lines.push(center("______________________________"));

    // Info Transaksi
    lines.push(formatLine("No. Antrian", `#${queueNumber}`));
    lines.push(formatLine("Kasir", currentUser ? currentUser.email : "-"));
    lines.push(formatLine("Waktu", now));
    lines.push(formatLine("Order Via", orderType || 'Offline'));
    lines.push('='.repeat(MAX_CHARS_58MM));

    // Detail Item
    cart.forEach(item => {
        lines.push(createStrukLine(item));
    });

    lines.push('='.repeat(MAX_CHARS_58MM));

    // Summary
    lines.push(formatLine('Subtotal Kotor', formatRpNumber(subtotal)));
    if (totalDiscount > 0) {
        lines.push(formatLine('Diskon Total', `-${formatRpNumber(totalDiscount)}`));
    }
    lines.push(formatLine('TOTAL AKHIR', formatRpNumber(finalTotal)));
    lines.push('='.repeat(MAX_CHARS_58MM));

    // Payment
    lines.push(formatLine('Metode', paymentMethod));
    if(paymentMethod && paymentMethod.toLowerCase()==='cash'){
        lines.push(formatLine('Bayar', formatRpNumber(bayar)));
        lines.push(formatLine('Kembali', formatRpNumber(kembali)));
    }

    // Note
    if(note){ 
        lines.push('-'.repeat(MAX_CHARS_58MM));
        lines.push('Catatan:');
        wrapText(note, MAX_CHARS_58MM).forEach(l=>lines.push(l));
    }

    lines.push('');
    lines.push(center('TERIMA KASIH'));
    lines.push('');

    if(btCharacteristic && btDevice && btDevice.gatt.connected){
        try{ 
            await printToBluetooth(lines); 
            console.log('[Printer] Cetak via Bluetooth berhasil'); 
            return true; 
        }catch(e){ 
            console.warn('[Printer] Cetak BT gagal, fallback', e); 
        }
    } else console.log('[Printer] Belum terhubung, fallback ke window.print()');
    
    const w = window.open('','_blank'); 
    w.document.write(`<pre style=\"font-family: monospace; font-size:11px; width:58mm;\">${lines.join('\n')}</pre>`); 
    w.print(); 
    w.close();
    return false;
  }catch(err){ 
    console.error('printStruk override error',err); 
    alert('Gagal mencetak: '+(err.message||err)); 
    return false; 
  }
};

// FUNGSI PRINT LAPORAN
const printReport = () => {
    const { filteredTrx, reportPeriod } = getFilteredTransactions($("reportDate").value ? null : 'today', $("reportDate").value ? true : false);

    let totalSales = 0;
    let totalDiscount = 0;
    let totalSubtotal = 0;
    let salesByOutlet = {};
    let salesByPayment = {};
    let menuMix = {};

    filteredTrx.forEach(t => {
        const outlet = t.orderType || 'Offline';
        const method = t.paymentMethod || 'Tunai';

        totalSales += t.total;
        totalDiscount += t.discountAmount;
        totalSubtotal += t.subtotal;
        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;
        salesByPayment[method] = (salesByPayment[method] || 0) + t.total;

        t.items.forEach(item => {
            const name = item.name;
            const itemTotal = item.finalPrice; // Sudah bersih dari diskon
            menuMix[name] = menuMix[name] || { qty: 0, finalSales: 0 };
            menuMix[name].qty += item.qty;
            menuMix[name].finalSales += itemTotal;
        });
    });

    const sortedPayment = Object.entries(salesByPayment).sort(([, a], [, b]) => b - a);
    const paymentDetail = sortedPayment.map(([method, total]) => formatLine(method, formatRpNumber(total))).join('\n');
    
    const sortedOutlet = Object.entries(salesByOutlet).sort(([, a], [, b]) => b - a);
    const outletDetail = sortedOutlet.map(([outlet, total]) => formatLine(outlet, formatRpNumber(total))).join('\n');

    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty);
    const menuDetail = sortedMenu.map(([name, data]) => createReportLine(name, data)).join('\n');


    const MAX_CHARS_58MM = 32;
    const lines = [];

    // Header
    lines.push(center("== LAPORAN PENJUALAN =="));
    lines.push(center("Outlet: JIF PIZZA CONDET"));
    lines.push(center(`Periode: ${reportPeriod}`));
    lines.push(center("______________________________"));

    // Info
    lines.push(formatLine("Manajer/Kasir", currentUser ? currentUser.email : "-"));
    lines.push(formatLine("Tanggal Cetak", new Date().toLocaleString("id-ID")));
    lines.push(formatLine("Total Transaksi", `${filteredTrx.length} Nota`));
    lines.push('='.repeat(MAX_CHARS_58MM));

    // Summary
    lines.push(center("RINGKASAN PENJUALAN"));
    lines.push(formatLine("Subtotal Kotor", formatRpNumber(totalSubtotal)));
    lines.push(formatLine("Diskon Total", `-${formatRpNumber(totalDiscount)}`));
    lines.push(formatLine("TOTAL PENJUALAN", formatRpNumber(totalSales)));
    lines.push('='.repeat(MAX_CHARS_58MM));

    // Detail Outlet
    lines.push(center("PENJUALAN PER OUTLET"));
    lines.push(outletDetail);
    lines.push('='.repeat(MAX_CHARS_58MM));
    
    // Detail Payment
    lines.push(center("PENJUALAN PER PEMBAYARAN"));
    lines.push(paymentDetail);
    lines.push('='.repeat(MAX_CHARS_58MM));

    // Detail Menu Mix
    lines.push(center("SALES BY MENU"));
    lines.push(menuDetail);
    lines.push('='.repeat(MAX_CHARS_58MM));

    // Footer
    lines.push(center('*** END OF REPORT ***'));
    lines.push('');

    // Cetak
    if(btCharacteristic && btDevice && btDevice.gatt.connected){
        try{ 
            printToBluetooth(lines); 
            console.log('[Printer] Cetak Laporan via Bluetooth berhasil');
        }catch(e){ 
            console.warn('[Printer] Cetak Laporan BT gagal, fallback', e);
            const w = window.open('','_blank'); 
            w.document.write(`<pre style=\"font-family: monospace; font-size:11px; width:58mm;\">${lines.join('\n')}</pre>`); 
            w.print();
        }
    } else {
        console.log('[Printer] Belum terhubung, fallback ke window.print()');
        const w = window.open('','_blank'); 
        w.document.write(`<pre style=\"font-family: monospace; font-size:11px; width:58mm;\">${lines.join('\n')}</pre>`); 
        w.print();
    }
};

// ======================================================================
// FUNGSI BLUETOOTH PRINTER (Web Bluetooth API)
// ======================================================================

const PRINTER_SERVICE_UUIDS = [
    // UUIDs umum untuk Printer Bluetooth
    '000018f0-0000-1000-8000-00805f9b34fb', // Thermal Printer Service (sering digunakan)
    '00001101-0000-1000-8000-00805f9b34fb', // SPP/Serial Port Profile
    '49535343-fe7d-4c48-a09e-955d2105f242', // ISSC (bisa jadi)
    '0000ffe7-0000-1000-8000-00805f9b34fb', // Custom
    '0000ff00-0000-1000-8000-00805f9b34fb', // Custom
    // Tambahkan UUID lain jika diketahui
];
const PRINTER_CHARACTERISTIC_UUIDS = [
    // UUIDs umum untuk Characteristic Write (mengirim data)
    '00002a00-0000-1000-8000-00805f9b34fb', // Generic Write
    '0000ffe4-0000-1000-8000-00805f9b34fb', // Custom
    '0000ffe5-0000-1000-8000-00805f9b34fb', // Custom
    '49535343-8841-43f4-a8d4-ecbe34729cc3', // ISSC Write
    '0000fff2-0000-1000-8000-00805f9b34fb', // Custom (sangat umum)
    '0000fff1-0000-1000-8000-00805f9b34fb', // Custom (sangat umum)
];

let btDevice = null;
let btServer = null;
let btService = null;
let btCharacteristic = null;

function setPrinterStatus(message) {
    const statusElement = $("printerStatus");
    const connectBtn = $("btn-printer-connect");
    statusElement.innerText = message;
    
    if (message === 'Terhubung') {
        statusElement.style.color = '#2e7d32'; // Hijau
        connectBtn.classList.remove('secondary-nav');
        connectBtn.classList.add('primary-nav');
    } else if (message === 'Terputus') {
        statusElement.style.color = '#d32f2f'; // Merah
        connectBtn.classList.remove('primary-nav');
        connectBtn.classList.add('secondary-nav');
    } else {
        statusElement.style.color = '#1976d2'; // Biru (Progress)
    }
}

async function connectPrinter() {
    if (!navigator.bluetooth) {
        setPrinterStatus('BT Tidak Tersedia');
        alert("Browser Anda tidak mendukung Web Bluetooth API. Coba gunakan Chrome (Android/Desktop).");
        return;
    }

    try {
        setPrinterStatus('Mencari...');
        
        // Meminta perangkat Bluetooth dengan filter yang luas
        const device = await navigator.bluetooth.requestDevice({
            filters: [
                // Filter 1: Mencari berdasarkan Service UUID yang umum
                { services: PRINTER_SERVICE_UUIDS.map(u => u.length === 8 ? parseInt(u.substring(4,8), 16) : u) },
                // Filter 2: Mencari berdasarkan nama printer yang umum
                { namePrefix: 'POS' }, 
                { namePrefix: 'RP' },
                { namePrefix: 'Bluetooth' },
                // Filter 3: Mencari semua perangkat yang tidak memiliki filter service (untuk kompatibilitas)
                { acceptAllDevices: true }
            ],
            // Penting: Service opsional harus mencakup semua service yang mungkin
            optionalServices: PRINTER_SERVICE_UUIDS 
        });

        setPrinterStatus('Mengakses GATT...');
        btDevice = device;
        btDevice.addEventListener('gattserverdisconnected', onBluetoothDisconnected);
        
        btServer = await btDevice.gatt.connect();
        
        setPrinterStatus('Mengakses Service...');
        // Coba temukan Service yang cocok dari daftar umum
        let serviceFound = false;
        for (const uuid of PRINTER_SERVICE_UUIDS) {
            try {
                btService = await btServer.getPrimaryService(uuid);
                serviceFound = true;
                break;
            } catch (e) {
                // Lanjut ke UUID berikutnya
                console.log(`Service ${uuid} tidak ditemukan. Mencoba yang lain...`);
            }
        }
        
        if (!serviceFound) {
             // Jika tidak ada service umum yang ditemukan, coba service yang paling sering ada
             // Misalnya: Generic Access atau Device Information (walaupun ini bukan untuk print)
             // Atau coba dapatkan service pertama yang tersedia (risiko salah)
             try {
                // Mencoba mendapatkan semua services (jika ada) dan mengambil yang pertama
                const services = await btServer.getPrimaryServices();
                if (services.length > 0) {
                    btService = services[0];
                    serviceFound = true;
                    console.warn("Menggunakan service pertama yang tersedia. Ini mungkin tidak benar.");
                }
             } catch(e) { /* ignore */ }
        }

        if (!serviceFound) {
            throw new Error("Gagal menemukan service printer yang kompatibel.");
        }
        
        setPrinterStatus('Mengakses Characteristic...');
        // Cari characteristic yang cocok (write)
        let characteristicFound = false;
        for (const uuid of PRINTER_CHARACTERISTIC_UUIDS) {
            try {
                btCharacteristic = await btService.getCharacteristic(uuid);
                
                // Pastikan characteristic mendukung operasi tulis
                if (btCharacteristic.properties.write || btCharacteristic.properties.writeWithoutResponse) {
                    characteristicFound = true;
                    break;
                }
            } catch (e) {
                // Lanjut ke UUID berikutnya
                console.log(`Characteristic ${uuid} tidak ditemukan. Mencoba yang lain...`);
            }
        }
        
        if (!characteristicFound) {
            // Fallback: Mencoba mencari characteristic pertama yang mendukung write
            try {
                 const characteristics = await btService.getCharacteristics();
                 for (const char of characteristics) {
                     if (char.properties.write || char.properties.writeWithoutResponse) {
                         btCharacteristic = char;
                         characteristicFound = true;
                         console.warn("Menggunakan characteristic pertama yang mendukung write.");
                         break;
                     }
                 }
            } catch(e) { /* ignore */ }
        }

        if (!characteristicFound) {
            throw new Error("Gagal menemukan characteristic write yang kompatibel.");
        }

        setPrinterStatus('Terhubung');
        alert("Printer terhubung dengan sukses!");

    } catch (error) {
        console.error('Koneksi Printer Gagal:', error);
        setPrinterStatus('Gagal');
        alert('Koneksi printer gagal: ' + (error.message || 'Error tidak diketahui.'));
        disconnectPrinter();
    }
}

function onBluetoothDisconnected(event) {
    console.log('Perangkat Bluetooth terputus:', event.target.name);
    setPrinterStatus('Terputus');
    btDevice = null;
    btServer = null;
    btService = null;
    btCharacteristic = null;
}

function disconnectPrinter() {
    if (btDevice && btDevice.gatt.connected) {
        btDevice.gatt.disconnect();
    }
    setPrinterStatus('Terputus');
    btDevice = null;
    btServer = null;
    btService = null;
    btCharacteristic = null;
}

// FUNGSI UTILITY BLUETOOTH
const CHUNK = 20; // Ukuran chunk data (20 byte, batas umum Web Bluetooth)

async function writeToCharacteristic(bytes) {
  let offset = 0;
  while (offset < bytes.length) {
    const end = Math.min(offset+CHUNK, bytes.length);
    const slice = bytes.slice(offset,end);

    // Coba kedua metode write untuk kompatibilitas
    if(btCharacteristic.properties.write){
      await btCharacteristic.writeValue(slice);
    } else if(btCharacteristic.properties.writeWithoutResponse){
      await btCharacteristic.writeValueWithoutResponse(slice);
    } else throw new Error('Characteristic tidak mendukung write.');
    
    offset = end;
    // Tambahkan delay kecil untuk menghindari overflow buffer printer
    await new Promise(r=>setTimeout(r,30));
  }
}

function wrapText(text,width=MAX_CHARS_58MM){
    const words=String(text).split(' ');
    const lines=[];
    let cur='';
    for(const w of words){
        if((cur+' '+w).trim().length<=width) cur=(cur+' '+w).trim();
        else{
            if(cur) lines.push(cur);
            let rem=w;
            while(rem.length>width){
                lines.push(rem.substring(0,width));
                rem=rem.substring(width).trim();
            }
            cur=rem;
        }
    }
    if(cur) lines.push(cur);
    return lines;
}

// Fungsi cetak utama via Bluetooth
async function printToBluetooth(lines){
  const text = lines.join('\n');
  const encoder = new TextEncoder();
  const data = encoder.encode(text);
  await writeToCharacteristic(data);
}

// expose
window.connectPrinter = connectPrinter;
window.disconnectPrinter = disconnectPrinter;


// ======================================================================
// FUNGSI INITIATION (Dipanggil saat dokumen selesai dimuat)
// ======================================================================
window.onload = function(){
    if(currentUser){
        // Jika ada user di localStorage, langsung login (akan diarahkan ke home)
        if(currentUser.role === 'Manager'){
             $("userRoleDisplay").innerText = `Manajer: ${currentUser.email}`;
             $("nav-menu").style.display = 'block';
             $("nav-laporan").style.display = 'block';
        } else {
             $("userRoleDisplay").innerText = `Kasir: ${currentUser.email}`;
             $("nav-menu").style.display = 'none';
             $("nav-laporan").style.display = 'block';
        }
        activateTab('home');
    } else {
        // Jika tidak ada, tampilkan halaman login
        showLogin();
    }
    
    // Pastikan Chart.js sudah siap
    if (typeof Chart === 'undefined') {
        console.error("Chart.js belum dimuat!");
    }

};
</script>
</body>
</html>