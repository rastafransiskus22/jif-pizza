<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JIF PIZZA POS v10.0 â€” Final</title>
<link rel="icon" href="logo.png"/>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="JIF POS">
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="logo.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 

<style>
/* CSS */
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:#222}
.hidden{display:none}
header.hidden, .navbar.hidden { display: none !important; }

/* LATAR BELARANG GAMBAR HEADER (pizza.jpg) */
header{
  background:url('pizza.jpg') center/cover no-repeat; 
  color:#fff;
  padding:12px;
  text-align:center;
  position: relative; 
  z-index: 1; 
  height: 80px;
  overflow: hidden; 
}
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.7); 
    z-index: 1; 
} 
header h1, header p {
    position: relative; 
    z-index: 2; 
}
header h1{margin:0;font-size:22px}
header p{margin:4px 0 0 0;font-size:14px}

/* Gaya Tombol 3D */
.navbar button, .btn {
    padding: 10px 16px; 
    border: none;
    border-radius: 8px; 
    cursor: pointer;
    font-weight: 600;
    position: relative;
    overflow: hidden;
    transition: all 0.2s ease;
    box-shadow: 0 4px 6px rgba(0,0,0,0.1), 0 1px 3px rgba(0,0,0,0.08); 
    background: linear-gradient(145deg, #f0f0f0, #e0e0e0); 
    color: #333;
    text-shadow: 0 1px 0 rgba(255,255,255,0.7); 
}
.navbar button:hover, .btn:hover {
    transform: translateY(-1px); 
    box-shadow: 0 6px 10px rgba(0,0,0,0.15), 0 2px 4px rgba(0,0,0,0.1);
}
.navbar button:active, .btn:active {
    transform: translateY(1px); 
    box-shadow: 0 2px 3px rgba(0,0,0,0.1), 0 1px 2px rgba(0,0,0,0.08);
}
/* Gaya spesifik untuk tombol primary (merah) */
.btn.primary, .navbar button.primary-nav { 
    background: linear-gradient(145deg, #e57373, #d32f2f);
    color: #fff;
    text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.secondary, .navbar button.secondary-nav { 
    background: linear-gradient(145deg, #64b5f6, #1976d2);
    color: #fff;
    text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}
.btn.danger, .navbar button.danger-nav { 
    background: linear-gradient(145deg, #ef5350, #c62828);
    color: #fff;
    text-shadow: 0 1px 0 rgba(0,0,0,0.3);
    box-shadow: 0 4px 6px rgba(0,0,0,0.2), 0 1px 3px rgba(0,0,0,0.1);
}

/* GAYA TAB AKTIF (Merah) - FIX: Hapus text-shadow */
.navbar button.active-tab {
    background: linear-gradient(145deg, #d32f2f, #e57373);
    color: #fff;
    box-shadow: 0 0 5px rgba(217, 73, 73, 0.7); 
    transform: none; 
    text-shadow: none !important; 
}


.navbar{background:#fff;display:flex;justify-content:center;gap:8px;padding:8px;box-shadow:0 2px 6px rgba(0,0,0,0.1)}
.container{padding:14px}
#loginPage {
    max-width: 400px; 
    margin: 40px auto; 
    padding: 20px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.1);
}
.menu-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:10px}
.menu-item{border:1px solid #ccc;border-radius:8px;padding:8px;text-align:center;cursor:pointer}
.menu-item {
    background: #fdfdfd;
    box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    transition: transform 0.1s ease-in-out;
}
.menu-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}
/* NEW: Gaya Order Item Detail (untuk tombol Hapus) */
.order-item-detail {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 5px 0;
    border-bottom: 1px dashed #eee;
}
.order-item-detail .delete-btn {
    padding: 3px 6px;
    font-size: 0.7em;
    margin-left: 10px;
    box-shadow: none;
}
.order-box{margin-top:12px;padding:10px;border-top:2px solid #ccc}
.overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:100;display:none}
.modal{background:white;padding:20px;border-radius:10px;text-align:center;max-width:320px;width:90%}
/* FIX 1: Jarak tombol di modal payment */
#paymentModal .modal button:not(.btn.primary) { 
    margin: 5px; /* Jarak antar tombol */
} 
/* NEW: Flexbox untuk tombol payment */
#paymentMethods { 
    display: flex; 
    flex-wrap: wrap; 
    gap: 10px; 
    justify-content: center; 
}
input, select{padding:8px;border:1px solid #ccc;border-radius:6px;width:100%;margin:4px 0}
.report-table { width: 100%; border-collapse: collapse; margin-top: 15px; }
.report-table th, .report-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
.report-table th { background-color: #f2f2f2; }

#homePage img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    display: block;
    margin: 0 auto 20px auto; 
}

/* Print style untuk 80mm */
@media print {
    body { 
        width: 80mm; 
        margin: 0; 
        padding: 0; 
        font-family: 'Courier New', Courier, monospace !important; 
        font-size: 14px !important;
    }
    pre { 
        width: 80mm !important; 
        max-width: 80mm !important; 
        font-family: 'Courier New', Courier, monospace !important; 
    }
}
</style>
</head>
<body>
<div id="loginPage" class="container">
    <h2>Login JIF PIZZA POS</h2>
    <input type="email" id="loginEmail" placeholder="Email Kasir/Manager" required/>
    <input type="password" id="loginPassword" placeholder="Password" required/>
    <button class="btn primary" onclick="login()">Login</button>
</div>

<header id="appHeader" class="hidden">
    <h1>JIF PIZZA CONDET</h1>
    <p>Manajer: <span id="userEmailDisplay"></span> | Role: <span id="userRoleDisplay"></span></p>
</header>

<div class="navbar" id="appNavbar">
    <button class="primary-nav active-tab" onclick="changePage('home')">Home</button>
    <button class="primary-nav" onclick="changePage('kasir')">Kasir</button>
    <button class="primary-nav" onclick="changePage('menu')">Menu</button>
    <button class="primary-nav" onclick="changePage('laporan')">Laporan</button>
    <button class="danger-nav" onclick="logout()">Logout</button>
</div>

<div class="container" id="appContainer">
    
    <div id="homePage" class="page">
        <img src="https://i.ibb.co/L9s39pS/1000207993.jpg" alt="JIF Pizza Welcome"> 
        <h2>Selamat Datang di Jif Pizza!</h2>
        <p>Ini adalah tempat di mana semangat bertemu dengan peluang. Kami percaya pada potensi setiap individu. Gunakan hari-hari Anda di sini untuk belajar, bertumbuh, dan mengukir prestasi. Jadilah bagian dari resep rahasia kesuksesan kami.</p>
        <p>Mari mulai memanggang masa depan yang cerah!</p>
    </div>

    <div id="kasirPage" class="page hidden">
        <input type="text" id="customerNote" placeholder="Nama Pelanggan/Driver/Catatan"/>
        <select id="orderType" style="margin-bottom: 10px;">
            <option value="Offline">Tipe Order: Offline</option>
            <option value="Online">Tipe Order: Online</option>
        </select>
        
        <div id="menuSelectorButtons" style="display: flex; gap: 5px; margin-bottom: 10px; overflow-x: auto;">
            </div>

        <div id="orderItems" class="order-box">
            <p>Keranjang kosong.</p>
        </div>

        <div id="discountSection" style="margin-top: 15px;">
            <label for="discountSelect">-- Pilih Diskon (Tidak Ada) --</label>
            <select id="discountSelect" onchange="applyDiscount()">
                <option value="">Tidak Ada</option>
            </select>
            <p style="margin: 10px 0;">Diskon: <span id="discountDisplay">Rp 0</span></p>
        </div>

        <div style="margin: 15px 0; border-top: 1px solid #ccc; padding-top: 10px;">
            <h3 style="color: green;">TOTAL BAYAR: <span id="totalDisplay">Rp 0</span></h3>
            <button class="btn primary" onclick="openPaymentModal()">Bayar & Cetak</button>
        </div>
    </div>

    <div id="menuPage" class="page hidden">
        <h2>Daftar Menu Tersedia</h2>
        <div id="menuList" class="menu-grid">
            </div>
    </div>

    <div id="laporanPage" class="page hidden">
        <h2>Laporan Penjualan</h2>
        <div style="display: flex; gap: 5px; margin-bottom: 10px;">
            <button class="btn secondary" onclick="filterTransactions('today', this)">Hari Ini</button>
            <button class="btn secondary" onclick="filterTransactions('yesterday', this)">Kemarin</button>
            <button class="btn secondary" onclick="filterTransactions('month', this)">Bulan Ini</button>
        </div>
        <input type="date" id="reportDate" onchange="filterTransactions('date', this)" style="max-width: 150px; display: inline-block;">
        <button class="btn secondary" onclick="printReport()">Cetak Laporan</button>
        
        <hr style="margin: 15px 0;">

        <h3>Ringkasan:</h3>
        <div id="laporanSummary" style="padding: 10px; border: 1px solid #ddd; border-radius: 5px; margin-bottom: 15px;">
            <p>Pilih filter untuk melihat ringkasan.</p>
        </div>

        <h3>Sales by Menu (Product Mix):</h3>
        <div id="laporanMenuMix">
            <p>Data menu terlaris akan muncul di sini.</p>
        </div>

        <h3 style="margin-top: 20px;">DETAIL Transaksi:</h3>
        <div id="laporanList">
            </div>
    </div>
</div>

<div class="overlay" id="paymentModal">
  <div class="modal">
    <h3 id="modalTotal">Total Akhir: Rp 0</h3>
    <input type="number" id="manualBayar" placeholder="Nominal Bayar Tunai"/>
    <button class="btn primary" onclick="processManualPayment()">Bayar Tunai & Cetak Struk</button>
    
    <h4 style="margin: 10px 0;">Atau Pilih Metode Lain:</h4>
    <div id="paymentMethods"> 
      <button class="btn secondary" id="btnBayarPas" onclick="completePayment('Cash', currentFinalTotal)">Bayar Pas (Tunai)</button>
      <button class="btn secondary" onclick="openQrisModal()">QRIS (Scan Barcode)</button>
      <button class="btn secondary" onclick="completePayment('Gojek')">Gojek/Gopay</button>
      <button class="btn secondary" onclick="completePayment('Grab')">Grab/OVO</button>
      <button class="btn secondary" onclick="completePayment('Shopee')">ShopeePay</button>
    </div>
  </div>
</div>

<div class="overlay" id="qrisModal">
  <div class="modal">
    <h3>Scan QRIS Ini</h3>
    <img id="qrisImage" src="qris_placeholder.png" alt="QRIS Code" style="width: 150px; height: 150px; margin: 10px 0;"/>
    <p>Total Bayar: <span id="qrisAmount">Rp 0</span></p>
    <button class="btn primary" onclick="completePayment('QRIS')">Pembayaran Selesai</button>
    <button class="btn danger" onclick="$('qrisModal').style.display='none'">Batal</button>
  </div>
</div>

<script>
// <![CDATA[
// Global Variables
let currentUser = JSON.parse(localStorage.getItem('currentUser'));
let cart = JSON.parse(localStorage.getItem('cart')) || [];
let orderType = 'Offline'; 
let currentFinalTotal = 0; 

// Database/Store Mock-up
let store = {
    users: [
        { email: "manager@jif.com", password: "manager", role: "Manager", name: "Joko" },
        { email: "kasir@jif.com", password: "kasir", role: "Kasir", name: "Dina" }
    ],
    menu: [
        { id: 1, name: "MIX LOVER", price: 65000, category: "Large" },
        { id: 2, name: "PEPPERONI", price: 55000, category: "Large" },
        { id: 3, name: "KEJU MANIS", price: 45000, category: "Large" },
        { id: 4, name: "MIX LOVER", price: 45000, category: "Regular" },
        { id: 5, name: "PEPPERONI", price: 35000, category: "Regular" },
        { id: 6, name: "KEJU MANIS", price: 25000, category: "Regular" },
        { id: 7, name: "EXTRA CHEESE", price: 10000, category: "Extra" },
        { id: 8, name: "EXTRA TOPPING", price: 15000, category: "Extra" },
        { id: 9, name: "AIR MINERAL", price: 5000, category: "Minuman" }
    ],
    discounts: [
        { id: 1, name: "Diskon 10%", type: "percentage", value: 0.10 },
        { id: 2, name: "Potongan Rp 10.000", type: "fixed", value: 10000 }
    ],
    transactions: JSON.parse(localStorage.getItem('transactions')) || []
};

// Utility Functions
function $(id) { return document.getElementById(id); }

function formatRp(amount) {
    return 'Rp ' + amount.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}

function getDateOnly(date) {
    const d = new Date(date);
    d.setHours(0, 0, 0, 0);
    return d.getTime();
}

// Global Functions
function changePage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
    document.getElementById(pageId + 'Page').classList.remove('hidden');
    
    document.querySelectorAll('.navbar button').forEach(btn => btn.classList.remove('active-tab'));
    event.currentTarget.classList.add('active-tab');

    if (pageId === 'kasir') {
        renderMenuSelectorButtons();
        renderOrderItems();
    } else if (pageId === 'menu') {
        renderMenuList();
    } else if (pageId === 'laporan') {
        renderReportPage();
    }
}

// --- Login/Logout ---
function login() {
    const email = $("loginEmail").value.toLowerCase();
    const password = $("loginPassword").value;
    const user = store.users.find(u => u.email === email && u.password === password);

    if (user) {
        currentUser = user;
        localStorage.setItem('currentUser', JSON.stringify(user));
        
        $("loginPage").classList.add('hidden');
        $("appHeader").classList.remove('hidden');
        $("userEmailDisplay").innerText = user.email;
        $("userRoleDisplay").innerText = user.role;
        
        // Redirect to Home Page
        changePage('home'); 
        
        // Initial setup for Kasir/Laporan
        renderDiscountSelect();
        renderMenuSelectorButtons();
    } else {
        alert("Email atau password salah.");
    }
}

function logout() {
    currentUser = null;
    localStorage.removeItem('currentUser');
    localStorage.removeItem('cart');
    cart = [];
    changePage('login');
    $("appHeader").classList.add('hidden');
}

// --- Menu Rendering ---
function renderMenuList() {
    const menuList = $("menuList");
    menuList.innerHTML = '';
    
    store.menu.forEach(item => {
        const d = document.createElement('div');
        d.className = 'menu-item';
        d.innerHTML = `
            <strong>${item.name}</strong>
            <p style="font-size: 0.9em; color: #555;">(${item.category})</p>
            <p style="color: green;">${formatRp(item.price)}</p>
        `;
        menuList.appendChild(d);
    });
}

function renderMenuSelectorButtons() {
    const categories = Array.from(new Set(store.menu.map(item => item.category)));
    const container = $("menuSelectorButtons");
    container.innerHTML = `<button class="btn secondary" onclick="filterMenu('Semua', this)">Semua</button>`;
    
    categories.forEach(cat => {
        container.innerHTML += `<button class="btn secondary" onclick="filterMenu('${cat}', this)">${cat}</button>`;
    });
    
    // Default filter to "Semua"
    filterMenu('Semua', container.querySelector('button'));
}

function filterMenu(category, buttonElement) {
    document.querySelectorAll('#menuSelectorButtons button').forEach(btn => {
        btn.classList.remove('active-tab');
    });
    if (buttonElement) {
        buttonElement.classList.add('active-tab');
    }

    const filteredMenu = category === 'Semua' ? store.menu : store.menu.filter(item => item.category === category);
    
    const menuList = $("menuList");
    menuList.innerHTML = ''; // Clear previous menu
    
    filteredMenu.forEach(item => {
        const d = document.createElement('div');
        d.className = 'menu-item';
        d.onclick = () => addToCart(item);
        d.innerHTML = `
            <strong>${item.name}</strong>
            <p style="font-size: 0.9em; color: #555;">(${item.category})</p>
            <p style="color: green;">${formatRp(item.price)}</p>
        `;
        menuList.appendChild(d);
    });
}

// --- Cart/Order Management ---
function addToCart(menuItem) {
    const existingItem = cart.find(item => item.id === menuItem.id);
    
    if (existingItem) {
        existingItem.qty += 1;
    } else {
        cart.push({ ...menuItem, qty: 1 });
    }
    
    localStorage.setItem('cart', JSON.stringify(cart));
    renderOrderItems();
}

function renderOrderItems() {
    const orderItems = $("orderItems");
    let subtotal = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
    orderItems.innerHTML = '';
    
    cart.forEach(item => {
        const itemTotal = item.price * item.qty;
        const d = document.createElement('div');
        d.className = 'order-item-detail';
        d.innerHTML = `
            <div>
                <strong style="font-size: 1.1em;">${item.name}</strong> <span style="font-size: 0.9em; color: #777;">(${item.category})</span><br>
                ${item.qty} x ${formatRp(item.price)} = ${formatRp(itemTotal)}
            </div>
            <div>
                <button class="btn secondary" style="padding: 3px 6px; margin-right: 5px;" onclick="changeQty(${item.id}, 1)">+</button>
                <button class="btn secondary" style="padding: 3px 6px;" onclick="changeQty(${item.id}, -1)">-</button>
                <button class="btn danger delete-btn" onclick="removeFromCart(${item.id})">X</button>
            </div>
        `;
        orderItems.appendChild(d);
    });

    if (cart.length === 0) {
        orderItems.innerHTML = '<p>Keranjang kosong.</p>';
    }
    
    // Re-apply discount
    applyDiscount();
    
    // Update Order Type
    orderType = $("orderType").value;
}

function changeQty(id, delta) {
    const item = cart.find(i => i.id === id);
    if (item) {
        item.qty += delta;
        if (item.qty <= 0) {
            removeFromCart(id);
        } else {
            localStorage.setItem('cart', JSON.stringify(cart));
            renderOrderItems();
        }
    }
}

function removeFromCart(id) {
    cart = cart.filter(item => item.id !== id);
    localStorage.setItem('cart', JSON.stringify(cart));
    renderOrderItems();
}

// --- Discount Management ---
function renderDiscountSelect() {
    const select = $("discountSelect");
    select.innerHTML = '<option value="">Tidak Ada</option>';
    
    store.discounts.forEach(disc => {
        select.innerHTML += `<option value="${disc.id}">${disc.name}</option>`;
    });
}

function applyDiscount() {
    let subtotal = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
    const selectedDiscountId = $("discountSelect").value;
    let discountAmount = 0;
    
    if (selectedDiscountId) {
        const discount = store.discounts.find(d => d.id === parseInt(selectedDiscountId));
        if (discount) {
            if (discount.type === 'percentage') {
                discountAmount = subtotal * discount.value;
            } else if (discount.type === 'fixed') {
                discountAmount = discount.value;
            }
        }
    }
    
    const finalTotal = subtotal - discountAmount;
    currentFinalTotal = finalTotal;
    
    $("discountDisplay").innerText = formatRp(discountAmount);
    $("totalDisplay").innerText = formatRp(finalTotal);
}

// --- Payment ---
// FIX 2: Fungsi openPaymentModal() diperbarui untuk menyembunyikan tombol Bayar Pas
function openPaymentModal() {
    if (cart.length === 0) return alert("Keranjang masih kosong.");
    
    $("manualBayar").value = '';
    
    $("modalTotal").innerText = `Total Akhir: ${formatRp(currentFinalTotal)}`;
    $("paymentModal").style.display = "flex";

    // FIX 2: SEMBUNYIKAN TOMBOL BAYAR PAS JIKA ORDER TYPE = ONLINE
    const btnBayarPas = $("btnBayarPas");
    if (btnBayarPas) {
        if (orderType === 'Online') {
            btnBayarPas.style.display = 'none';
        } else {
            btnBayarPas.style.display = 'block'; // Tampilkan lagi jika Offline
        }
    }
}

function processManualPayment() {
    const bayar = parseFloat($("manualBayar").value) || 0;
    if (bayar < currentFinalTotal) {
        return alert(`Nominal bayar kurang. Kurang ${formatRp(currentFinalTotal - bayar)}`);
    }
    completePayment('Cash', bayar);
}

function openQrisModal() {
    $("qrisAmount").innerText = formatRp(currentFinalTotal);
    $("paymentModal").style.display = 'none';
    $("qrisModal").style.display = 'flex';
}

function completePayment(method, cashGiven = 0) {
    if (cart.length === 0) {
        alert("Keranjang kosong.");
        return;
    }
    
    const subtotal = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
    const selectedDiscountId = $("discountSelect").value;
    const discount = selectedDiscountId ? store.discounts.find(d => d.id === parseInt(selectedDiscountId)) : null;
    let discountAmount = 0;

    if (discount) {
        if (discount.type === 'percentage') {
            discountAmount = subtotal * discount.value;
        } else if (discount.type === 'fixed') {
            discountAmount = discount.value;
        }
    }

    const transaction = {
        id: Date.now(),
        date: new Date().toISOString(),
        user: currentUser.email,
        items: cart,
        subtotal: subtotal,
        discount: discount,
        discountAmount: discountAmount,
        total: currentFinalTotal,
        paymentMethod: method,
        orderType: $("orderType").value,
        note: $("customerNote").value || 'Pelanggan Tunai',
        cashGiven: cashGiven,
        change: cashGiven > currentFinalTotal ? cashGiven - currentFinalTotal : 0 
    };

    store.transactions.push(transaction);
    localStorage.setItem('transactions', JSON.stringify(store.transactions));

    // Print Receipt
    printReceipt(transaction);

    // Reset
    cart = [];
    localStorage.removeItem('cart');
    currentFinalTotal = 0;
    $("customerNote").value = '';
    $("discountSelect").value = '';
    
    // Close Modals
    $("paymentModal").style.display = 'none';
    $("qrisModal").style.display = 'none';
    
    // Re-render
    renderOrderItems();
    alert(`Transaksi Selesai. Kembalian: ${formatRp(transaction.change)}`);
}
// --- Laporan ---
function renderReportPage() {
    const allTrx = getFilteredTransactions(); // Get all to display summary initially
    renderSummary(allTrx, "Semua Transaksi");
    renderSalesByMenu(allTrx);
    renderTransactionDetails(allTrx);
    
    // Reset active button
    document.querySelectorAll('#laporanPage button.active-tab').forEach(btn => btn.classList.remove('active-tab'));
    $("reportDate").value = ''; // Clear date input
}

function filterTransactions(type, element) {
    document.querySelectorAll('#laporanPage button').forEach(btn => btn.classList.remove('active-tab'));
    if (element && element.tagName === 'BUTTON') {
        element.classList.add('active-tab');
    }

    const dateInputTrigger = type === 'date';
    const filteredTrx = getFilteredTransactions(type, dateInputTrigger);

    let filterLabel = "Semua Transaksi";
    if (type === 'today') filterLabel = "Hari Ini";
    else if (type === 'yesterday') filterLabel = "Kemarin";
    else if (type === 'month') {
        const monthNames = ["Januari", "Februari", "Maret", "April", "Mei", "Juni", "Juli", "Agustus", "September", "Oktober", "November", "Desember"];
        filterLabel = `Bulan ${monthNames[new Date().getMonth()]} ${new Date().getFullYear()}`;
    }
    else if (dateInputTrigger) filterLabel = $("reportDate").value;

    renderSummary(filteredTrx, filterLabel);
    renderSalesByMenu(filteredTrx);
    renderTransactionDetails(filteredTrx);
}

// FIX 4: Fungsi getFilteredTransactions() diperbaiki untuk filter bulanan
function getFilteredTransactions(filterType = null, dateInputTrigger = false) {
    const transactions = store.transactions;
    const now = new Date();
    const today = getDateOnly(now);
    let startDate = null;
    let endDate = null;
    
    if (dateInputTrigger) {
        const dateValue = $("reportDate").value;
        if (!dateValue) {
            return [];
        }
        startDate = getDateOnly(dateValue);
        endDate = startDate; 
    } else if (filterType === 'today') {
        startDate = today;
        endDate = today;
    } else if (filterType === 'yesterday') {
        startDate = today - (24 * 60 * 60 * 1000);
        endDate = startDate;
    } else if (filterType === 'month') {
        startDate = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
        // FIX 4: Menentukan hari pertama bulan berikutnya sebagai batas akhir (exclusive)
        endDate = new Date(now.getFullYear(), now.getMonth() + 1, 1).getTime(); 
    } 

    if (startDate !== null) {
        return transactions.filter(t => {
            const trxDateOnly = getDateOnly(t.date);
            
            if (filterType === 'today' || filterType === 'yesterday' || dateInputTrigger) {
                return trxDateOnly === startDate;
            }
            if (filterType === 'month') {
                // Gunakan < endDate (lebih kecil dari)
                return trxDateOnly >= startDate && trxDateOnly < endDate; 
            }
            return false;
        });
    }
    return transactions; 
}


// FIX 3: Fungsi renderSummary() diperbaiki untuk format ** menjadi <strong> (tampilan rapi)
function renderSummary(filteredTrx, filter) {
    const root = $("laporanSummary");
    const totalSales = filteredTrx.reduce((acc, t) => acc + t.total, 0);
    const totalSubtotal = filteredTrx.reduce((acc, t) => acc + (t.subtotal || t.total), 0);
    const totalDiscount = filteredTrx.reduce((acc, t) => acc + (t.discountAmount || 0), 0);
    const totalCount = filteredTrx.length;
    
    let salesByOutlet = {};
    filteredTrx.forEach(t => {
        const outlet = t.orderType || 'N/A';
        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;
    });
    
    // FIX 3: Menggunakan <strong> untuk tampilan yang rapi
    let outletHtml = Object.entries(salesByOutlet).map(([type, total]) => 
        `<p style="margin-left: 10px;">- ${type}: <strong>${formatRp(total)}</strong></p>`
    ).join('');

    // FIX 3: Menggunakan <strong> untuk tampilan yang rapi
    root.innerHTML = `
        <p>Periode Laporan: <strong>${filter}</strong></p> 
        <p>Total Transaksi: <strong>${totalCount}</strong> Nota</p>
        <p style="font-weight: bold; margin-top: 10px;">Sales Outlet:</p>
        ${outletHtml}
        <p style="font-size: 1.0em; color: #666; margin-top: 10px;">Subtotal Kotor: <strong>${formatRp(totalSubtotal)}</strong></p>
        <p style="font-size: 1.0em; color: #c62828;">Diskon Total: <strong>${formatRp(totalDiscount)}</strong></p>
        <p style="font-size: 1.2em; color: #2e7d32;">Total Penjualan Bersih: <strong>${formatRp(totalSales)}</strong></p>
    `;
}

// FIX 5: Fungsi renderSalesByMenu() menerapkan sorting menu terlaris
function renderSalesByMenu(filteredTrx) {
    const root = $("laporanMenuMix");
    let menuMix = {};
    
    filteredTrx.forEach(t => {
        t.items.forEach(item => {
            const key = `${item.name} (${item.category})`;
            menuMix[key] = menuMix[key] || { qty: 0, total: 0 };
            menuMix[key].qty += item.qty;
            menuMix[key].total += item.qty * item.price;
        });
    });

    // FIX 5: Sorting berdasarkan QTY Terjual (QTY) dari terbesar ke terkecil
    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty); 

    if (sortedMenu.length === 0) {
        root.innerHTML = "<p>Tidak ada data menu yang terjual.</p>";
        return;
    }

    let html = '<table class="report-table"><thead><tr><th>Nama Menu (Ukuran/Topping)</th><th>QTY Terjual</th><th>Total Penjualan</th></tr></thead><tbody>';
    
    sortedMenu.forEach(([key, data]) => {
        html += `<tr><td>${key}</td><td>${data.qty}</td><td>${formatRp(data.total)}</td></tr>`;
    });

    html += '</tbody></table>';
    root.innerHTML = html;
}

// FIX 3: Fungsi renderTransactionDetails() diperbaiki untuk format **
function renderTransactionDetails(filteredTrx) {
    const root=$("laporanList");
    root.innerHTML="";

    if(filteredTrx.length===0){
        root.innerHTML="<p>Tidak ada detail transaksi di periode ini.</p>";
        return;
    }
    
    const isManager = currentUser && currentUser.role === 'Manager'; 

    filteredTrx.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(t=>{
        const d=document.createElement("div");
        d.className="order-item";
        d.style.borderBottom = "1px solid #eee";
        d.style.marginBottom = "10px";
        
        const noteDisplay = t.note ? t.note : 'Tunai';

        const deleteBtn = isManager ? 
            `<button class='btn danger' style='padding: 5px 10px; font-size: 0.8em; margin-top: 5px; background: #c62828;' onclick='deleteTransaction(${t.id})'>Hapus Transaksi</button>` : '';

        const discountDisplay = (t.discount && t.discountAmount) ? 
            `<p style="margin: 5px 0; color: #d32f2f;">Diskon (${t.discount.name}): -${formatRp(t.discountAmount)}</p>` : ''; 
        
        const subtotalDisplay = t.subtotal ? `Subtotal: ${formatRp(t.subtotal)}` : `Subtotal: ${formatRp(t.total)}`;
        const paymentMethod = t.paymentMethod || 'Tunai'; 

        d.innerHTML=`
            <div><strong>Nota ID: ${t.id}</strong></div> <div>Waktu: ${new Date(t.date).toLocaleString("id-ID")}<br>Pelanggan/Driver: ${noteDisplay}<br>${t.orderType} | Bayar: ${paymentMethod} oleh Kasir: ${t.user}</div>
            <p style="margin: 5px 0;">Item: ${t.items.map(i => `${i.name} x${i.qty}`).join(', ')}</p>
            <div style="margin: 5px 0;">${subtotalDisplay}</div>
            ${discountDisplay} 
            <div style="font-weight: bold; color: #2e7d32;">Total Akhir: ${formatRp(t.total)}</div>
            ${deleteBtn}
        `;
        root.appendChild(d);
    });
}

function deleteTransaction(id) {
    if (confirm("Anda yakin ingin menghapus transaksi ini? Tindakan ini TIDAK dapat dibatalkan.")) {
        store.transactions = store.transactions.filter(t => t.id !== id);
        localStorage.setItem('transactions', JSON.stringify(store.transactions));
        renderReportPage();
        alert("Transaksi berhasil dihapus.");
    }
}

// --- Printing Functions ---

function printReceipt(trx) {
    const MAX_WIDTH = 40; 
    const w = window.open("", "Print Receipt", "width=400,height=600");

    const padLine = (label, value) => {
        const spaceCount = MAX_WIDTH - label.length - value.length;
        return label + ' '.repeat(Math.max(0, spaceCount)) + value;
    };

    let receiptContent = 
`        === JIF PIZZA CONDET ===
 ${new Date().toLocaleString("id-ID")}
 Kasir: ${trx.user}
 Nota: ${trx.id}
 ${padLine("Order Type:", trx.orderType)}
 ${padLine("Catatan:", trx.note)}
 ${'------------------------------------------'.substring(0, MAX_WIDTH)}
`;
    
    trx.items.forEach(item => {
        const itemTotal = formatRp(item.price * item.qty);
        const itemName = `${item.name} (${item.category})`;
        receiptContent += `${itemName}\n`;
        receiptContent += padLine(`   ${item.qty} x ${formatRp(item.price)}`, itemTotal) + '\n';
    });

    const subtotalLine = padLine("Subtotal:", formatRp(trx.subtotal));
    const discountLine = padLine(`Diskon (${trx.discount ? trx.discount.name : '0'}):`, `-${formatRp(trx.discountAmount)}`);
    const totalLine = padLine("TOTAL AKHIR:", formatRp(trx.total));
    const paymentLine = padLine(`Bayar (${trx.paymentMethod}):`, formatRp(trx.cashGiven || trx.total));
    const changeLine = padLine("Kembali:", formatRp(trx.change || 0));

    receiptContent += 
`${'------------------------------------------'.substring(0, MAX_WIDTH)}
${subtotalLine}
${discountLine}
${totalLine}
${'------------------------------------------'.substring(0, MAX_WIDTH)}
${paymentLine}
${changeLine}

 --- Terima Kasih & Sampai Jumpa ---
`;

    w.document.write(`
        <pre style='font-family:monospace; font-size: 14px; line-height: 1.2; width: 80mm; max-width: 80mm;'>
            ${receiptContent.trim()}
        </pre>
    `);
    w.document.close(); 
    w.print();
    w.close(); 
}

function printReport() {
    const MAX_WIDTH = 42; 
    const w = window.open("", "Print Report", "width=500,height=800");

    const padLine = (label, value) => {
        const spaceCount = MAX_WIDTH - label.length - value.length;
        return label + ' '.repeat(Math.max(0, spaceCount)) + value;
    };

    const filteredTrx = getFilteredTransactions($('laporanPage').querySelector('.active-tab')?.onclick.toString().match(/filterTransactions\('(\w+)'/)?.[1] || null, $('reportDate').value !== '');
    const totalSales = filteredTrx.reduce((acc, t) => acc + t.total, 0);
    const totalSubtotal = filteredTrx.reduce((acc, t) => acc + (t.subtotal || t.total), 0);
    const totalDiscount = filteredTrx.reduce((acc, t) => acc + (t.discountAmount || 0), 0);
    
    // Summary Text
    let reportPeriod = $("laporanSummary").querySelector('strong').innerText;

    // Sales by Outlet Detail
    let salesByOutlet = {};
    filteredTrx.forEach(t => {
        const outlet = t.orderType || 'N/A';
        salesByOutlet[outlet] = (salesByOutlet[outlet] || 0) + t.total;
    });
    let outletDetail = Object.entries(salesByOutlet).map(([type, total]) => 
        padLine(` - ${type}:`, formatRp(total))
    ).join('\n');
    
    // Sales by Menu Detail
    let menuMix = {};
    filteredTrx.forEach(t => {
        t.items.forEach(item => {
            const key = `${item.name} (${item.category})`;
            menuMix[key] = menuMix[key] || { qty: 0, total: 0 };
            menuMix[key].qty += item.qty;
        });
    });
    const sortedMenu = Object.entries(menuMix).sort(([, a], [, b]) => b.qty - a.qty); 

    let menuDetail = sortedMenu.map(([key, data]) => 
        padLine(`${key} (${data.qty}x)`, `${formatRp(data.total)}`)
    ).join('\n');


    const kasirLine = padLine("Kasir/Manager: ", currentUser ? currentUser.email : "-");
    const dateLine = padLine("Tanggal Cetak: ", new Date().toLocaleString("id-ID"));
    const totalTrxLine = padLine("Total Transaksi: ", `${filteredTrx.length} Nota`);

    w.document.write(`
        <pre style='font-family:monospace; font-size: 14px; line-height: 1.2; width: 80mm; max-width: 80mm;'>
        
 === LAPORAN PENJUALAN PERIODE ===
        
 Outlet: JIF PIZZA CONDET
 Periode: ${reportPeriod}
${kasirLine}
${dateLine}
        
${'__________________________________________'.substring(0, MAX_WIDTH)} 
RINGKASAN PENJUALAN
${totalTrxLine}
${padLine("Subtotal Kotor: ", formatRp(totalSubtotal))}
${padLine("Diskon Total: ", formatRp(totalDiscount))}
${padLine("TOTAL PENJUALAN AKHIR: ", formatRp(totalSales))}

${'__________________________________________'.substring(0, MAX_WIDTH)}
SALES BY OUTLET
${outletDetail}

${'__________________________________________'.substring(0, MAX_WIDTH)}
SALES BY MENU (PRODUCT MIX)
${menuDetail.trim()}
${'__________________________________________'.substring(0, MAX_WIDTH)}
==========================================
LAPORAN SELESAI
        </pre>
    `);
    w.print();
}

window.onload=()=>{
  if (currentUser) {
    if(currentUser.role === 'Manager'){
      $("userRoleDisplay").innerText = "Manager";
    }
    $("userEmailDisplay").innerText = currentUser.email;
    $("loginPage").classList.add('hidden');
    $("appHeader").classList.remove('hidden');
    
    // Ensure the home button is active on load
    document.querySelector('.navbar button').classList.add('active-tab');

    // Initial setup
    renderDiscountSelect();
    renderMenuSelectorButtons();

    // Default view
    changePage('home'); 
  } else {
    changePage('login');
    $("appHeader").classList.add('hidden');
  }
};
// ]]>
</script>
</body>
</html>