<!doctype html>
<html lang="id">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>JIF PIZZA POS v10.5 â€” Fixed Report Date Range</title>
<link rel="icon" href="logo.png"/>

<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="JIF POS">
<link rel="manifest" href="manifest.json">
<link rel="icon" sizes="192x192" href="logo.png">

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script> 

<style>
/* =========================================
   BAGIAN 1: CSS GLOBAL & HEADER
   ========================================= */
body{font-family:Segoe UI,Arial,sans-serif;margin:0;background:#fff;color:#222}
.hidden{display:none}
header.hidden, .navbar.hidden { display: none !important; }

/* LATAR BELAKANG GAMBAR HEADER (pizza.jpg) */
header{
  background:url('pizza.jpg') center/cover no-repeat; 
  color:#fff;
  padding:12px;
  text-align:center;
  position: relative; 
  z-index: 1; 
  height: 80px;
  overflow: hidden; 
}
header::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.4); /* Overlay gelap agar teks terbaca */
    z-index: 2;
}
header * { z-index: 3; position: relative; }
header h1 { margin: 0; font-size: 24px; }
header p { margin: 5px 0 0 0; font-size: 14px; }

/* =========================================
   BAGIAN 2: CSS NAVBAR & TOMBOL
   ========================================= */
.navbar {
  display:flex;
  justify-content:space-around;
  background:#0d6efd;
  padding:10px 0;
  box-shadow:0 2px 4px rgba(0,0,0,.1);
}
.navbar button {
  background:none;
  border:none;
  color:white;
  font-size:16px;
  cursor:pointer;
  padding:8px 15px;
  border-radius:4px;
  transition:background .2s;
  /* PERBAIKAN BAYANGAN TEKS: text-shadow dihilangkan agar teks tajam */
  text-shadow: none !important; 
}
.navbar button:hover {background:rgba(255,255,255,.2)}
.navbar button.active {background:#0a58ca;font-weight:700}
.role-info { color: #fff; font-size: 12px; margin-top: 5px;}

/* =========================================
   BAGIAN 3: CSS TABS & KASIR LAYOUT
   ========================================= */
.tab-content { padding:20px }
.kasir-layout {
  display:flex;
  gap:20px;
  margin-top:20px
}
.menu-section {
  flex:2;
  border-right:1px solid #ccc;
  padding-right:20px;
  max-height: calc(100vh - 180px); /* Batasi tinggi menu */
  overflow-y: auto;
}
.cart-section {
  flex:1;
  background:#f9f9f9;
  padding:15px;
  border-radius:8px;
  box-shadow:0 0 10px rgba(0,0,0,.05)
}
.menu-categories {
  display:flex;
  gap:10px;
  margin-bottom:15px
}
.menu-categories button {
  padding:8px 15px;
  background:#e9ecef;
  border:1px solid #ced4da;
  border-radius:4px;
  cursor:pointer;
  transition:background .2s
}
.menu-categories button.active {background:#0d6efd;color:white}
#menuList {
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(120px,1fr));
  gap:10px
}
.menu-item {
  border:1px solid #ced4da;
  padding:10px;
  text-align:center;
  cursor:pointer;
  border-radius:6px;
  transition:transform .1s;
  background:#fff
}
.menu-item:hover {
  transform:translateY(-2px);
  box-shadow:0 2px 5px rgba(0,0,0,.1)
}
.menu-item h4 {margin:0 0 5px 0;font-size:14px}
.menu-item p {margin:0;font-size:12px;color:#28a745;font-weight:700}
#cartItems {list-style:none;padding:0}
#cartItems li {
  display:flex;
  justify-content:space-between;
  align-items:center;
  padding:5px 0;
  border-bottom:1px dashed #eee
}
.remove-item {
  background:#dc3545;
  color:white;
  border:none;
  border-radius:50%;
  width:20px;
  height:20px;
  cursor:pointer;
  font-size:12px
}
.cart-summary {
  margin-top:15px;
  padding-top:10px;
  border-top:2px solid #ddd;
  font-size:16px
}
.cart-summary div {
  display:flex;
  justify-content:space-between;
  margin-bottom:5px
}
.total-final {
  font-size:18px;
  font-weight:700;
  color:#dc3545
}
#payButton {
  width:100%;
  padding:12px;
  background:#28a745;
  color:white;
  border:none;
  border-radius:6px;
  cursor:pointer;
  margin-top:15px;
  font-size:18px
}

/* =========================================
   BAGIAN 4: CSS MODAL & LAPORAN
   ========================================= */
.modal {
  position:fixed;
  top:0;
  left:0;
  width:100%;
  height:100%;
  background:rgba(0,0,0,.5);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:1000
}
.modal-content {
  background:#fff;
  padding:20px;
  border-radius:8px;
  width:90%;
  max-width:400px;
  position:relative;
  box-shadow:0 5px 15px rgba(0,0,0,.3)
}
.close-button {
  position:absolute;
  top:10px;
  right:15px;
  font-size:24px;
  cursor:pointer;
  color:#666
}

/* Modal Pembayaran - Perbaikan Jarak Tombol */
#paymentMethodSelector { 
    margin-bottom: 15px; 
    display: flex; /* Aktifkan Flexbox */
    flex-wrap: wrap; /* Memungkinkan tombol pindah baris jika layar kecil */
    gap: 10px; /* Jarak standar antar tombol */
}
#paymentMethodSelector button {
    padding: 10px;
    border: 1px solid #ccc;
    background: #f8f9fa;
    cursor: pointer;
    border-radius: 4px;
    transition: background 0.2s;
    flex-grow: 1; /* Memastikan tombol mengisi ruang jika memungkinkan */
    min-width: 100px; /* Batasan lebar minimum */
}
#paymentMethodSelector button.active {
    background: #0d6efd;
    color: white;
    border-color: #0d6efd;
}
.qris-display { text-align: center; padding: 10px; }
.qris-display img { max-width: 80%; height: auto; border: 1px solid #eee; border-radius: 6px; }

/* Laporan */
.report-controls {display: flex; gap: 10px; margin-bottom: 20px; align-items: center;}
.report-controls button {padding: 8px 12px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer;}
.report-summary-box {
    display: flex;
    justify-content: space-between;
    padding: 15px;
    background: #f0f8ff;
    border: 1px solid #bce8f1;
    border-radius: 8px;
    margin-bottom: 20px;
}
.report-summary-box > div {
    text-align: center;
    flex: 1;
}
.report-summary-box h3 { margin-top: 0; font-size: 14px; color: #0d6efd; }
.report-summary-box p { margin: 0; font-size: 18px; font-weight: bold; }
.report-detail-table, #menuSalesTable, #outletTable { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px;}
.report-detail-table th, .report-detail-table td, #menuSalesTable th, #menuSalesTable td, #outletTable th, #outletTable td { border: 1px solid #ccc; padding: 8px; text-align: left; }
.report-detail-table th { background: #eee; }
.trx-delete-btn { background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;}

/* =========================================
   BAGIAN 5: CSS MANAJEMEN MENU/DISKON
   ========================================= */
.management-section { display: flex; gap: 20px; margin-top: 20px; }
.menu-editor-section, .discount-editor-section { flex: 1; }
.form-group { margin-bottom: 15px; }
.form-group label { display: block; margin-bottom: 5px; font-weight: bold; }
.form-group input, .form-group select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
.management-section button { padding: 10px 15px; background: #0d6efd; color: white; border: none; border-radius: 4px; cursor: pointer; }
#menuListEditor, #discountList { list-style: none; padding: 0; margin-top: 15px;}
#menuListEditor li, #discountList li { display: flex; justify-content: space-between; align-items: center; padding: 10px; border: 1px solid #eee; border-radius: 4px; margin-bottom: 5px; background: #f9f9f9; }
.del-btn { background: #dc3545; color: white; border: none; padding: 5px 8px; border-radius: 4px; cursor: pointer; font-size: 12px;}
</style>
</head>
<body>
<header id="appHeader" class="hidden">
    <h1>JIF PIZZA POS</h1>
    <p>Condet Outlet | <span id="userRoleDisplay"></span></p>
</header>

<nav class="navbar hidden" id="appNavbar">
    <button id="navHome" onclick="showTab('home')">Home</button>
    <button id="navKasir" onclick="showTab('kasir')">Kasir</button>
    <button id="navLaporan" onclick="showTab('laporan')">Laporan</button>
    <button id="navMenu" onclick="showTab('menu')">Menu</button>
    <button id="navLogout" onclick="logout()">Logout</button>
</nav>

<main id="appContent">
    
    <div id="loginTab" class="tab-content">
        <h2>Login Aplikasi</h2>
        <div class="form-group">
            <label for="loginEmail">Email:</label>
            <input type="email" id="loginEmail" value="manager@jif.com">
        </div>
        <div class="form-group">
            <label for="loginPassword">Password:</label>
            <input type="password" id="loginPassword" value="123">
        </div>
        <button onclick="login()">Login</button>
        <p style="margin-top: 20px;">Belum punya akun? <button onclick="showRegister()" style="background: none; color: #0d6efd; border: none; padding: 0; cursor: pointer;">Daftar (User)</button></p>
    </div>

    <div id="registerTab" class="tab-content hidden">
        <h2>Daftar Akun Kasir Baru</h2>
        <div class="form-group">
            <label for="registerEmail">Email:</label>
            <input type="email" id="registerEmail" placeholder="kasir@jif.com">
        </div>
        <div class="form-group">
            <label for="registerPassword">Password:</label>
            <input type="password" id="registerPassword">
        </div>
        <button onclick="register()">Daftar</button>
        <p style="margin-top: 20px;"><button onclick="showLogin()" style="background: none; color: #0d6efd; border: none; padding: 0; cursor: pointer;">Kembali ke Login</button></p>
    </div>

    <div id="homeTab" class="tab-content hidden">
        <h2>Dashboard</h2>
        <p>Selamat datang, <span id="userEmailDisplay"></span>.</p>
        <p>Anda login sebagai: <strong id="userRoleHome"></strong></p>
        <p>Akses cepat:</p>
        <button onclick="showTab('kasir')">Mulai Jual</button>
        <button onclick="showTab('laporan')">Lihat Laporan</button>
    </div>

    <div id="kasirTab" class="tab-content hidden">
        <h2>Kasir</h2>
        
        <div class="kasir-layout">
            
            <div class="menu-section">
                <div class="form-group">
                    <label>Tipe Order:</label>
                    <select id="orderTypeSelector" onchange="renderMenus()">
                        <option value="Offline">Offline (Makan di Tempat)</option>
                        <option value="Online">Online (GoFood/GrabFood)</option>
                    </select>
                </div>
                
                <div class="menu-categories" id="menuCategories">
                    </div>
                
                <div id="menuList">
                    </div>
            </div>
            
            <div class="cart-section">
                <h3>Pesanan (<span id="cartCount">0</span>)</h3>
                <ul id="cartItems">
                    </ul>
                
                <div class="cart-summary">
                    <div>
                        <span>Subtotal</span>
                        <span id="subtotalDisplay">Rp 0</span>
                    </div>
                    <div>
                        <span>Diskon (<span id="discountPercent">0%</span>)</span>
                        <span id="discountDisplay">- Rp 0</span>
                    </div>
                    <div class="total-final">
                        <span>TOTAL BAYAR</span>
                        <span id="totalDisplay">Rp 0</span>
                    </div>
                    
                    <div class="form-group" style="margin-top: 15px;">
                        <label for="discountSelector">Pilih Diskon:</label>
                        <select id="discountSelector" onchange="calculateTotal()">
                            </select>
                    </div>

                    <div class="form-group">
                        <label for="trxNote">Catatan Transaksi (Opsional):</label>
                        <input type="text" id="trxNote" placeholder="Nama pelanggan, nomor meja, dll.">
                    </div>

                    <button id="payButton" onclick="openPaymentModal()">Bayar & Cetak</button>
                </div>
            </div>
        </div>
    </div>
    <div id="laporanTab" class="tab-content hidden">
        <h2>Laporan Penjualan</h2>

        <div class="report-controls">
            <label for="reportDate">Pilih Tanggal:</label>
            <input type="date" id="reportDate" onchange="setReportDate('manual')"> 
            <button onclick="setReportDate('today')">Hari Ini</button>
            <button onclick="setReportDate('yesterday')">Kemarin</button>
            <button onclick="setReportDate('thisWeek')">Minggu Ini</button>
            <button onclick="setReportDate('thisMonth')">Bulan Ini</button>
            <button onclick="printReport()">Cetak Laporan Penjualan</button>
        </div>
        
        <div class="report-summary-box">
            <div>
                <h3>Total Transaksi</h3>
                <p id="totalTrxCount">0</p>
            </div>
            <div>
                <h3>Total Diskon</h3>
                <p id="totalTrxDiscount">Rp 0</p>
            </div>
            <div>
                <h3>Total Penjualan</h3>
                <p id="totalTrxSales">Rp 0</p>
            </div>
        </div>

        <h3>Grafik Penjualan Harian (per Jam)</h3>
        <canvas id="salesChart" width="400" height="150"></canvas>

        <h3>Sales by Menu (Product Mix)</h3>
        <div style="max-height: 250px; overflow-y: auto;">
             <table id="menuSalesTable">
                </table>
        </div>
       
        <h3>Detail Transaksi</h3>
        <div style="max-height: 300px; overflow-y: auto;">
             <table id="reportDetailTable" class="report-detail-table">
                </table>
        </div>
    </div>

    <div id="menuTab" class="tab-content hidden">
        <h2>Manajemen Menu & Diskon</h2>
        
        <div class="management-section">
            <div class="menu-editor-section">
                <h3>Kelola Menu</h3>
                <div class="form-group">
                    <label for="menuName">Nama Menu:</label>
                    <input type="text" id="menuName">
                </div>
                <div class="form-group">
                    <label for="menuCategory">Kategori:</label>
                    <select id="menuCategory">
                        <option value="Large">Large</option>
                        <option value="Reguler">Reguler</option>
                        <option value="Extra">Extra</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="menuPriceOffline">Harga Offline (Rp):</label>
                    <input type="number" id="menuPriceOffline">
                </div>
                <div class="form-group">
                    <label for="menuMarkupOnline">Markup Online (%):</label>
                    <input type="number" id="menuMarkupOnline" value="20" min="0">
                </div>
                <button onclick="addMenu()">Tambah Menu</button>
                
                <ul id="menuListEditor">
                    </ul>
            </div>
            
            <div class="discount-editor-section">
                <h3>Kelola Diskon</h3>
                <div class="form-group">
                    <label for="discountName">Nama Diskon:</label>
                    <input type="text" id="discountName">
                </div>
                <div class="form-group">
                    <label for="discountType">Tipe Diskon:</label>
                    <select id="discountType">
                        <option value="percentage">Persentase (%)</option>
                        <option value="nominal">Nominal (Rp)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="discountValue">Nilai Diskon:</label>
                    <input type="number" id="discountValue">
                </div>
                <button onclick="addDiscount()">Tambah Diskon</button>

                <ul id="discountList">
                    </ul>
            </div>
        </div>
    </div>
</main>

<div id="paymentModal" class="modal hidden">
    <div class="modal-content">
        <span class="close-button" onclick="closeModal('paymentModal')">&times;</span>
        <h3>Pembayaran</h3>
        <p>Total Akhir: <strong id="modalTotalDisplay" style="color:#dc3545; font-size: 20px;">Rp 0</strong></p>
        
        <div id="paymentMethodSelector">
            <button id="btnTunai" onclick="selectPayment('Tunai')" class="active">Bayar Pas / Tunai</button>

            <button id="btnQRIS" onclick="selectPayment('QRIS')">QRIS</button>
            <button id="btnShopee" onclick="selectPayment('Shopee')">Shopee Pay</button>
            <button id="btnGrab" onclick="selectPayment('Grab')">Grab Pay</button>
            <button id="btnGojek" onclick="selectPayment('Gojek')">Go Pay</button>
        </div>
        
        <div id="tunaiSection">
            <div class="form-group">
                <label for="manualBayar">Bayar (Rp):</label>
                <input type="number" id="manualBayar" placeholder="Masukkan jumlah uang" oninput="calculateKembali()">
            </div>
            <p>Kembalian: <strong id="kembaliDisplay">Rp 0</strong></p>
            <button onclick="processPayment('Tunai')">Proses Pembayaran & Cetak Struk</button>
        </div>

        <div id="qrisSection" class="hidden">
            <p>Silakan Scan QR Code di bawah ini:</p>
            <div class="qris-display">
                <img src="IMG-20251115-WA0000.jpg" alt="QRIS Payment">
            </div>
            <button onclick="processPayment(currentPaymentMethod)">Konfirmasi Pembayaran Berhasil</button>
        </div>
    </div>
</div>
<script>
/* =========================================
   BAGIAN 6: JAVASCRIPT: INIT, GLOBAL, HELPER
   ========================================= */
const $ = id => document.getElementById(id);
const STORE_KEY = 'jifPizzaPOSData';
const CATEGORIES = ['Large', 'Reguler', 'Extra'];
const MAX_WIDTH = 40; // Lebar Struk (40 karakter)

let store = {
    users: [
        { email: 'manager@jif.com', password: '123', role: 'Manager' },
        { email: 'kasir@jif.com', password: '456', role: 'Kasir' }
    ],
    menus: [
        { name: 'Margherita', category: 'Large', priceOffline: 80000, markupOnline: 20 },
        { name: 'Pepperoni', category: 'Large', priceOffline: 90000, markupOnline: 20 },
        { name: 'Cheese', category: 'Reguler', priceOffline: 50000, markupOnline: 20 },
        { name: 'Mushroom', category: 'Reguler', priceOffline: 55000, markupOnline: 20 },
        { name: 'Soda', category: 'Extra', priceOffline: 10000, markupOnline: 10 },
        { name: 'Fries', category: 'Extra', priceOffline: 15000, markupOnline: 10 }
    ],
    discounts: [
        { id: 1, name: 'Diskon 10%', type: 'percentage', value: 10 },
        { id: 2, name: 'Potongan Rp 5.000', type: 'nominal', value: 5000 }
    ],
    transactions: []
};

let currentUser = null;
let cart = [];
let chartInstance = null;
let currentCategory = CATEGORIES[0];
let nextTrxId = 1;

// Global variabel untuk menyimpan rentang tanggal laporan saat ini (Perbaikan Laporan)
let currentReportStartDate = new Date(0);
let currentReportEndDate = new Date();


function loadStore() {
    const savedData = localStorage.getItem(STORE_KEY);
    if (savedData) {
        // Gabungkan data tersimpan dengan default, pastikan semua kunci ada
        const loadedStore = JSON.parse(savedData);
        store = { ...store, ...loadedStore };
    }
    // Set nextTrxId berdasarkan transaksi terakhir
    if (store.transactions.length > 0) {
        const lastId = store.transactions[store.transactions.length - 1].id;
        nextTrxId = lastId + 1;
    }
}

function saveStore() {
    localStorage.setItem(STORE_KEY, JSON.stringify(store));
}

function formatRp(amount) {
    return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
}

function calculateMenuPrice(menu, orderType) {
    const price = menu.priceOffline;
    if (orderType === 'Online' && menu.markupOnline > 0) {
        return price + (price * menu.markupOnline / 100);
    }
    return price;
}

/* =========================================
   BAGIAN 7: JAVASCRIPT: AUTHENTICATION & NAVIGASI
   ========================================= */

function showTab(tabId) {
    const tabs = ['loginTab', 'registerTab', 'homeTab', 'kasirTab', 'laporanTab', 'menuTab'];
    tabs.forEach(id => $(id).classList.add('hidden'));
    $(tabId + 'Tab').classList.remove('hidden');

    // Update active navbar button
    document.querySelectorAll('.navbar button').forEach(btn => btn.classList.remove('active'));
    const activeBtn = $(`nav${tabId.charAt(0).toUpperCase() + tabId.slice(1)}`);
    if (activeBtn) activeBtn.classList.add('active');

    // Khusus Laporan: render saat tab dibuka
    if (tabId === 'laporan') {
        // Panggil setReportDate('today') untuk menginisialisasi rentang dan render
        setReportDate('today'); 
    }
    // Khusus Menu: render saat tab dibuka (jika Manajer)
    if (tabId === 'menu' && currentUser.role === 'Manager') {
        renderMenuEditor();
        renderDiscountEditor();
    }

    // Tampilkan/Sembunyikan Menu Tab
    if (currentUser && currentUser.role !== 'Manager') {
        $('navMenu').classList.add('hidden');
    } else {
         $('navMenu').classList.remove('hidden');
    }
}

function showLogin() { showTab('login'); }
function showRegister() { showTab('register'); }

function login() {
    const email = $('loginEmail').value;
    const password = $('loginPassword').value;
    const user = store.users.find(u => u.email === email && u.password === password);

    if (user) {
        currentUser = user;
        $('userEmailDisplay').innerText = currentUser.email;
        $('userRoleDisplay').innerText = currentUser.role;
        $('userRoleHome').innerText = currentUser.role;
        $('appHeader').classList.remove('hidden');
        $('appNavbar').classList.remove('hidden');
        showTab('home');
        renderCategories();
        renderMenus();
        renderDiscountsSelector();
    } else {
        alert('Login gagal. Email atau password salah.');
    }
}

function register() {
    const email = $('registerEmail').value;
    const password = $('registerPassword').value;
    
    if (!email || !password) {
        alert('Email dan Password harus diisi.');
        return;
    }
    if (store.users.some(u => u.email === email)) {
        alert('Email sudah terdaftar.');
        return;
    }

    const newUser = { email: email, password: password, role: 'Kasir' };
    store.users.push(newUser);
    saveStore();
    alert('Registrasi berhasil. Silakan login.');
    showLogin();
}

function logout() {
    const print = confirm("Yakin ingin Logout? Sebelum logout, apakah Anda ingin mencetak laporan closing?");
    if (print) {
        printReport(true); // Cetak laporan closing
    }
    currentUser = null;
    $('appHeader').classList.add('hidden');
    $('appNavbar').classList.add('hidden');
    showTab('login');
}

/* =========================================
   BAGIAN 8: JAVASCRIPT: KASIR (MENU & CART)
   ========================================= */

function renderCategories() {
    const container = $('menuCategories');
    container.innerHTML = '';
    CATEGORIES.forEach(cat => {
        const btn = document.createElement('button');
        btn.innerText = cat;
        btn.classList.toggle('active', cat === currentCategory);
        btn.onclick = () => {
            currentCategory = cat;
            renderCategories();
            renderMenus();
        };
        container.appendChild(btn);
    });
}

function renderMenus() {
    const list = $('menuList');
    list.innerHTML = '';
    const orderType = $('orderTypeSelector').value;
    
    store.menus
        .filter(menu => menu.category === currentCategory)
        .forEach((menu, index) => {
            const price = calculateMenuPrice(menu, orderType);
            const item = document.createElement('div');
            item.className = 'menu-item';
            item.onclick = () => addToCart(menu, price);
            item.innerHTML = `
                <h4>${menu.name}</h4>
                <p>${formatRp(price)}</p>
                ${orderType === 'Online' && menu.markupOnline > 0 ? `<small style="color:orange;">+${menu.markupOnline}% Markup</small>` : ''}
            `;
            list.appendChild(item);
        });
}

function addToCart(menu, price) {
    const existingItem = cart.find(item => item.name === menu.name);
    if (existingItem) {
        existingItem.qty++;
        existingItem.price = price; // Perbarui harga jika orderType berubah
    } else {
        cart.push({ name: menu.name, qty: 1, price: price });
    }
    renderCart();
}

function removeFromCart(index) {
    cart.splice(index, 1);
    renderCart();
}

function renderCart() {
    const list = $('cartItems');
    list.innerHTML = '';
    let subtotal = 0;

    cart.forEach((item, index) => {
        const li = document.createElement('li');
        const itemTotal = item.qty * item.price;
        subtotal += itemTotal;
        li.innerHTML = `
            <span>${item.qty}x ${item.name}</span>
            <span>${formatRp(itemTotal)} <button class="remove-item" onclick="removeFromCart(${index})">&times;</button></span>
        `;
        list.appendChild(li);
    });

    $('cartCount').innerText = cart.length;
    $('subtotalDisplay').innerText = formatRp(subtotal);
    calculateTotal();
}

function renderDiscountsSelector() {
    const selector = $('discountSelector');
    selector.innerHTML = '<option value="">-- Tanpa Diskon --</option>';
    store.discounts.forEach(d => {
        const option = document.createElement('option');
        option.value = d.id;
        option.innerText = `${d.name} (${d.type === 'percentage' ? d.value + '%' : formatRp(d.value)})`;
        selector.appendChild(option);
    });
}

function calculateTotal() {
    const subtotal = cart.reduce((sum, item) => sum + (item.qty * item.price), 0);
    const selectedDiscountId = $('discountSelector').value;
    let discountAmount = 0;
    
    if (selectedDiscountId) {
        const discount = store.discounts.find(d => d.id == selectedDiscountId);
        if (discount) {
            if (discount.type === 'percentage') {
                discountAmount = subtotal * (discount.value / 100);
                $('discountPercent').innerText = `${discount.value}%`;
            } else if (discount.type === 'nominal') {
                discountAmount = discount.value;
                $('discountPercent').innerText = `Rp ${discount.value}`;
            }
        }
    } else {
        $('discountPercent').innerText = '0%';
    }

    const finalTotal = subtotal - discountAmount;
    
    $('discountDisplay').innerText = `- ${formatRp(discountAmount)}`;
    $('totalDisplay').innerText = formatRp(finalTotal);
    
    return { subtotal, discountAmount, finalTotal };
}

/* =========================================
   BAGIAN 9: JAVASCRIPT: PEMBAYARAN & TRANSAKSI
   ========================================= */

let currentPaymentMethod = 'Tunai';

function openPaymentModal() {
    if (cart.length === 0) {
        alert("Keranjang masih kosong.");
        return;
    }
    const { finalTotal } = calculateTotal();
    $('modalTotalDisplay').innerText = formatRp(finalTotal);
    $('paymentModal').classList.remove('hidden');
    
    // LOGIKA PEMBAYARAN BERDASARKAN TIPE ORDER (v10.4)
    const orderType = $('orderTypeSelector').value;
    const isOnline = orderType === 'Online';

    // 1. Tombol E-Wallet/Online (Shopee, Grab, Gojek) -> Hanya tampil jika Online
    $('btnShopee').classList.toggle('hidden', !isOnline);
    $('btnGrab').classList.toggle('hidden', !isOnline);
    $('btnGojek').classList.toggle('hidden', !isOnline);
    
    // 2. Tombol Offline (Tunai, QRIS) -> Hanya tampil jika Offline
    $('btnTunai').classList.toggle('hidden', isOnline); // Sembunyikan Tunai jika Online
    $('btnQRIS').classList.toggle('hidden', isOnline);  // Sembunyikan QRIS jika Online

    // Set metode pembayaran default yang valid
    let defaultMethod = 'Tunai';
    if (isOnline) {
        // Cari tombol online pertama yang tidak tersembunyi
        if (!$('btnShopee').classList.contains('hidden')) defaultMethod = 'Shopee';
        else if (!$('btnGrab').classList.contains('hidden')) defaultMethod = 'Grab';
        else if (!$('btnGojek').classList.contains('hidden')) defaultMethod = 'Gojek';
    } else {
        // Default ke Tunai untuk Offline
        defaultMethod = 'Tunai';
    }

    selectPayment(defaultMethod);
    $('manualBayar').value = '';
    $('kembaliDisplay').innerText = formatRp(0);
}

function closeModal(modalId) {
    $(modalId).classList.add('hidden');
}

// FUNGSI INI TETAP (hanya mengelola status aktif dan section Tunai/QRIS)
function selectPayment(method) {
    currentPaymentMethod = method;
    
    // 1. Tentukan apakah ini pembayaran Tunai (Cash)
    const isCash = method === 'Tunai';
    const isQRIS = method === 'QRIS';
    
    // 2. Tampilkan atau sembunyikan section yang relevan
    $('tunaiSection').classList.toggle('hidden', !isCash);
    $('qrisSection').classList.toggle('hidden', !isQRIS);
    
    // 3. Update status 'active' pada SEMUA tombol
    document.querySelectorAll('#paymentMethodSelector button').forEach(btn => {
        btn.classList.remove('active');
    });
    
    // Set active state untuk tombol yang diklik
    if (method === 'Tunai') $('btnTunai').classList.add('active');
    else if (method === 'QRIS') $('btnQRIS').classList.add('active');
    else if (method === 'Shopee') $('btnShopee').classList.add('active');
    else if (method === 'Grab') $('btnGrab').classList.add('active');
    else if (method === 'Gojek') $('btnGojek').classList.add('active');

    // Kosongkan input bayar saat pindah mode
    if (!isCash) {
        $('manualBayar').value = '';
        $('kembaliDisplay').innerText = formatRp(0);
    }
}

function calculateKembali() {
    const bayar = parseFloat($('manualBayar').value) || 0;
    const { finalTotal } = calculateTotal();
    const kembali = bayar - finalTotal;
    $('kembaliDisplay').innerText = formatRp(kembali);
}

function processPayment(paymentMethod) {
    const { subtotal, discountAmount, finalTotal } = calculateTotal();
    const note = $('trxNote').value;
    let bayar = finalTotal;
    let kembali = 0;
    
    if (paymentMethod === 'Tunai') {
        bayar = parseFloat($('manualBayar').value) || 0;
        kembali = bayar - finalTotal;
        if (bayar < finalTotal) {
            alert('Jumlah pembayaran tunai kurang.');
            return;
        }
    } else {
        // Untuk QRIS, Shopee, Grab, Gojek, kita asumsikan Bayar = Total
        bayar = finalTotal;
        kembali = 0;
    }

    const newTransaction = {
        id: nextTrxId++,
        date: new Date().toISOString(),
        kasir: currentUser.email,
        items: JSON.parse(JSON.stringify(cart)), // Deep copy cart
        subtotal: subtotal,
        discount: discountAmount,
        total: finalTotal,
        bayar: bayar,
        kembali: kembali,
        orderType: $('orderTypeSelector').value,
        paymentMethod: paymentMethod,
        note: note
    };

    store.transactions.push(newTransaction);
    saveStore();

    printStruk(subtotal, discountAmount, finalTotal, bayar, kembali, note, paymentMethod);

    // Reset Kasir
    cart = [];
    renderCart();
    $('trxNote').value = '';
    $('discountSelector').value = '';
    closeModal('paymentModal');
}

// Fungsi untuk membuat baris rata kiri-kanan pada struk
function padLine(left, right) {
    const spaceCount = MAX_WIDTH - left.length - right.length;
    return left + ' '.repeat(Math.max(0, spaceCount)) + right;
}

function printStruk(subtotal, discountAmount, finalTotal, bayar, kembali, note, paymentMethod) {
    const w = window.open('', 'Struk', 'width=300,height=600');
    if (!w) {
        alert("Browser memblokir pop-up. Izinkan pop-up untuk mencetak struk.");
        return;
    }

    const trDate = new Date().toLocaleString("id-ID");
    const kasir = currentUser.email;

    let itemsContent = cart.map(item => {
        const itemTotal = formatRp(item.qty * item.price);
        const itemPrice = formatRp(item.price);
        const line1 = padLine(`${item.qty}x ${item.name}`, itemTotal);
        const line2 = `   @ ${itemPrice}`;
        return line1 + '\n' + line2;
    }).join('\n');

    w.document.write(`
        <pre style='font-family:monospace; font-size: 14px; line-height: 1.2; width: 80mm; max-width: 80mm; padding: 10px;'>
        
        === JIF PIZZA CONDET ===
        
${padLine("Nota ID:", nextTrxId - 1)}
${padLine("Tanggal:", trDate)}
${padLine("Kasir:", kasir)}
${padLine("Order Tipe:", $('orderTypeSelector').value)}
${note ? padLine("Catatan:", note) : ''}
        
        ${'----------------------------------------'.substring(0, MAX_WIDTH)}
${itemsContent}
        ${'----------------------------------------'.substring(0, MAX_WIDTH)}
${padLine("Subtotal", formatRp(subtotal))}
${padLine("Diskon", formatRp(discountAmount))}
        
${padLine("TOTAL AKHIR", formatRp(finalTotal))}
        ${'----------------------------------------'.substring(0, MAX_WIDTH)}
${padLine("Metode Bayar:", paymentMethod)}
${padLine("Dibayar", formatRp(bayar))}
${padLine("Kembalian", formatRp(kembali))}
        
        ${'----------------------------------------'.substring(0, MAX_WIDTH)}
        Terima kasih!
        </pre>
    `);
    w.print();
    w.close();
}


/* =========================================
   BAGIAN 10: JAVASCRIPT: LAPORAN
   ========================================= */

// Logika penentuan tanggal diubah untuk mendukung rentang tanggal
function setReportDate(period) {
    const today = new Date();
    let startDate = new Date(0); // Default ke semua data
    let endDate = new Date(today.getFullYear() + 1, 0, 1); // Default ke masa depan

    switch(period) {
        case 'today':
            startDate = new Date(today);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(today);
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'yesterday':
            startDate = new Date(today);
            startDate.setDate(today.getDate() - 1);
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date(today);
            endDate.setDate(today.getDate() - 1);
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'thisWeek':
            const day = today.getDay(); // 0 = Minggu, 1 = Senin, dst.
            startDate = new Date(today);
            // Hitung tanggal mulai Senin (day - (day - 1) atau day + 6 jika Minggu)
            startDate.setDate(today.getDate() - day + (day === 0 ? -6:1)); 
            startDate.setHours(0, 0, 0, 0);
            endDate = new Date();
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'thisMonth':
            // Mulai tanggal 1 bulan ini (00:00:00)
            startDate = new Date(today.getFullYear(), today.getMonth(), 1);
            startDate.setHours(0, 0, 0, 0);
            
            // Akhir bulan ini (Hari ke-0 dari bulan depan, 23:59:59)
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            endDate.setHours(23, 59, 59, 999);
            break;
        case 'manual':
            const dateInput = $('reportDate').value;
            if (dateInput) {
                // Jika input tanggal diisi, perlakukan sebagai rentang satu hari
                startDate = new Date(dateInput);
                startDate.setHours(0, 0, 0, 0);
                
                endDate = new Date(dateInput);
                endDate.setHours(23, 59, 59, 999);
            } else {
                // Jika input tanggal dikosongkan, kembali ke 'Semua Data'
                startDate = new Date(0);
                endDate = new Date(today.getFullYear() + 1, 0, 1);
            }
            break;
    }
    
    // Simpan rentang tanggal yang dipilih
    currentReportStartDate = startDate;
    currentReportEndDate = endDate;

    // Hanya tampilkan tanggal awal di input untuk rentang yang dipilih (agar terlihat jelas)
    if (period !== 'manual') {
         const yyyy = startDate.getFullYear();
         const mm = String(startDate.getMonth() + 1).padStart(2, '0');
         const dd = String(startDate.getDate()).padStart(2, '0');
         $('reportDate').value = `${yyyy}-${mm}-${dd}`;
    }

    renderReport();
}

// renderReport sekarang menggunakan variabel global
function renderReport() {
    const startDate = currentReportStartDate;
    const endDate = currentReportEndDate;
    
    const filteredTrx = store.transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate >= startDate && tDate <= endDate;
    });

    let totalTrxCount = filteredTrx.length;
    let totalSubtotal = 0;
    let totalDiscount = 0;
    let totalSales = 0;
    let menuSalesMap = {}; // {menuName: {qty: N, sales: R}}
    let hourlySales = Array(24).fill(0);

    // Kalkulasi
    filteredTrx.forEach(t => {
        totalSubtotal += t.subtotal;
        totalDiscount += t.discount;
        totalSales += t.total;
        
        const hour = new Date(t.date).getHours();
        hourlySales[hour] += t.total;
        
        t.items.forEach(item => {
            const itemName = item.name;
            const itemSales = item.qty * item.price;
            if (!menuSalesMap[itemName]) {
                menuSalesMap[itemName] = { qty: 0, sales: 0 };
            }
   menuSalesMap[itemName].qty += item.qty;
            menuSalesMap[itemName].sales += itemSales;
        });
    });

    // Render Summary
    $('totalTrxCount').innerText = totalTrxCount;
    $('totalTrxDiscount').innerText = formatRp(totalDiscount);
    $('totalTrxSales').innerText = formatRp(totalSales);

    // Render Chart
    renderSalesChart(hourlySales);
    
    // Render Sales by Menu
    renderMenuSalesTable(menuSalesMap);

    // Render Detail Transaksi
    renderDetailTable(filteredTrx);
}

function renderSalesChart(hourlySales) {
    if (chartInstance) {
        chartInstance.destroy();
    }
    
    const ctx = $('salesChart').getContext('2d');
    
    chartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: Array.from({ length: 24 }, (_, i) => `${i}:00`),
            datasets: [{
                label: 'Penjualan (Rp)',
                data: hourlySales,
                backgroundColor: 'rgba(13, 110, 253, 0.5)',
                borderColor: 'rgba(13, 110, 253, 1)',
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            scales: {
                y: {
                    beginAtZero: true
                }
            }
        }
    });
}

function renderMenuSalesTable(menuSalesMap) {
    const table = $('menuSalesTable');
    let html = `<thead><tr><th>Nama Menu</th><th>QTY</th><th>Total Penjualan</th></tr></thead><tbody>`;
    
    const sortedMenus = Object.entries(menuSalesMap).sort(([, a], [, b]) => b.sales - a.sales);

    sortedMenus.forEach(([name, data]) => {
        html += `
            <tr>
                <td>${name}</td>
                <td>${data.qty}</td>
                <td>${formatRp(data.sales)}</td>
            </tr>
        `;
    });
    
    html += '</tbody>';
    table.innerHTML = html;
}

function renderDetailTable(transactions) {
    const table = $('reportDetailTable');
    let html = `
        <thead>
            <tr>
                <th>ID</th>
                <th>Waktu</th>
                <th>Kasir</th>
                <th>Tipe</th>
                <th>Total</th>
                <th>Bayar</th>
                <th>Aksi</th>
            </tr>
        </thead>
        <tbody>
    `;

    transactions.forEach(t => {
        html += `
            <tr>
                <td>#${t.id}</td>
                <td>${new Date(t.date).toLocaleTimeString('id-ID')}</td>
                <td>${t.kasir.split('@')[0]}</td>
                <td>${t.orderType} (${t.paymentMethod})</td>
                <td>${formatRp(t.total)}</td>
                <td>${formatRp(t.bayar)}</td>
                <td>
                    <button class="trx-delete-btn" onclick="deleteTransaction(${t.id})" ${currentUser.role !== 'Manager' ? 'disabled' : ''}>Hapus</button>
                </td>
            </tr>
        `;
    });

    html += '</tbody>';
    table.innerHTML = html;
}

function deleteTransaction(id) {
    if (currentUser.role !== 'Manager') {
        alert("Akses ditolak. Hanya Manajer yang bisa menghapus transaksi.");
        return;
    }
    
    if (confirm(`Yakin ingin menghapus transaksi #${id}? Tindakan ini tidak dapat dibatalkan.`)) {
        const initialLength = store.transactions.length;
        store.transactions = store.transactions.filter(t => t.id !== id);
        
        if (store.transactions.length < initialLength) {
            saveStore();
            renderReport();
            alert(`Transaksi #${id} berhasil dihapus.`);
        } else {
            alert(`Transaksi #${id} tidak ditemukan.`);
        }
    }
}

// printReport sekarang menggunakan variabel global
function printReport(isClosing=false) {
    const w = window.open('', 'Laporan', 'width=400,height=800');
    if (!w) {
        alert("Browser memblokir pop-up. Izinkan pop-up untuk mencetak laporan.");
        return;
    }

    const startDate = currentReportStartDate;
    const endDate = currentReportEndDate;
    
    const filteredTrx = store.transactions.filter(t => {
        const tDate = new Date(t.date);
        return tDate >= startDate && tDate <= endDate;
    });

    let totalSubtotal = 0;
    let totalDiscount = 0;
    let totalSales = 0;
    let salesByPayment = {};
    let salesByOrderType = {};
    
    filteredTrx.forEach(t => {
        totalSubtotal += t.subtotal;
        totalDiscount += t.discount;
        totalSales += t.total;
        
        salesByPayment[t.paymentMethod] = (salesByPayment[t.paymentMethod] || 0) + t.total;
        salesByOrderType[t.orderType] = (salesByOrderType[t.orderType] || 0) + t.total;
    });

    // Format data untuk laporan
    const startDateStr = startDate.toLocaleDateString('id-ID');
    const endDateStr = endDate.toLocaleDateString('id-ID');
    
    const reportPeriod = isClosing ? 
        `Closing: ${new Date().toLocaleString('id-ID')}` :
        `Periode: ${startDateStr} s/d ${endDateStr}`;

    let paymentDetail = Object.entries(salesByPayment).map(([key, val]) => 
        padLine(` - ${key}`, formatRp(val))
    ).join('\n');

    let orderTypeDetail = Object.entries(salesByOrderType).map(([key, val]) => 
        padLine(` - ${key}`, formatRp(val))
    ).join('\n');


    const kasirLine = padLine("Manajer/Kasir: ", currentUser ? currentUser.email : "-");
    const dateLine = padLine("Tanggal Cetak: ", new Date().toLocaleString("id-ID"));
    const totalTrxLine = padLine("Total Transaksi: ", `${filteredTrx.length} Nota`);

    w.document.write(`
        <pre style='font-family:monospace; font-size: 14px; line-height: 1.2; width: 80mm; max-width: 80mm; padding: 10px;'>
        
        === LAPORAN PENJUALAN ===
        
        Outlet: JIF PIZZA CONDET
        ${reportPeriod}
${kasirLine}
${dateLine}
${totalTrxLine}
        
        ${'________________________________________'.substring(0, MAX_WIDTH)}
        RINGKASAN PENJUALAN
${padLine("Subtotal Kotor: ", formatRp(totalSubtotal))}
${padLine("Diskon Total: ", formatRp(totalDiscount))}
${padLine("TOTAL PENJUALAN AKHIR: ", formatRp(totalSales))}

        ${'________________________________________'.substring(0, MAX_WIDTH)}
        SALES BY PAYMENT
${paymentDetail}

        ${'________________________________________'.substring(0, MAX_WIDTH)}
        SALES BY ORDER TYPE
${orderTypeDetail}

        ${'________________________________________'.substring(0, MAX_WIDTH)}
        ========================================
        LAPORAN SELESAI
        </pre>
    `);
    w.print();
    w.close();
}

/* =========================================
   BAGIAN 11: JAVASCRIPT: MANAJEMEN MENU & DISKON
   ========================================= */

function addMenu() {
    if (currentUser.role !== 'Manager') {
        alert("Akses ditolak. Hanya Manajer yang bisa menambah menu.");
        return;
    }
    const name = $('menuName').value.trim();
    const category = $('menuCategory').value;
    const priceOffline = parseFloat($('menuPriceOffline').value);
    const markupOnline = parseFloat($('menuMarkupOnline').value);

    if (!name || isNaN(priceOffline) || priceOffline <= 0 || isNaN(markupOnline)) {
        alert('Pastikan Nama Menu dan Harga Offline diisi dengan benar.');
        return;
    }
    
    store.menus.push({
        name: name,
        category: category,
        priceOffline: priceOffline,
        markupOnline: markupOnline
    });
    
    saveStore();
    renderMenuEditor();
    renderMenus(); // Update menu di tab Kasir
    
    // Reset form
    $('menuName').value = '';
    $('menuPriceOffline').value = '';
}

function renderMenuEditor() {
    const list = $('menuListEditor');
    list.innerHTML = '';
    
    store.menus.forEach((menu, index) => {
        const li = document.createElement('li');
        li.innerHTML = `
            <span>${menu.name} (${menu.category}) - ${formatRp(menu.priceOffline)} + ${menu.markupOnline}%</span>
            <button class="del-btn" onclick="delMenu(${index})">Hapus</button>
        `;
        list.appendChild(li);
    });
}

// EDIT 1 DITERAPKAN: Menambahkan konfirmasi hapus menu
function delMenu(i) {
    if (currentUser.role !== 'Manager') {
        alert("Akses ditolak. Hanya Manajer yang bisa menghapus menu.");
        return;
    }
    if (confirm(`Yakin ingin menghapus menu ${store.menus[i].name} (${store.menus[i].category})?`)) { 
        store.menus.splice(i, 1);
        saveStore();
        renderMenus();
        renderMenuEditor();
    } 
}

function addDiscount() {
    if (currentUser.role !== 'Manager') {
        alert("Akses ditolak. Hanya Manajer yang bisa menambah diskon.");
        return;
    }
    const name = $('discountName').value.trim();
    const type = $('discountType').value;
    const value = parseFloat($('discountValue').value);

    if (!name || isNaN(value) || value <= 0) {
        alert('Pastikan Nama Diskon dan Nilai diisi dengan benar.');
        return;
    }

    const newId = store.discounts.length > 0 ? Math.max(...store.discounts.map(d => d.id)) + 1 : 1;
    
    store.discounts.push({
        id: newId,
        name: name,
        type: type,
        value: value
    });
    
    saveStore();
    renderDiscountEditor();
    renderDiscountsSelector(); // Update selector di tab Kasir

    // Reset form
    $('discountName').value = '';
    $('discountValue').value = '';
}

function renderDiscountEditor() {
    const list = $('discountList');
    list.innerHTML = '';
    
    store.discounts.forEach((discount, index) => {
        const displayValue = discount.type === 'percentage' ? `${discount.value}%` : formatRp(discount.value);
        const li = document.createElement('li');
        li.innerHTML = `
            <span>${discount.name} (${displayValue})</span>
            <button class="del-btn" onclick="delDiscount(${discount.id})">Hapus</button>
        `;
        list.appendChild(li);
    });
}

function delDiscount(id) {
    if (currentUser.role !== 'Manager') {
        alert("Akses ditolak. Hanya Manajer yang bisa menghapus diskon.");
        return;
    }
    if (confirm(`Yakin ingin menghapus diskon ini?`)) {
        store.discounts = store.discounts.filter(d => d.id !== id);
        saveStore();
        renderDiscountEditor();
        renderDiscountsSelector();
    }
}

/* =========================================
   BAGIAN 12: JAVASCRIPT: INITIALIZATION
   ========================================= */

window.onload = () => {
    loadStore();
    showTab('login'); 
};
</script>
</body>
</html>